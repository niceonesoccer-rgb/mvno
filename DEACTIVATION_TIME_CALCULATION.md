# 3일 미접속 판매종료 시점 계산

## 시나리오

**1월 1일 6시 37분 접속 → 7시 로그아웃**

## 동작 원리

### 1. last_login 업데이트 시점

코드: `includes/data/auth-functions.php::loginUser()` (367-371줄)
```php
UPDATE users
SET last_login = NOW()
WHERE user_id = :user_id
```

- **로그인 시점에만** `last_login`이 업데이트됨 (로그아웃 시에는 업데이트 안 함)
- 따라서: `last_login = 2025-01-01 06:37:00`

### 2. 판매종료 조건

코드: `includes/data/product-functions.php::autoDeactivateInactiveSellerProducts()` 
```sql
WHERE u.last_login <= DATE_SUB(NOW(), INTERVAL 3 DAY)
```

- 조건: `last_login`이 현재 시간에서 3일을 뺀 시간보다 **이전이거나 같으면** 판매종료 처리

### 3. 판매종료 처리 시점

- 자동 처리 스크립트: `api/auto-deactivate-inactive-seller-products.php`
- 일반적으로 cron job으로 **매일 자정(00:00)**에 실행됨

## 시간 계산

### 상황: 1월 1일 06:37 로그인, 07:00 로그아웃

1. **last_login = 2025-01-01 06:37:00**

2. **3일 후 기준 시점:**
   - last_login + 3일 = 2025-01-04 06:37:00
   - 즉, 1월 4일 06:37:00 이후부터 판매종료 조건에 해당

3. **cron job 실행 시점:**
   - 일반적으로 매일 자정(00:00)에 실행
   - 1월 4일 00:00에 실행될 때:
     - NOW() = 2025-01-04 00:00:00
     - DATE_SUB(NOW(), INTERVAL 3 DAY) = 2025-01-01 00:00:00
     - last_login(2025-01-01 06:37:00) <= 2025-01-01 00:00:00?
     - **아니오!** (06:37 > 00:00)
     - 따라서 **판매종료 처리 안 됨**

4. **다음 cron job 실행 (1월 5일 00:00):**
   - NOW() = 2025-01-05 00:00:00
   - DATE_SUB(NOW(), INTERVAL 3 DAY) = 2025-01-02 00:00:00
   - last_login(2025-01-01 06:37:00) <= 2025-01-02 00:00:00?
   - **예!** (1월 1일 < 1월 2일)
   - 따라서 **판매종료 처리됨**

## 결론

**판매종료 처리 시점: 1월 5일 00:00 (자정)**

- 실제로는 1월 4일 06:37:00부터 조건에 해당하지만
- cron job이 매일 자정에 실행되므로
- **1월 5일 자정(00:00)에 판매종료 처리됨**

---

## 정확한 계산식

만약 cron job이 **매일 06:00**에 실행된다면:
- 1월 4일 06:00 실행 시:
  - DATE_SUB(NOW(), INTERVAL 3 DAY) = 2025-01-01 06:00:00
  - last_login(2025-01-01 06:37:00) <= 2025-01-01 06:00:00?
  - **아니오!** (06:37 > 06:00)
- 1월 4일 07:00 실행 시 (만약 있다면):
  - DATE_SUB(NOW(), INTERVAL 3 DAY) = 2025-01-01 07:00:00
  - last_login(2025-01-01 06:37:00) <= 2025-01-01 07:00:00?
  - **예!**
  - **판매종료 처리됨**

하지만 일반적으로 cron job은 자정에 실행되므로, **1월 5일 00:00에 판매종료 처리**됩니다.
