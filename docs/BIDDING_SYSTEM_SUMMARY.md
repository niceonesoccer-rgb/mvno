# 입찰 시스템 전체 요약

## 📌 시스템 개요

통신사폰(MNO), 알뜰폰(MVNO), 통신사유심(MNO-SIM) 세 가지 카테고리별 입찰 시스템으로, 각 게시판 상단 20개 영역을 스폰서 영역으로 운영합니다.

---

## 🔑 핵심 정책

### 1. 입찰 참여
- ✅ **입찰 수정 불가**: 한번 입찰한 금액은 수정할 수 없음
- ✅ **입찰 취소 가능**: 입찰 확정 전(bidding_end_at 전)까지 취소 가능
- ✅ **재입찰 가능**: 취소 후 동일 라운드에 다시 입찰 참여 가능
- ✅ **다중 입찰 가능**: 한 판매자가 동일 라운드에 여러 입찰 참여 가능

### 2. 입찰 처리
- ✅ **동점 처리**: 동일 금액 입찰 시 입찰 시간(bid_at) 빠른 순으로 처리
- ✅ **낙찰 개수 제한**: 상위 20개만 낙찰, 나머지는 미낙찰 처리
- ✅ **동일 판매자 제한**: 한 판매자의 여러 입찰이 모두 상위에 포함되더라도, 20개 슬롯 내에서만 낙찰되고 나머지는 취소 처리

### 3. 예치금
- ✅ **입찰 시 차감**: 입찰 참여 시 예치금 자동 차감
- ✅ **취소 시 환불**: 입찰 취소 시 예치금 자동 환불
- ✅ **미낙찰 환불**: 미낙찰 입찰의 예치금 자동 환불
- ✅ **제한 초과 취소 환불**: 관리자 수동 확인 후 환불 처리

---

## 📊 입찰 프로세스 흐름

### Phase 1: 입찰 참여 (입찰 기간 중)

```
1. 판매자 입찰 참여
   ↓
2. 예치금 차감
   ↓
3. 입찰 기록 저장 (status='pending')
```

**중요:**
- 한 판매자가 여러 입찰 가능
- 입찰 수정 불가 (취소 후 재입찰만 가능)
- 입찰 확정 전까지 취소 가능

---

### Phase 2: 입찰 종료 후 낙찰 처리

```
1. 입찰 종료 (bidding_end_at 도래)
   ↓
2. 관리자 "낙찰 처리" 실행
   ↓
3. 입찰 정렬 (금액 DESC, 시간 ASC)
   ↓
4. 상위 20개 낙찰 처리
   ↓
5. 동일 판매자 제한 처리
   - 20개 슬롯 내에서만 낙찰
   - 초과분은 cancelled_by_limit 처리
   ↓
6. 미낙찰자 예치금 자동 환불
```

**예시:**
```
판매자 A가 5개 입찰, 모두 상위 20개 안에 포함:
- 입찰 1: 100,000원 (전체 1위)
- 입찰 2: 95,000원 (전체 5위)
- 입찰 3: 90,000원 (전체 10위)
- 입찰 4: 85,000원 (전체 19위) ✅ 낙찰
- 입찰 5: 80,000원 (전체 20위) ✅ 낙찰

결과:
- 19위, 20위만 낙찰 (status='won')
- 1위, 5위, 10위는 취소 (status='cancelled_by_limit')
- 취소된 3개는 관리자 확인 후 환불 처리
```

---

### Phase 3: 게시물 배정 (게시 기간 시작 전)

```
1. 낙찰자 게시물 선택
   - 낙찰 개수만큼만 선택 가능
   - 자신이 등록한 게시물만 선택
   ↓
2. 게시물 배정
   - 입찰 금액 순으로 display_order 자동 배정
   - 1등 → display_order=1
   - 2등 → display_order=2
   - ...
   ↓
3. 게시물 목록 반영
   - 상단 1~20개: 입찰 게시물 (입찰 금액 순)
   - 21번째부터: 일반 게시물 (등록 순)
```

---

### Phase 4: 게시 기간 (displaying)

```
1. 게시물 노출
   - 고정 모드: 입찰 금액 순서대로 고정
   - 순환 모드: 일정 간격마다 순서 변경
   ↓
2. 게시 종료
   - display_end_at 도래 시 종료
   - status = 'finished'
```

---

## 💰 예치금 처리 흐름

### 입찰 참여 시
```
예치금 차감 → 거래 내역 기록 (transaction_type='bid')
```

### 입찰 취소 시
```
예치금 환불 → 거래 내역 기록 (transaction_type='refund')
```

### 미낙찰 시 (자동)
```
예치금 자동 환불 → 거래 내역 기록 (transaction_type='refund')
```

### 제한 초과 취소 시 (관리자 수동)
```
관리자 확인 → 예치금 환불 → 거래 내역 기록 (transaction_type='refund')
```

---

## 📋 주요 데이터 구조

### 1. 입찰 라운드 (bidding_rounds)
- 카테고리별 입찰 정보
- 입찰 기간, 게시 기간 설정
- 최대 입찰 개수, 최대 입찰 금액

### 2. 입찰 참여 (bidding_participations)
- 각 입찰별 정보
- 입찰 금액, 상태, 순위
- 예치금 사용/환불 내역

### 3. 게시물 배정 (bidding_product_assignments)
- 낙찰자 선택 게시물과 노출 순서
- display_order (1~20)

### 4. 예치금 (seller_deposits)
- 판매자별 예치금 잔액
- 환불 계좌 정보

### 5. 예치금 거래 내역 (seller_deposit_transactions)
- 모든 예치금 입출금 기록
- 거래 유형, 금액, 잔액

---

## ⚠️ 주의사항

### 1. 동일 판매자 낙찰 제한
- 한 판매자의 여러 입찰이 모두 상위에 포함되어도, 20개 슬롯 내에서만 낙찰
- 초과분은 cancelled_by_limit 처리
- 관리자 수동 확인 후 환불 처리 필요

### 2. 입찰 수정 불가
- 입찰 수정 기능 없음
- 취소 후 재입찰만 가능

### 3. 입찰 취소 가능 기간
- 입찰 확정 전(bidding_end_at 전)까지만 취소 가능
- 입찰 종료 후에는 취소 불가

### 4. 게시물 선택 기한
- 게시 기간 시작 전까지 선택해야 함
- 미선택 시 처리 방안 필요 (자동 배정 또는 다음 순위 대체)

---

## 🔒 보안 고려사항

1. **예치금 보안**: 트랜잭션 처리, 행 잠금 사용
2. **입찰 보안**: 서버 시간 기준 검증, 중복 입찰 방지
3. **권한 검증**: seller 역할, 카테고리 권한 확인
4. **계좌 정보**: 암호화 저장 권장

---

## 📈 향후 확장 가능성

1. **순환 모드**: 일정 간격마다 순서 변경
2. **알림 시스템**: 입찰 종료, 낙찰 결과 알림
3. **자동 낙찰 처리**: 입찰 종료 시 자동 처리 옵션
4. **통계 및 리포트**: 입찰 통계, 판매자별 통계

---

## 📝 관련 문서

상세 설계는 [BIDDING_SYSTEM_DESIGN.md](./BIDDING_SYSTEM_DESIGN.md) 참조

