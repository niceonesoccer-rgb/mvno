# 입찰 시스템 상세 설명

## 📌 시스템 개요

입찰 시스템은 판매자당 카테고리별 1개 입찰만 등록할 수 있고, 모든 입찰을 비교하여 상위 20개만 낙찰하는 시스템입니다.

---

## 🔑 핵심 개념

### 1. 입찰 정책

**핵심 정책:**
- 판매자당 카테고리별 1개 입찰만 가능
- 동일 라운드에 중복 입찰 불가
- 각 판매자는 최대 1개만 낙찰 가능

---

### 2. 입찰 등록 프로세스

#### 관리자 설정 예시
```
입찰 라운드 생성:
- 카테고리: 알뜰폰 (mvno)
- 최대 노출 개수: 20개
- 최소 입찰 금액: 10,000원
- 최대 입찰 금액: 100,000원
- 입찰 기간: 2025-12-24 09:00 ~ 2025-12-30 16:00
```

#### 판매자 입찰 화면
```
┌─────────────────────────┐
│ 입찰 금액 입력          │
├─────────────────────────┤
│ 입찰 금액: [200000]     │
├─────────────────────────┤
│ 예치금 잔액: 1,000,000원│
│ 필요한 예치금: 200,000원│
├─────────────────────────┤
│ [입찰 등록]             │
└─────────────────────────┘
```

#### 입찰 등록 처리
```
1. 판매자가 1개 금액 입력 (200,000원)
2. 예치금 확인 (200,000원 이상 필요)
3. 예치금 차감 (200,000원)
4. bidding_participations 테이블에 1개 레코드 생성:
   - seller_id='A', bid_amount=200000, bid_at='2025-12-24 10:00:01'
```

**중요:**
- 모든 입찰은 동일한 bid_at 시간에 등록됨
- 각 입찰은 개별 레코드로 저장됨
- 입찰 수정 불가 (취소 후 재등록만 가능)

---

### 3. 낙찰 처리 프로세스

#### 전체 입찰 현황 예시

```
관리자 설정: max_display_count = 20

입찰 현황:
┌──────────┬─────────────┬──────────────┬──────────┐
│ 판매자   │ 입찰 개수   │ 입찰 금액    │ 등록 시간│
├──────────┼─────────────┼──────────────┼──────────┤
│ A        │ 1개         │ 200,000원   │ 10:00:01 │
│ B        │ 1개         │ 200,000원   │ 10:00:02 │
│ C        │ 1개         │ 200,000원   │ 10:00:03 │
│ D        │ 1개         │ 200,000원   │ 10:00:04 │
│ E        │ 1개         │ 200,000원   │ 10:00:05 │
│ ...      │ ...         │ ...          │ ...      │
│ U        │ 1개         │ 200,000원   │ 10:00:21 │
│ V        │ 1개         │ 200,000원   │ 10:00:22 │
└──────────┴─────────────┴──────────────┴──────────┘

총 입찰 개수: 25개
모든 입찰 금액: 200,000원 (동점)
```

#### 정렬 및 낙찰 처리

```
1. 모든 입찰을 정렬:
   - 입찰 금액: 동일 (200,000원)
   - 입찰 시간: 빠른 순 (ASC)

2. 상위 20개 낙찰:
   순위 | 판매자 | 입찰 금액 | 입찰 시간 | 상태
   ─────┼───────┼──────────┼──────────┼────
   1위  | A      | 200,000  | 10:00:01 | ✅ 낙찰
   2위  | B      | 200,000  | 10:00:02 | ✅ 낙찰
   3위  | C      | 200,000  | 10:00:03 | ✅ 낙찰
   ...
   20위 | T      | 200,000  | 10:00:20 | ✅ 낙찰
   21위 | U      | 200,000  | 10:00:21 | ❌ 미낙찰
   22위 | V      | 200,000  | 10:00:22 | ❌ 미낙찰
   ...  | ...    | ...      | ...      | ...
```

#### 결과

**낙찰자:**
- 판매자 A ~ T: 각 1개 낙찰 ✅ (총 20명)
- 판매자 U 이후: 미낙찰 ❌

**판매자 U의 상황:**
- 입찰: 1개 (200,000원)
- 낙찰: 0개 (21위로 미낙찰)
- 예치금: 200,000원 자동 환불

---

### 4. 동점 21개 케이스

#### 상황
```
동일 금액 입찰이 정확히 21개인 경우
→ 1~20위: 낙찰
→ 21위 (입찰 시간 가장 늦은 것): 취소/미낙찰
```

#### 예시
```
입찰 현황:
- 21개 입찰 모두 200,000원
- 입찰 시간: 10:00:01 ~ 10:00:21

처리:
- 1~20위: 낙찰 (status='won')
- 21위: 미낙찰 (status='lost', 예치금 자동 환불)
```

---

## 💰 예치금 처리

### 입찰 등록 시
```
판매자 A가 1개 입찰 (200,000원):
- 예치금 차감: 200,000원
- 거래 내역: transaction_type='bid', amount=-200,000원
```

### 미낙찰 환불 시
```
판매자 U의 미낙찰:
- 예치금 환불: 200,000원
- 거래 내역: transaction_type='refund', amount=+200,000원
```

---

## 📋 데이터베이스 구조

### bidding_participations 테이블 예시

```
낙찰자 (1~20위):
id  | bidding_round_id | seller_id | bid_amount | bid_at      | status | rank
────┼──────────────────┼───────────┼────────────┼─────────────┼────────┼─────
1   | 1                | A         | 200000     | 2025-12-24  | won    | 1
2   | 1                | B         | 200000     | 2025-12-24  | won    | 2
...
20  | 1                | T         | 200000     | 2025-12-24  | won    | 20

미낙찰자 (21위 이후):
id  | bidding_round_id | seller_id | bid_amount | bid_at      | status | rank
────┼──────────────────┼───────────┼────────────┼─────────────┼────────┼─────
21  | 1                | U         | 200000     | 2025-12-24  | lost   | NULL
22  | 1                | V         | 200000     | 2025-12-24  | lost   | NULL
...
```

---

## ⚠️ 주요 정책

### 1. 판매자당 1개 입찰
- 판매자당 카테고리별 1개 입찰만 가능
- 동일 라운드에 중복 입찰 불가 (UNIQUE KEY 제약)

### 2. 입찰 수정 불가
- 한 번 등록한 입찰은 수정 불가
- 취소 후 재등록만 가능

### 3. 입찰 취소
- 입찰 확정 전(bidding_end_at 전)까지 취소 가능
- 취소 시 예치금 즉시 환불
- 취소 후 재입찰 가능

### 4. 낙찰 기준
- 모든 입찰을 하나의 풀에서 비교
- 입찰 금액 내림차순
- 동일 금액 시 입찰 시간 빠른 순
- 상위 20개만 낙찰

### 5. 동점 처리
- 동일 금액이 21개 이상이면 시간순으로 마지막 입찰 미낙찰

---

## 🎯 구현 시 주의사항

1. **입찰 등록 시:**
   - 트랜잭션으로 처리
   - 중복 입찰 방지 (UNIQUE KEY)
   - 예치금 확인 및 차감

2. **낙찰 처리 시:**
   - 모든 입찰을 한 번에 정렬
   - 동점 처리는 bid_at 기준
   - 미낙찰 예치금 자동 환불

3. **UI 설계:**
   - 관리자: 입찰 라운드 생성 (카테고리, 기간, 최대 노출 개수 등)
   - 판매자: 1개 입찰 금액 입력 필드
   - 입찰 금액 유효성 검사

