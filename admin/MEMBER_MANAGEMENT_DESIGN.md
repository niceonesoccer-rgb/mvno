# 회원 관리 설계 문서

## 📋 현재 구조 분석

### 1. 데이터 저장 구조

#### 사용자 데이터 (`includes/data/users.json`)
```json
{
  "users": [
    {
      "user_id": "admin",
      "email": "admin@moyo.com",
      "name": "관리자",
      "password": "$2y$10$...",  // 직접 가입 시에만 존재
      "role": "admin",            // admin, sub_admin, seller, user
      "created_at": "2025-12-04 15:29:04",
      "seller_approved": true,    // 판매자 승인 여부
      "permissions": [],          // 판매자 권한: ['mvno', 'mno', 'internet']
      "sns_provider": "naver",    // SNS 가입 시: naver, kakao, google
      "sns_id": "..."            // SNS 고유 ID
    }
  ]
}
```

#### 포인트 데이터 (`includes/data/user-points.json`)
```json
{
  "user_id": {
    "balance": 125000,
    "history": [
      {
        "id": "mvno_32636_001",
        "date": "2024-10-20 16:20:00",
        "type": "mvno",           // add, mvno, mno, internet
        "amount": 3000,
        "item_id": 32636,
        "description": "알뜰폰 신청",
        "balance_after": 297000
      }
    ]
  }
}
```

### 2. 사용자 역할 (Role)

| 역할 | 설명 | 특징 |
|------|------|------|
| **admin** | 관리자 | 모든 권한, 직접 가입만 가능 |
| **sub_admin** | 서브관리자 | 관리자 권한 일부, 직접 가입만 가능 |
| **seller** | 판매자 | 승인 필요, 게시판 등록 권한 부여 가능 |
| **user** | 일반 회원 | SNS 가입 또는 직접 가입 |

### 3. 가입 방식

#### SNS 가입
- 네이버, 카카오, 구글
- `user_id` 형식: `nvr_3211205`, `kko_3211205`, `gol_3211205`
- 비밀번호 없음
- 역할: `user`만 가능

#### 직접 가입
- 아이디/비밀번호/이메일/이름
- 역할: `admin`, `sub_admin`, `seller`만 가능
- 판매자는 승인 필요

### 4. 현재 구현된 관리 페이지

#### ✅ `admin/seller-approval.php`
- 판매자 승인 관리
- 승인 대기 중인 판매자 목록
- 승인된 판매자 목록
- 승인 처리 기능

#### ✅ `admin/seller-permissions.php`
- 판매자 권한 관리
- 알뜰폰/통신사폰/인터넷 게시판 권한 부여
- 승인된 판매자만 표시

#### ❌ `admin/users/member-list.php` (미구현)
- 회원 목록 조회
- 회원 상세 정보
- 회원 관리 기능

---

## 🎯 회원 관리 페이지 설계

### 페이지 경로
`/MVNO/admin/users/member-list.php`

### 주요 기능

#### 1. 회원 목록 조회
- **필터링 옵션**
  - 역할별: 전체, 관리자, 서브관리자, 판매자, 일반회원
  - 가입 방식: 전체, SNS 가입, 직접 가입
  - 승인 상태: 전체, 승인됨, 승인 대기 (판매자만)
  - 검색: 아이디, 이름, 이메일

- **표시 정보**
  - 아이디
  - 이름
  - 이메일
  - 역할
  - 가입 방식 (SNS/직접)
  - 가입일
  - 최근 활동일 (선택)
  - 상태 (승인 여부)

#### 2. 회원 상세 정보
- **기본 정보**
  - 아이디, 이름, 이메일
  - 역할, 가입 방식
  - 가입일, 최근 로그인일

- **SNS 가입 회원**
  - SNS 제공자 (네이버/카카오/구글)
  - SNS ID

- **판매자 정보**
  - 승인 상태
  - 승인일
  - 권한 목록 (알뜰폰/통신사폰/인터넷)

- **포인트 정보**
  - 현재 잔액
  - 포인트 내역 링크

- **활동 통계** (선택)
  - 주문 건수
  - 리뷰 작성 수
  - Q&A 작성 수

#### 3. 회원 관리 기능

##### 역할 변경
- 일반회원 → 판매자 (승인 필요)
- 판매자 → 일반회원
- 관리자/서브관리자는 변경 불가

##### 판매자 승인/거부
- 승인 대기 중인 판매자 승인
- 승인된 판매자 승인 취소

##### 회원 상태 관리
- 활성/비활성 (선택)
- 탈퇴 처리 (선택)

##### 포인트 관리
- 포인트 조회
- 포인트 내역 링크

#### 4. UI/UX 설계

##### 목록 화면
```
┌─────────────────────────────────────────────────────────┐
│ 회원 관리                                                │
├─────────────────────────────────────────────────────────┤
│ [필터] 역할: [전체▼] 가입방식: [전체▼] [검색: ____]     │
├─────────────────────────────────────────────────────────┤
│ 아이디    │ 이름 │ 이메일 │ 역할 │ 가입방식 │ 가입일 │  │
├─────────────────────────────────────────────────────────┤
│ admin     │ 관리자│...│관리자│ 직접 │ 2025-12-04 │ [상세]│
│ nvr_12345 │ 홍길동│...│회원 │ 네이버│ 2025-12-01 │ [상세]│
└─────────────────────────────────────────────────────────┘
```

##### 상세 화면 (모달 또는 별도 페이지)
```
┌─────────────────────────────────────────┐
│ 회원 상세 정보                           │
├─────────────────────────────────────────┤
│ 기본 정보                                │
│ - 아이디: admin                          │
│ - 이름: 관리자                           │
│ - 이메일: admin@moyo.com                 │
│ - 역할: 관리자                           │
│ - 가입일: 2025-12-04 15:29:04            │
│                                          │
│ 포인트 정보                              │
│ - 현재 잔액: 125,000원                   │
│ - [포인트 내역 보기]                     │
│                                          │
│ [역할 변경] [상태 변경] [닫기]           │
└─────────────────────────────────────────┘
```

### 5. 구현 우선순위

#### Phase 1 (필수)
1. ✅ 회원 목록 조회
2. ✅ 필터링 (역할, 가입방식)
3. ✅ 검색 기능
4. ✅ 회원 상세 정보 보기

#### Phase 2 (중요)
5. ✅ 역할 변경
6. ✅ 판매자 승인/거부
7. ✅ 포인트 정보 표시

#### Phase 3 (선택)
8. ⚪ 회원 상태 관리 (활성/비활성)
9. ⚪ 탈퇴 처리
10. ⚪ 활동 통계
11. ⚪ 일괄 작업

### 6. 데이터 구조 확장 제안

#### 사용자 데이터에 추가할 필드 (선택)
```json
{
  "user_id": "admin",
  "status": "active",           // active, inactive, deleted
  "last_login": "2025-12-04 10:30:00",
  "point_balance": 125000,      // 포인트 잔액 (캐시)
  "stats": {
    "order_count": 10,
    "review_count": 5,
    "qna_count": 2
  }
}
```

### 7. 보안 고려사항

- 관리자만 접근 가능
- 역할 변경 시 권한 검증
- 판매자 승인 취소 시 권한도 함께 제거
- 민감 정보 마스킹 (이메일 일부만 표시)

---

## 📝 구현 체크리스트

- [ ] `admin/users/member-list.php` 파일 생성
- [ ] 회원 목록 조회 기능
- [ ] 필터링 기능 (역할, 가입방식)
- [ ] 검색 기능
- [ ] 회원 상세 정보 모달/페이지
- [ ] 역할 변경 기능
- [ ] 판매자 승인/거부 기능
- [ ] 포인트 정보 연동
- [ ] 반응형 디자인
- [ ] 관리자 헤더에 링크 추가 (이미 있음)

---

## 🔗 관련 파일

- `includes/data/auth-functions.php` - 사용자 인증 함수
- `includes/data/users.json` - 사용자 데이터
- `includes/data/user-points.json` - 포인트 데이터
- `admin/seller-approval.php` - 판매자 승인 페이지
- `admin/seller-permissions.php` - 판매자 권한 페이지
- `admin/includes/admin-header.php` - 관리자 헤더 (링크 포함)

---

## 💡 추가 고려사항 및 개선 제안

### 1. 현재 데이터 연결 상태

#### ⚠️ 주의사항
현재 시스템에서 **주문 내역과 사용자 연결이 약한 상태**입니다:
- `mypage/mvno-order.php`, `mypage/mno-order.php`는 하드코딩된 데이터 사용
- 실제 `user_id`와 주문 데이터 연결 구조가 명확하지 않음
- 리뷰, Q&A도 사용자 연결 구조 확인 필요

#### 개선 방향
회원 관리 페이지 구현 시:
1. **단계적 접근**: 먼저 기본 회원 정보 조회/관리 기능 구현
2. **활동 통계는 나중에**: 주문/리뷰/Q&A 연결 구조가 명확해진 후 추가
3. **포인트 정보는 우선**: `user-points.json` 구조가 명확하므로 먼저 연동 가능

### 2. 사용자 통계 수집 전략

#### 옵션 A: 실시간 계산 (초기 구현)
```php
// 회원 상세 정보 조회 시마다 계산
function getUserStats($userId) {
    // 주문 데이터에서 user_id로 필터링하여 카운트
    // 리뷰 데이터에서 user_id로 필터링하여 카운트
    // Q&A 데이터에서 user_id로 필터링하여 카운트
    return [
        'order_count' => countUserOrders($userId),
        'review_count' => countUserReviews($userId),
        'qna_count' => countUserQnas($userId)
    ];
}
```
- **장점**: 데이터 정합성 보장, 구현 간단
- **단점**: 성능 이슈 (데이터가 많아질수록 느려짐)

#### 옵션 B: 캐시 저장 (향후 개선)
```json
{
  "user_id": "nvr_12345",
  "stats": {
    "order_count": 10,
    "review_count": 5,
    "qna_count": 2,
    "last_updated": "2025-12-04 10:30:00"
  }
}
```
- **장점**: 빠른 조회 속도
- **단점**: 데이터 동기화 필요, 구현 복잡

### 3. 회원 관리 페이지 구현 시나리오

#### 시나리오 1: 기본 회원 조회 (Phase 1)
```
1. 회원 목록 표시
   - users.json에서 모든 사용자 읽기
   - 역할, 가입방식별 필터링
   - 검색 기능 (아이디, 이름, 이메일)

2. 회원 상세 정보
   - 기본 정보 표시
   - SNS 정보 (SNS 가입 시)
   - 판매자 정보 (판매자일 경우)
   - 포인트 정보 (user-points.json에서 조회)
```

#### 시나리오 2: 역할 관리 (Phase 2)
```
1. 역할 변경
   - 일반회원 → 판매자 (seller_approved: false로 설정)
   - 판매자 → 일반회원 (권한도 함께 제거)
   - 관리자/서브관리자는 변경 불가

2. 판매자 승인
   - seller-approval.php와 동일한 로직 재사용
   - 또는 seller-approval.php로 리다이렉트
```

#### 시나리오 3: 고급 기능 (Phase 3)
```
1. 활동 통계
   - 주문 건수 (주문 데이터 구조 확인 후)
   - 리뷰 작성 수 (리뷰 데이터 구조 확인 후)
   - Q&A 작성 수 (qna.json 구조 확인 후)

2. 회원 상태 관리
   - 활성/비활성 토글
   - 탈퇴 처리 (soft delete)
```

### 4. 데이터 일관성 고려사항

#### 현재 구조의 특징
- **JSON 파일 기반**: 데이터베이스 없이 JSON 파일로 관리
- **단순한 구조**: 빠른 개발 가능하나 확장성 제한
- **동시성 이슈**: 여러 관리자가 동시에 수정 시 충돌 가능

#### 구현 시 주의사항
1. **파일 잠금**: `flock()` 사용하여 동시 수정 방지
2. **데이터 백업**: 수정 전 원본 백업
3. **에러 처리**: JSON 파싱 실패, 파일 쓰기 실패 등 처리

### 5. UI/UX 개선 아이디어

#### 목록 화면
- **페이지네이션**: 회원이 많아질 경우를 대비
- **정렬 기능**: 가입일, 이름, 아이디 등으로 정렬
- **일괄 선택**: 여러 회원 선택하여 일괄 작업
- **내보내기**: CSV/Excel 내보내기 기능

#### 상세 화면
- **탭 구조**: 기본정보 / 포인트 / 활동내역 / 설정
- **히스토리**: 역할 변경, 승인 상태 변경 이력
- **빠른 액션**: 판매자 승인 페이지, 권한 설정 페이지로 바로 이동

### 6. 보안 강화 방안

#### 현재
- 관리자 인증 체크 (주석 처리됨)
- 역할 기반 접근 제어

#### 개선 제안
1. **CSRF 토큰**: POST 요청 시 CSRF 토큰 검증
2. **감사 로그**: 회원 정보 변경 이력 기록
3. **권한 세분화**: 서브관리자는 회원 조회만, 수정은 관리자만
4. **민감 정보 마스킹**: 이메일 일부만 표시 (예: ad***@moyo.com)

### 7. 성능 최적화

#### 초기 구현 (간단)
- 전체 회원 목록을 한 번에 로드
- 필터링/검색은 PHP에서 처리

#### 향후 개선
- **가상 스크롤**: 많은 데이터도 부드럽게 표시
- **서버 사이드 필터링**: 필요한 데이터만 로드
- **캐싱**: 자주 조회되는 통계 데이터 캐싱

### 8. 확장 가능성

#### 향후 추가 가능한 기능
1. **회원 등급 시스템**: 일반/실버/골드 등급
2. **활동 점수**: 주문, 리뷰 작성 등으로 점수 부여
3. **알림 설정**: 회원별 알림 수신 설정
4. **메시지 발송**: 회원에게 일괄 메시지 발송
5. **회원 분석**: 가입 경로, 활동 패턴 분석

---

## 🎨 디자인 가이드

### 색상 체계
- **관리자**: 보라색 계열 (#6366f1)
- **서브관리자**: 파란색 계열 (#3b82f6)
- **판매자**: 노란색 계열 (#fbbf24)
- **일반회원**: 회색 계열 (#64748b)

### 아이콘
- 관리자: 👑 또는 🛡️
- 서브관리자: ⚙️
- 판매자: 💼
- 일반회원: 👤
- SNS 가입: 🔗 (네이버/카카오/구글 아이콘)

### 상태 배지
- 승인됨: 초록색 (#10b981)
- 승인 대기: 노란색 (#f59e0b)
- 비활성: 회색 (#6b7280)
- 탈퇴: 빨간색 (#ef4444)

