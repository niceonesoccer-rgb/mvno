# 리뷰 통계 계산 문제점 분석

## 현재 구조

### 통계 테이블 구조
- `product_review_statistics` 테이블은 **상품별(product_id)**로 통계를 저장합니다.
- 각 상품마다 별도의 통계 레코드가 있습니다.

### 실제 계산 방식
- 알뜰폰(MVNO)과 통신사단독유심(MNO-SIM)은 **같은 판매자의 모든 상품 리뷰를 통합**해서 계산합니다.
- 예: 판매자 A가 상품 1, 2, 3을 가지고 있으면, 상품 1의 리뷰 페이지에 상품 1, 2, 3의 모든 리뷰를 합산해서 표시합니다.

## 문제점

### 1. 통계 테이블 불일치 문제

**시나리오:**
- 판매자 A가 상품 1, 2, 3을 가지고 있음
- 상품 1: 리뷰 2000개
- 상품 2: 리뷰 2000개  
- 상품 3: 리뷰 1000개
- 총 5000개 리뷰

**문제 발생:**
1. 상품 1의 리뷰 페이지를 열면 → 상품 1, 2, 3의 통계를 합산해서 표시
2. 상품 2의 리뷰 하나를 삭제하면 → 상품 2의 통계만 업데이트됨
3. 상품 1의 리뷰 페이지를 다시 열면 → 상품 1의 통계는 업데이트되지 않았으므로 **잘못된 값 표시**

### 2. 성능 문제

**현재 구현:**
- 통계 테이블을 먼저 조회 (빠름)
- 통계 테이블에 데이터가 없으면 실제 리뷰 데이터에서 계산 (느림)

**5000개 리뷰 시나리오:**
- 통계 테이블 사용: 매우 빠름 (SUM 쿼리)
- 실제 리뷰 데이터 계산: 느림 (5000개 리뷰를 모두 조회하고 AVG 계산)

### 3. 동시성 문제

**시나리오:**
- 사용자 A가 상품 1의 리뷰를 삭제
- 동시에 사용자 B가 상품 2의 리뷰를 수정
- 두 작업이 동시에 발생하면 통계 테이블이 불일치할 수 있음

## 해결 방안

### 방안 1: 통계 테이블 사용 + 폴백 (현재 구현)
- 통계 테이블을 먼저 조회
- 통계 테이블에 데이터가 없거나 불일치하면 실제 리뷰 데이터에서 계산
- **장점**: 빠른 성능 (통계 테이블 사용 시)
- **단점**: 통계 테이블 불일치 시 실제 리뷰 데이터 계산으로 인한 성능 저하

### 방안 2: 항상 실제 리뷰 데이터에서 계산
- 통계 테이블을 사용하지 않고 항상 실제 리뷰 데이터에서 계산
- **장점**: 항상 정확한 값
- **단점**: 5000개 리뷰 시 성능 문제 (매번 전체 리뷰 조회)

### 방안 3: 판매자별 통계 테이블 추가
- `seller_review_statistics` 테이블 추가
- 판매자별로 통계를 저장
- 리뷰 수정/삭제 시 판매자 통계만 업데이트
- **장점**: 빠른 성능 + 정확한 값
- **단점**: 추가 테이블 관리 필요

### 방안 4: 캐싱 + 주기적 동기화
- 통계를 캐시에 저장
- 주기적으로 실제 리뷰 데이터와 동기화
- **장점**: 빠른 성능
- **단점**: 캐시 관리 복잡도 증가

## 권장 사항

현재 구현(방안 1)이 가장 균형잡힌 방식입니다:
1. 통계 테이블을 사용하여 빠른 성능 제공
2. 통계 테이블 불일치 시 실제 리뷰 데이터에서 계산하여 정확성 보장
3. 트리거가 자동으로 통계를 업데이트하여 대부분의 경우 정확함

### 추가 개선 사항
- 통계 테이블 불일치 감지 시 자동으로 통계 재계산
- 통계 테이블 검증 스크립트 추가

