# 로테이션 광고 시스템 요구사항 정리 및 현황

## 📋 확정된 요구사항 요약

### ✅ 1. 수익 모델
- **시간 단위 고정 요금제** 채택
- **기간별 금액 직접 설정**: 관리자가 1일, 2일, 3일, 5일, 7일, 10일 등 **일자별로 금액 설정**
- **카테고리별 설정**: 각 카테고리(통신사단독유심, 알뜰폰, 통신사폰, 인터넷)마다 별도 금액 설정 가능

### ✅ 2. 광고 신청 프로세스
- **검수 없이 바로 시작**: 판매자가 광고 신청 시 관리자 검수 없이 즉시 광고 시작
- **예치금 차감**: 광고 신청 시 예치금에서 자동 차감
- **예치금 부족 시**: 광고 신청 불가 (에러 메시지 표시)

### ✅ 3. 예치금 시스템
- **무통장 입금만 가능**: 신용카드 등 다른 결제 수단 없음
- **입금 신청 프로세스**:
  1. 판매자가 입금자명, 입금금액 입력
  2. 무통장 입금 계좌 선택 (관리자가 등록한 계좌 중 선택)
  3. 입금 신청 저장 (대기 상태)
  4. 판매자가 실제 무통장 입금
  5. 관리자가 입금 확인 후 예치금 충전

### ✅ 4. 무통장 계좌 관리
- **관리자 페이지에서 관리**: 은행명, 계좌번호, 예금주 정보 등록/수정/삭제 가능
- **판매자가 선택 가능**: 광고 신청 시 등록된 계좌 목록에서 선택

### ✅ 5. 광고 상태 관리
- **상품 상태와 무관**: 상품이 판매종료되어도 광고는 계속 진행됨
- **광고 시간 계산**: 광고 신청 시작 시간부터 정확히 초 단위로 계산
  - 예: 2025-12-21 15:16:15에 1일 광고 신청
  - 종료 시간: 2025-12-22 15:16:15 (정확히 86400초 후)
- **광고 기간 종료**: 설정된 광고 종료 시간(`end_datetime`) 도달 시 광고 자동 종료 (`expired`)

---

## 📝 작성 완료된 문서

1. ✅ **ROTATION_ADVERTISEMENT_REVENUE_MODEL.md**
   - 수익 모델 제안서
   - 여러 모델 비교 및 추천

2. ✅ **ROTATION_ADVERTISEMENT_SYSTEM_DESIGN.md**
   - 상세 시스템 설계서
   - 데이터베이스 구조
   - 시스템 플로우
   - 문제점 및 보강 사항

3. ✅ **rotation_advertisement_schema.sql**
   - 데이터베이스 스키마 SQL 파일
   - 6개 테이블 구조 정의

---

## ⚠️ 현재 상태 분석

### ✅ 이미 구현된 것들

1. **포인트 시스템**
   - `user_point_accounts` 테이블 (사용자 포인트 계좌)
   - `user_point_ledger` 테이블 (포인트 내역)
   - 포인트 충전/차감 함수 (`addPoint`, `deductPoint`)
   - 포인트 조회 API (`/api/point-balance.php`)

2. **상품 관리 시스템**
   - `products` 테이블 (상품 기본 정보)
   - `product_mvno_details` 테이블
   - `product_mno_details` 테이블
   - `product_internet_details` 테이블
   - 상품 상태 관리 (`active`, `inactive`, `deleted`)

3. **판매자 시스템**
   - 판매자 회원 가입/로그인
   - 판매자 권한 관리
   - 판매자 상품 등록/관리

---

### ❌ 구현이 필요한 것들

#### 1. 예치금 시스템 (NEW) ⚠️

**필요한 테이블:**
- [ ] `seller_deposit_accounts` (판매자 예치금 계좌)
- [ ] `seller_deposit_ledger` (예치금 내역)

**필요한 기능:**
- [ ] 예치금 잔액 조회 함수
- [ ] 예치금 충전 함수 (관리자 입금 확인 시)
- [ ] 예치금 차감 함수 (광고 신청 시)
- [ ] 예치금 잔액 조회 API

**비고:** 포인트 시스템과 유사하지만, 판매자 전용이고 무통장 입금만 가능

---

#### 2. 무통장 계좌 관리 시스템 (NEW) ⚠️

**필요한 테이블:**
- [ ] `bank_accounts` (무통장 입금 계좌)

**필요한 기능:**
- [ ] 관리자 페이지: 계좌 등록/수정/삭제
- [ ] 관리자 페이지: 계좌 목록 조회
- [ ] 판매자 페이지: 계좌 목록 표시 (입금 신청 시)

**비고:** 완전히 새로운 기능

---

#### 3. 예치금 충전 신청 시스템 (NEW) ⚠️

**필요한 테이블:**
- [ ] `deposit_requests` (예치금 충전 신청)

**필요한 기능:**
- [ ] 판매자 페이지: 입금 신청 폼 (입금자명, 금액, 계좌 선택)
- [ ] 판매자 페이지: 입금 신청 목록 조회
- [ ] 관리자 페이지: 입금 신청 목록 조회
- [ ] 관리자 페이지: 입금 확인/거부 기능
- [ ] 입금 확인 시 예치금 자동 충전 로직

**비고:** 완전히 새로운 기능

---

#### 4. 광고 가격 설정 시스템 (NEW) ⚠️

**필요한 테이블:**
- [ ] `rotation_advertisement_prices` (광고 가격 설정)

**필요한 기능:**
- [ ] 관리자 페이지: 카테고리별 가격 설정
- [ ] 관리자 페이지: 시간 단위별 가격 설정
- [ ] 관리자 페이지: 기간별(1일, 2일, 3일, 5일, 7일, 10일 등) 가격 설정
- [ ] 가격 조회 API (판매자가 광고 신청 시)

**비고:** 완전히 새로운 기능

---

#### 5. 로테이션 광고 시스템 (NEW) ⚠️

**필요한 테이블:**
- [ ] `rotation_advertisements` (로테이션 광고)

**필요한 기능:**
- [ ] 판매자 페이지: 광고 신청 폼 (상품 선택, 시간 단위, 기간 선택)
- [ ] 판매자 페이지: 광고 목록 조회
- [ ] 광고 신청 API (예치금 차감 포함, 시간 초 단위 계산)
- [ ] 광고 목록 조회 API (프론트엔드용)
- [ ] 광고 만료 크론잡 (end_datetime 체크, 1시간마다 또는 더 자주 실행)

**비고:** 핵심 기능

---

#### 6. 프론트엔드 광고 섹션 (NEW) ⚠️

**필요한 기능:**
- [ ] 각 카테고리 페이지 상단에 광고 섹션 추가
  - `/mvno/mvno.php` (알뜰폰)
  - `/mno/mno.php` (통신사폰)
  - `/internets/internets.php` (인터넷)
  - `/mno-sim/mno-sim.php` (통신사단독유심)
- [ ] JavaScript로 광고 로테이션 구현 (시간 단위별)
- [ ] 광고 카드 컴포넌트 (기존 상품 카드와 유사하되 "광고" 뱃지)

**비고:** 프론트엔드 작업 필요

---

## 🔍 문제점 및 보강 사항

### 1. 예치금 vs 포인트 시스템 분리 필요 ⚠️

**문제점:**
- 현재 포인트 시스템은 일반 사용자용
- 예치금 시스템은 판매자 전용
- 두 시스템을 분리해야 함

**해결 방안:**
- 포인트 시스템과 별도로 예치금 시스템 구현
- `seller_deposit_accounts` 테이블 생성 (판매자 전용)
- 포인트 시스템의 `addPoint`, `deductPoint` 함수를 참고하여 예치금 함수 구현

---

### 2. 광고 시간 초 단위 계산 로직 필요 ⚠️

**문제점:**
- 광고 시작/종료 시간을 초 단위로 정확히 계산하는 로직 없음
- 광고 신청 시점의 정확한 시간부터 시작해야 함

**해결 방안:**
- 광고 신청 시 현재 시간을 `start_datetime`에 저장 (초 단위)
- 종료 시간 계산: `end_datetime = start_datetime + (advertisement_days × 86400초)`
- 예: 2025-12-21 15:16:15 신청, 1일 광고 → 종료: 2025-12-22 15:16:15

---

### 3. 광고 만료 자동 처리 크론잡 필요 ⚠️

**문제점:**
- 광고 기간이 만료되면 자동으로 종료 처리해야 함
- 현재는 자동 처리 스크립트가 없음

**해결 방안:**
- `cron/expire-advertisements.php` 스크립트 생성
- Windows 작업 스케줄러 또는 Linux cron 설정
- 1시간마다 또는 더 자주 실행하여 `end_datetime < NOW()`인 광고를 `expired`로 변경
- 정확한 시간 계산을 위해 자주 실행 권장

---

### 4. 광고 신청 시 중복 방지 필요 ⚠️

**문제점:**
- 같은 상품에 대해 여러 광고를 동시에 신청할 수 있는지 불명확

**해결 방안:**
- 같은 상품에 대해 활성화된 광고(`active`)가 있으면 신청 불가
- 또는 동시에 여러 광고 신청 허용 (비권장)
- 권장: 중복 방지 (같은 상품에 대해 동시에 하나의 광고만)

---

### 5. 광고 환불 정책 미정 ⚠️

**문제점:**
- 광고 기간 중 취소 시 환불 정책이 없음

**해결 방안:**
- 초기에는 환불 불가 정책 (단순함)
- 향후 부분 환불 정책 추가 가능

---

### 6. 광고 로테이션 순서 결정 로직 필요 ⚠️

**문제점:**
- 같은 시간 단위에 여러 광고가 있을 경우 순서 결정 방법 불명확

**해결 방안:**
- 광고 신청일 순서 (먼저 신청한 순)
- 또는 `display_order` 컬럼 활용 (관리자가 수동 설정)
- 권장: 광고 신청일 순서 (단순함)

---

## 📊 구현 우선순위

### Phase 1: 핵심 인프라 (최우선) 🔴

1. **데이터베이스 스키마 생성**
   - `rotation_advertisement_schema.sql` 실행
   - 6개 테이블 생성 확인

2. **예치금 시스템 구현**
   - 예치금 계좌 테이블 확인
   - 예치금 충전/차감 함수 구현
   - 예치금 잔액 조회 API

3. **무통장 계좌 관리 (관리자)**
   - 관리자 페이지: 계좌 등록/수정/삭제
   - 계좌 목록 조회 API

4. **예치금 충전 신청 시스템**
   - 판매자 페이지: 입금 신청 폼
   - 관리자 페이지: 입금 확인/거부

### Phase 2: 광고 시스템 구현 🟡

5. **광고 가격 설정 (관리자)**
   - 관리자 페이지: 카테고리별, 시간 단위별, 기간별 가격 설정
   - 가격 조회 API

6. **광고 신청 시스템 (판매자)**
   - 판매자 페이지: 광고 신청 폼
   - 광고 신청 API (예치금 차감 포함)
   - 광고 목록 조회

7. **광고 상태 관리**
   - 광고 시간 계산 로직 (초 단위: start_datetime, end_datetime)
   - 광고 만료 크론잡 (end_datetime < NOW() 체크, 1시간마다 또는 더 자주)

### Phase 3: 프론트엔드 구현 🟢

8. **광고 섹션 및 로테이션**
   - 각 카테고리 페이지에 광고 섹션 추가
   - JavaScript 로테이션 구현
   - 광고 카드 컴포넌트

---

## 💡 참고사항

### 기존 포인트 시스템 재사용 가능한 부분

1. **함수 구조 참고**
   - `getUserPoint()` 함수 → `getSellerDeposit()` 함수
   - `addPoint()` 함수 → `addDeposit()` 함수
   - `deductPoint()` 함수 → `deductDeposit()` 함수

2. **API 구조 참고**
   - `/api/point-balance.php` → `/api/deposit-balance.php`
   - `/api/point-deduct.php` → 광고 신청 API에서 차감

3. **페이지 구조 참고**
   - `/mypage/point-history.php` → `/seller/deposit/history.php`

---

## 📝 체크리스트

### 데이터베이스
- [ ] `rotation_advertisement_schema.sql` 실행 완료
- [ ] 6개 테이블 생성 확인

### 예치금 시스템
- [ ] 예치금 조회 함수 구현
- [ ] 예치금 충전 함수 구현
- [ ] 예치금 차감 함수 구현
- [ ] 예치금 조회 API 구현

### 무통장 계좌 관리
- [ ] 관리자 페이지: 계좌 등록/수정/삭제
- [ ] 계좌 목록 조회 API

### 예치금 충전 신청
- [ ] 판매자 페이지: 입금 신청 폼
- [ ] 관리자 페이지: 입금 확인/거부
- [ ] 입금 확인 시 예치금 충전 로직

### 광고 가격 설정
- [ ] 관리자 페이지: 가격 설정
- [ ] 가격 조회 API

### 광고 신청
- [ ] 판매자 페이지: 광고 신청 폼
- [ ] 광고 신청 API
- [ ] 광고 목록 조회 API

### 광고 상태 관리
- [ ] 광고 시간 계산 로직 (초 단위: start_datetime, end_datetime)
- [ ] 광고 만료 크론잡 (end_datetime < NOW() 체크)

### 프론트엔드
- [ ] 광고 섹션 추가 (4개 카테고리)
- [ ] JavaScript 로테이션 구현
- [ ] 광고 카드 컴포넌트

---

## 🎯 다음 작업

1. **데이터베이스 스키마 실행**
   - `rotation_advertisement_schema.sql` 파일을 phpMyAdmin에서 실행

2. **예치금 시스템 함수 구현**
   - `includes/data/deposit-functions.php` 파일 생성
   - 포인트 시스템 함수를 참고하여 구현

3. **관리자 페이지 구현**
   - 무통장 계좌 관리 페이지
   - 광고 가격 설정 페이지
   - 예치금 충전 신청 관리 페이지

위 순서대로 단계별 구현을 진행하시면 됩니다.