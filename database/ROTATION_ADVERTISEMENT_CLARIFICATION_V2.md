# 광고 시스템 요구사항 명확화 (수정)

## ❌ 제가 잘못 이해했던 부분

### 잘못된 이해
- ❌ "같은 상품에 대해 여러 개의 광고를 동시에 진행할 수 있음"
- ❌ "동시에 여러 광고 진행 가능"

### 올바른 이해
- ✅ **같은 상품에 대해 동시에 여러 개의 광고를 진행할 수 없음**
- ✅ **광고 종료 후 재신청 가능**
- ✅ **다수의 다른 상품들에 대해 각각 광고를 진행할 수 있음** (당연한 것)

---

## ✅ 최종 요구사항

### 1. 같은 상품의 광고 제한
- **동시에 여러 광고 불가**: 같은 상품(`product_id`)에 대해 동시에 여러 개의 광고를 진행할 수 없음
- **광고 종료 후 재신청 가능**: 광고가 종료(`expired`)된 후 다시 광고 신청 가능
- **중복 체크 필요**: 광고 신청 시 같은 상품에 활성화된 광고가 있는지 체크

### 2. 다른 상품들의 광고
- **독립적으로 진행 가능**: 상품 A, 상품 B, 상품 C 등 각각 독립적으로 광고 진행 가능
- **이건 당연한 것**: 여러 개의 상품이 있으면 각각 광고를 진행할 수 있음

---

## 🔧 구현 로직

### 광고 신청 시 중복 체크

```php
// 광고 신청 API에서 중복 체크
function checkActiveAdvertisement($product_id) {
    $pdo = getDBConnection();
    
    $stmt = $pdo->prepare("
        SELECT id 
        FROM rotation_advertisements 
        WHERE product_id = :product_id
        AND status = 'active'
        AND end_datetime > NOW()
        LIMIT 1
    ");
    $stmt->execute([':product_id' => $product_id]);
    
    $activeAd = $stmt->fetch();
    
    if ($activeAd) {
        return [
            'success' => false,
            'message' => '이미 광고 중인 상품입니다. 광고 종료 후 다시 신청해주세요.'
        ];
    }
    
    return ['success' => true];
}

// 광고 신청 시
$checkResult = checkActiveAdvertisement($product_id);
if (!$checkResult['success']) {
    // 에러 반환
    echo json_encode($checkResult);
    exit;
}
```

---

## 📊 시나리오 예시

### 시나리오 1: 같은 상품 - 광고 중복 불가

**상황:**
- 상품 ID: 123
- 광고 1: 2025-12-21 시작, 2025-12-28 종료 (진행 중)

**광고 신청 시도:**
- 2025-12-25에 같은 상품(123)에 대해 새로운 광고 신청 시도
- **결과**: ❌ 신청 불가 ("이미 광고 중인 상품입니다")

**광고 종료 후:**
- 2025-12-28 15:16:15에 광고 1 종료 (`status = 'expired'`)
- 2025-12-29에 같은 상품(123)에 대해 새로운 광고 신청 시도
- **결과**: ✅ 신청 가능 (광고 종료 후이므로)

---

### 시나리오 2: 다른 상품들 - 각각 독립적으로 광고 가능

**상황:**
- 상품 A (ID: 123): 광고 진행 중 (2025-12-21 ~ 2025-12-28)
- 상품 B (ID: 124): 광고 없음
- 상품 C (ID: 125): 광고 없음

**광고 신청:**
- 상품 B (124)에 광고 신청: ✅ 가능 (다른 상품이므로)
- 상품 C (125)에 광고 신청: ✅ 가능 (다른 상품이므로)
- 상품 A (123)에 또 다른 광고 신청: ❌ 불가 (같은 상품, 이미 광고 중)

---

## 💡 핵심 정리

1. **같은 상품**: 동시에 여러 광고 불가, 광고 종료 후 재신청 가능
2. **다른 상품들**: 각각 독립적으로 광고 진행 가능 (당연한 것)
3. **중복 체크**: 광고 신청 시 같은 상품에 활성화된 광고가 있는지 확인 필요

---

이제 제대로 이해했습니다!