<?php
/**
 * ?곹뭹 愿???곗씠?곕쿋?댁뒪 ?⑥닔
 */

// ?쒓뎅 ?쒓컙? ?ㅼ젙 (KST, UTC+9)
date_default_timezone_set('Asia/Seoul');

require_once __DIR__ . '/db-config.php';

/**
 * products ?뚯씠釉??앹꽦 (怨듯넻 ?⑥닔)
 * @param PDO $pdo ?곗씠?곕쿋?댁뒪 ?곌껐
 * @return bool ?깃났 ?щ?
 */
function ensureProductsTable($pdo) {
    try {
        if (!$pdo->query("SHOW TABLES LIKE 'products'")->fetch()) {
            $pdo->exec("
                CREATE TABLE IF NOT EXISTS `products` (
                    `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
                    `seller_id` INT(11) UNSIGNED NOT NULL COMMENT '?먮ℓ??ID',
                    `product_type` ENUM('mvno', 'mno', 'internet') NOT NULL COMMENT '?곹뭹 ???,
                    `status` ENUM('active', 'inactive', 'deleted') NOT NULL DEFAULT 'active' COMMENT '?곹뭹 ?곹깭',
                    `view_count` INT(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '議고쉶??,
                    `favorite_count` INT(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '李???,
                    `review_count` INT(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '由щ럭 ??,
                    `share_count` INT(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '怨듭쑀 ??,
                    `application_count` INT(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '?좎껌 ??,
                    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '?앹꽦?쇱떆',
                    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '?섏젙?쇱떆',
                    PRIMARY KEY (`id`),
                    KEY `idx_seller_id` (`seller_id`),
                    KEY `idx_product_type` (`product_type`),
                    KEY `idx_status` (`status`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='?곹뭹 湲곕낯 ?뺣낫'
            ");
            error_log("products ?뚯씠釉붿씠 ?먮룞?쇰줈 ?앹꽦?섏뿀?듬땲??");
        }
        return true;
    } catch (PDOException $e) {
        error_log("products ?뚯씠釉??앹꽦 以??ㅻ쪟: " . $e->getMessage());
        return false;
    }
}

/**
 * MVNO ?곹뭹 ??? * @param array $productData ?곹뭹 ?곗씠?? * @return int|false ?곹뭹 ID ?먮뒗 false
 */
function saveMvnoProduct($productData) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    // ?몃옖??뀡 ?쒖옉 ?꾩뿉 而щ읆 ?뺤씤 諛?異붽? (ALTER TABLE? DDL?대?濡??몃옖??뀡 諛뽰뿉???ㅽ뻾)
    // redirect_url 而щ읆 ?뺤씤 諛?異붽?
    $checkRedirectUrl = $pdo->query("SHOW COLUMNS FROM product_mvno_details LIKE 'redirect_url'");
    if (!$checkRedirectUrl->fetch()) {
        $pdo->exec("ALTER TABLE product_mvno_details ADD COLUMN redirect_url VARCHAR(500) DEFAULT NULL COMMENT '?좎껌 ??由щ떎?대젆??URL'");
        error_log("product_mvno_details ?뚯씠釉붿뿉 redirect_url 而щ읆??異붽??섏뿀?듬땲??");
    }
    
    // registration_types 而щ읆 ?뺤씤 諛?異붽?
    $checkRegistrationTypes = $pdo->query("SHOW COLUMNS FROM product_mvno_details LIKE 'registration_types'");
    if (!$checkRegistrationTypes->fetch()) {
        $pdo->exec("ALTER TABLE product_mvno_details ADD COLUMN registration_types TEXT DEFAULT NULL COMMENT '媛???뺥깭 (JSON)'");
        error_log("product_mvno_details ?뚯씠釉붿뿉 registration_types 而щ읆??異붽??섏뿀?듬땲??");
    }
    
    try {
        $pdo->beginTransaction();
        
        $isEditMode = isset($productData['product_id']) && $productData['product_id'] > 0;
        $productId = $isEditMode ? $productData['product_id'] : null;
        
        try {
            if ($isEditMode) {
                // ?섏젙 紐⑤뱶: 湲곗〈 ?곹뭹 ?뺣낫 ?낅뜲?댄듃
                $status = isset($productData['status']) && in_array($productData['status'], ['active', 'inactive']) ? $productData['status'] : null;
                if ($status) {
                    $stmt = $pdo->prepare("
                        UPDATE products 
                        SET seller_id = :seller_id, product_type = 'mvno', status = :status
                        WHERE id = :product_id AND seller_id = :seller_id_check
                    ");
                    $stmt->execute([
                        ':seller_id' => $productData['seller_id'],
                        ':product_id' => $productId,
                        ':seller_id_check' => $productData['seller_id'],
                        ':status' => $status
                    ]);
                } else {
                    $stmt = $pdo->prepare("
                        UPDATE products 
                        SET seller_id = :seller_id, product_type = 'mvno'
                        WHERE id = :product_id AND seller_id = :seller_id_check
                    ");
                    $stmt->execute([
                        ':seller_id' => $productData['seller_id'],
                        ':product_id' => $productId,
                        ':seller_id_check' => $productData['seller_id']
                    ]);
                }
            } else {
                // ?깅줉 紐⑤뱶: ???곹뭹 ?뺣낫 ???                $status = isset($productData['status']) && in_array($productData['status'], ['active', 'inactive']) ? $productData['status'] : 'active';
                $stmt = $pdo->prepare("
                    INSERT INTO products (seller_id, product_type, status, view_count)
                    VALUES (:seller_id, 'mvno', :status, 0)
                ");
                $stmt->execute([
                    ':seller_id' => $productData['seller_id'],
                    ':status' => $status
                ]);
                $productId = $pdo->lastInsertId();
            }
        } catch (PDOException $e) {
            $errorMsg = "Error in first query (products table): " . $e->getMessage();
            $errorMsg .= "\nQuery type: " . ($isEditMode ? "UPDATE" : "INSERT");
            $errorMsg .= "\nProduct ID: " . $productId;
            error_log($errorMsg);
            
            global $lastDbError;
            $lastDbError = $errorMsg;
            throw $e;
        }
        
        // ?곸꽭 ?뺣낫 議댁옱 ?щ? ?뺤씤 (?섏젙 紐⑤뱶??寃쎌슦)
        $detailExists = false;
        if ($isEditMode) {
            $checkStmt = $pdo->prepare("SELECT COUNT(*) FROM product_mvno_details WHERE product_id = :product_id");
            $checkStmt->execute([':product_id' => $productId]);
            $detailExists = $checkStmt->fetchColumn() > 0;
        }
        
        // price_after 泥섎━: price_after_type_hidden??'free'?대㈃ null, 洹??몄뿉???レ옄濡?蹂??(0???ы븿)
        $priceAfterValue = null;
        if (isset($productData['price_after_type_hidden']) && $productData['price_after_type_hidden'] === 'free') {
            // 怨듭쭨 ?좏깮 ??null濡????            $priceAfterValue = null;
        } elseif (isset($productData['price_after']) && $productData['price_after'] !== '' && $productData['price_after'] !== null && $productData['price_after'] !== 'free') {
            // 吏곸젒?낅젰 ???뺤닔濡?蹂??(0???ы븿)
            $priceAfterValue = intval($productData['price_after']);
        }
        
        // ?쎌젙湲곌컙 ?⑥쐞 泥섎━: 媛믨낵 ?⑥쐞瑜??④퍡 ???(?? "181??, "2媛쒖썡")
        $contractPeriod = $productData['contract_period'] ?? '';
        $contractPeriodDays = null;
        if ($contractPeriod === '吏곸젒?낅젰' && !empty($productData['contract_period_days'])) {
            $days = intval($productData['contract_period_days']);
            $unit = $productData['contract_period_unit'] ?? '??;
            // 湲곗〈 ?곗씠???명솚?? "????"媛쒖썡"濡?泥섎━
            if ($unit === '??) {
                $unit = '媛쒖썡';
            }
            // 媛믨낵 ?⑥쐞瑜??④퍡 ???(?? "181??, "2媛쒖썡")
            $contractPeriod = $days . $unit;
            // contract_period_days???섏쐞 ?명솚?깆쓣 ?꾪빐 ?좎? (???⑥쐞???뚮쭔)
            if ($unit === '??) {
                $contractPeriodDays = $days;
            }
        }
        
        // ?좎씤湲곌컙 ?⑥쐞 泥섎━: 吏곸젒?낅젰????媛믨낵 ?⑥쐞瑜?議고빀
        $discountPeriod = $productData['discount_period'] ?? '';
        if ($discountPeriod === '吏곸젒?낅젰' && !empty($productData['discount_period_value'])) {
            $discountValue = intval($productData['discount_period_value']);
            $discountUnit = $productData['discount_period_unit'] ?? '媛쒖썡';
            // 湲곗〈 ?곗씠???명솚?? "????"媛쒖썡"濡?蹂??            if ($discountUnit === '??) {
                $discountUnit = '媛쒖썡';
            }
            $discountPeriod = $discountValue . $discountUnit;
        }
        
        // ?뚮씪誘명꽣 諛곗뿴 以鍮?(怨듯넻)
        $params = [
            ':provider' => $productData['provider'] ?? '',
            ':service_type' => $productData['service_type'] ?? null,
            ':plan_name' => $productData['plan_name'] ?? '',
            ':contract_period' => $contractPeriod ?: null,
            ':contract_period_days' => $contractPeriodDays,
            ':discount_period' => $discountPeriod ?: null,
            ':price_main' => isset($productData['price_main']) ? intval($productData['price_main']) : 0,
            ':price_after' => $priceAfterValue,
            ':data_amount' => $productData['data_amount'] ?? null,
            ':data_amount_value' => ($productData['data_amount'] === '吏곸젒?낅젰' && !empty($productData['data_amount_value'])) ? ($productData['data_amount_value'] . ($productData['data_unit'] ?? 'GB')) : ($productData['data_amount_value'] ?? null),
            ':data_unit' => $productData['data_unit'] ?? null,
            ':data_additional' => $productData['data_additional'] ?? null,
            ':data_additional_value' => $productData['data_additional_value'] ?? null,
            ':data_exhausted' => $productData['data_exhausted'] ?? null,
            ':data_exhausted_value' => $productData['data_exhausted_value'] ?? null,
            ':call_type' => $productData['call_type'] ?? null,
            ':call_amount' => ($productData['call_type'] === '吏곸젒?낅젰' && !empty($productData['call_amount'])) ? ($productData['call_amount'] . ($productData['call_amount_unit'] ?? '遺?)) : ($productData['call_amount'] ?? null),
            ':additional_call_type' => $productData['additional_call_type'] ?? null,
            ':additional_call' => ($productData['additional_call_type'] === '吏곸젒?낅젰' && !empty($productData['additional_call'])) ? ($productData['additional_call'] . ($productData['additional_call_unit'] ?? '遺?)) : ($productData['additional_call'] ?? null),
            ':sms_type' => $productData['sms_type'] ?? null,
            ':sms_amount' => ($productData['sms_type'] === '吏곸젒?낅젰' && !empty($productData['sms_amount'])) ? ($productData['sms_amount'] . ($productData['sms_amount_unit'] ?? '嫄?)) : ($productData['sms_amount'] ?? null),
            ':mobile_hotspot' => $productData['mobile_hotspot'] ?? null,
            ':mobile_hotspot_value' => ($productData['mobile_hotspot'] === '吏곸젒?좏깮' && !empty($productData['mobile_hotspot_value'])) ? ($productData['mobile_hotspot_value'] . ($productData['mobile_hotspot_unit'] ?? 'GB')) : ($productData['mobile_hotspot_value'] ?? null),
            ':regular_sim_available' => $productData['regular_sim_available'] ?? null,
            ':regular_sim_price' => (!empty($productData['regular_sim_price']) && ($productData['regular_sim_available'] ?? '') === '諛곗넚媛??) ? ($productData['regular_sim_price'] . ($productData['regular_sim_price_unit'] ?? '??)) : ($productData['regular_sim_price'] ?? null),
            ':nfc_sim_available' => $productData['nfc_sim_available'] ?? null,
            ':nfc_sim_price' => (!empty($productData['nfc_sim_price']) && ($productData['nfc_sim_available'] ?? '') === '諛곗넚媛??) ? ($productData['nfc_sim_price'] . ($productData['nfc_sim_price_unit'] ?? '??)) : ($productData['nfc_sim_price'] ?? null),
            ':esim_available' => $productData['esim_available'] ?? null,
            ':esim_price' => (!empty($productData['esim_price']) && ($productData['esim_available'] ?? '') === '媛쒗넻媛??) ? ($productData['esim_price'] . ($productData['esim_price_unit'] ?? '??)) : ($productData['esim_price'] ?? null),
            ':over_data_price' => (!empty($productData['over_data_price'])) ? ($productData['over_data_price'] . ($productData['over_data_price_unit'] ?? '??MB')) : null,
            ':over_voice_price' => (!empty($productData['over_voice_price'])) ? ($productData['over_voice_price'] . ($productData['over_voice_price_unit'] ?? '??珥?)) : null,
            ':over_video_price' => (!empty($productData['over_video_price'])) ? ($productData['over_video_price'] . ($productData['over_video_price_unit'] ?? '??珥?)) : null,
            ':over_sms_price' => (!empty($productData['over_sms_price'])) ? ($productData['over_sms_price'] . ($productData['over_sms_price_unit'] ?? '??嫄?)) : null,
            ':over_lms_price' => (!empty($productData['over_lms_price'])) ? ($productData['over_lms_price'] . ($productData['over_lms_price_unit'] ?? '??嫄?)) : null,
            ':over_mms_price' => (!empty($productData['over_mms_price'])) ? ($productData['over_mms_price'] . ($productData['over_mms_price_unit'] ?? '??嫄?)) : null,
            ':promotion_title' => $productData['promotion_title'] ?? null,
            ':promotions' => !empty($productData['promotions']) ? json_encode($productData['promotions']) : null,
            ':benefits' => !empty($productData['benefits']) ? json_encode($productData['benefits']) : null,
            ':registration_types' => !empty($productData['registration_types']) ? json_encode($productData['registration_types']) : null,
            ':redirect_url' => !empty($productData['redirect_url']) ? preg_replace('/\s+/', '', trim($productData['redirect_url'])) : null,
        ];
        
        // 荑쇰━蹂??뚮씪誘명꽣 諛곗뿴 以鍮?        if ($isEditMode && $detailExists) {
            // ?섏젙 紐⑤뱶: ?곸꽭 ?뺣낫 ?낅뜲?댄듃
            $updateParams = array_merge($params, [':product_id' => $productId]);
            $queryString = "
                UPDATE product_mvno_details SET
                provider = :provider, service_type = :service_type, plan_name = :plan_name, contract_period = :contract_period,
                contract_period_days = :contract_period_days, discount_period = :discount_period, price_main = :price_main, price_after = :price_after,
                data_amount = :data_amount, data_amount_value = :data_amount_value, data_unit = :data_unit, data_additional = :data_additional, data_additional_value = :data_additional_value, data_exhausted = :data_exhausted, data_exhausted_value = :data_exhausted_value,
                call_type = :call_type, call_amount = :call_amount, additional_call_type = :additional_call_type, additional_call = :additional_call,
                sms_type = :sms_type, sms_amount = :sms_amount, mobile_hotspot = :mobile_hotspot, mobile_hotspot_value = :mobile_hotspot_value,
                regular_sim_available = :regular_sim_available, regular_sim_price = :regular_sim_price, nfc_sim_available = :nfc_sim_available, nfc_sim_price = :nfc_sim_price,
                esim_available = :esim_available, esim_price = :esim_price, over_data_price = :over_data_price, over_voice_price = :over_voice_price,
                over_video_price = :over_video_price, over_sms_price = :over_sms_price, over_lms_price = :over_lms_price, over_mms_price = :over_mms_price,
                promotion_title = :promotion_title, promotions = :promotions, benefits = :benefits, registration_types = :registration_types, redirect_url = :redirect_url
                WHERE product_id = :product_id
            ";
            $stmt = $pdo->prepare($queryString);
            $executeParams = $updateParams;
        } else {
            // ?깅줉 紐⑤뱶: ?곸꽭 ?뺣낫 ???            $insertParams = array_merge($params, [':product_id' => $productId]);
            $queryString = "
                INSERT INTO product_mvno_details (
                product_id, provider, service_type, plan_name, contract_period,
                contract_period_days, discount_period, price_main, price_after,
                data_amount, data_amount_value, data_unit, data_additional, data_additional_value, data_exhausted, data_exhausted_value,
                call_type, call_amount, additional_call_type, additional_call,
                sms_type, sms_amount, mobile_hotspot, mobile_hotspot_value,
                regular_sim_available, regular_sim_price, nfc_sim_available, nfc_sim_price,
                esim_available, esim_price, over_data_price, over_voice_price,
                over_video_price, over_sms_price, over_lms_price, over_mms_price,
                promotion_title, promotions, benefits, registration_types, redirect_url
            ) VALUES (
                :product_id, :provider, :service_type, :plan_name, :contract_period,
                :contract_period_days, :discount_period, :price_main, :price_after,
                :data_amount, :data_amount_value, :data_unit, :data_additional, :data_additional_value, :data_exhausted, :data_exhausted_value,
                :call_type, :call_amount, :additional_call_type, :additional_call,
                :sms_type, :sms_amount, :mobile_hotspot, :mobile_hotspot_value,
                :regular_sim_available, :regular_sim_price, :nfc_sim_available, :nfc_sim_price,
                :esim_available, :esim_price, :over_data_price, :over_voice_price,
                :over_video_price, :over_sms_price, :over_lms_price, :over_mms_price,
                :promotion_title, :promotions, :benefits, :registration_types, :redirect_url
            )
        ";
            $stmt = $pdo->prepare($queryString);
            $executeParams = $insertParams;
        }
        
        try {
            $stmt->execute($executeParams);
        } catch (PDOException $e) {
            // ?먮윭 ?뺣낫 濡쒓퉭
            $errorMsg = "Error executing query: " . $e->getMessage();
            $errorMsg .= "\nSQL State: " . $e->getCode();
            $errorMsg .= "\nQuery type: " . ($isEditMode && $detailExists ? "UPDATE" : "INSERT");
            $errorMsg .= "\nProduct ID: " . $productId;
            error_log($errorMsg);
            
            // ?꾩뿭 蹂?섏뿉 ??ν븯??API?먯꽌 ?묎렐 媛?ν븯?꾨줉
            global $lastDbError;
            $lastDbError = $errorMsg;
            
            throw $e;
        }
        
        $pdo->commit();
        return $productId;
    } catch (PDOException $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        global $lastDbError;
        // $lastDbError媛 ?대? ?곸꽭 ?뺣낫濡??ㅼ젙?섏뼱 ?덉쑝硫?洹몃?濡??ъ슜
        if (!isset($lastDbError) || empty($lastDbError) || $lastDbError === $e->getMessage()) {
            $errorMsg = "Error saving MVNO product: " . $e->getMessage();
            $errorMsg .= "\nSQL State: " . $e->getCode();
            $errorMsg .= "\nStack trace: " . $e->getTraceAsString();
            $errorMsg .= "\nProduct data: " . json_encode($productData);
            error_log($errorMsg);
            $lastDbError = $errorMsg;
        }
        
        return false;
    } catch (Exception $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        error_log("Unexpected error saving MVNO product: " . $e->getMessage());
        error_log("Stack trace: " . $e->getTraceAsString());
        return false;
    }
}

/**
 * MNO ?곹뭹 ??? * @param array $productData ?곹뭹 ?곗씠?? * @return int|false ?곹뭹 ID ?먮뒗 false
 */
function saveMnoProduct($productData) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    // ?뚯씠釉?議댁옱 ?щ? ?뺤씤 諛??앹꽦
    try {
        $checkTable = $pdo->query("SHOW TABLES LIKE 'product_mno_details'");
        $tableExists = $checkTable->fetch();
        
        // ?뚯씠釉붿씠 議댁옱?섎㈃ device_id 而щ읆 ?뺤씤 諛?異붽?
        if ($tableExists) {
            $checkColumn = $pdo->query("SHOW COLUMNS FROM product_mno_details LIKE 'device_id'");
            if (!$checkColumn->fetch()) {
                // device_id 而щ읆 異붽?
                $pdo->exec("ALTER TABLE product_mno_details ADD COLUMN device_id INT(11) UNSIGNED DEFAULT NULL COMMENT '?⑤쭚湲?ID' AFTER product_id");
                error_log("product_mno_details ?뚯씠釉붿뿉 device_id 而щ읆??異붽??섏뿀?듬땲??");
            }
            
            // redirect_url 而щ읆 ?뺤씤 諛?異붽?
            $checkRedirectUrl = $pdo->query("SHOW COLUMNS FROM product_mno_details LIKE 'redirect_url'");
            if (!$checkRedirectUrl->fetch()) {
                // redirect_url 而щ읆 異붽?
                $pdo->exec("ALTER TABLE product_mno_details ADD COLUMN redirect_url VARCHAR(500) DEFAULT NULL COMMENT '?좎껌 ??由щ떎?대젆??URL' AFTER visit_region");
                error_log("product_mno_details ?뚯씠釉붿뿉 redirect_url 而щ읆??異붽??섏뿀?듬땲??");
            }
        }
        
        if (!$tableExists) {
            // product_mno_details ?뚯씠釉??앹꽦
            $createTableSQL = "
            CREATE TABLE IF NOT EXISTS `product_mno_details` (
                `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
                `product_id` INT(11) UNSIGNED NOT NULL COMMENT '?곹뭹 ID',
                `device_id` INT(11) UNSIGNED DEFAULT NULL COMMENT '?⑤쭚湲?ID',
                `device_name` VARCHAR(100) NOT NULL COMMENT '?⑤쭚湲곕챸',
                `device_price` DECIMAL(12,2) DEFAULT NULL COMMENT '?⑤쭚湲?異쒓퀬媛',
                `device_capacity` VARCHAR(20) DEFAULT NULL COMMENT '?⑸웾',
                `device_colors` TEXT DEFAULT NULL COMMENT '?⑤쭚湲??됱긽 紐⑸줉 (JSON)',
                `common_provider` TEXT DEFAULT NULL COMMENT '怨듯넻吏?먰븷???듭떊??(JSON)',
                `common_discount_new` TEXT DEFAULT NULL COMMENT '怨듯넻吏?먰븷???좉퇋媛??(JSON)',
                `common_discount_port` TEXT DEFAULT NULL COMMENT '怨듯넻吏?먰븷??踰덊샇?대룞 (JSON)',
                `common_discount_change` TEXT DEFAULT NULL COMMENT '怨듯넻吏?먰븷??湲곌린蹂寃?(JSON)',
                `contract_provider` TEXT DEFAULT NULL COMMENT '?좏깮?쎌젙?좎씤 ?듭떊??(JSON)',
                `contract_discount_new` TEXT DEFAULT NULL COMMENT '?좏깮?쎌젙?좎씤 ?좉퇋媛??(JSON)',
                `contract_discount_port` TEXT DEFAULT NULL COMMENT '?좏깮?쎌젙?좎씤 踰덊샇?대룞 (JSON)',
                `contract_discount_change` TEXT DEFAULT NULL COMMENT '?좏깮?쎌젙?좎씤 湲곌린蹂寃?(JSON)',
                `service_type` VARCHAR(50) DEFAULT NULL COMMENT '?쒕퉬?????,
                `contract_period` VARCHAR(50) DEFAULT NULL COMMENT '?쎌젙湲곌컙',
                `contract_period_value` VARCHAR(20) DEFAULT NULL COMMENT '?쎌젙湲곌컙 媛?,
                `price_main` DECIMAL(10,2) DEFAULT NULL COMMENT '湲곕낯 ?붽툑',
                `data_amount` VARCHAR(50) DEFAULT NULL COMMENT '?곗씠?곕웾',
                `data_amount_value` VARCHAR(20) DEFAULT NULL COMMENT '?곗씠?곕웾 媛?,
                `data_unit` VARCHAR(10) DEFAULT NULL COMMENT '?곗씠???⑥쐞',
                `data_exhausted` VARCHAR(50) DEFAULT NULL COMMENT '?곗씠???뚯쭊 ??,
                `data_exhausted_value` VARCHAR(50) DEFAULT NULL COMMENT '?곗씠???뚯쭊 ??媛?,
                `call_type` VARCHAR(50) DEFAULT NULL COMMENT '?듯솕 ???,
                `call_amount` VARCHAR(20) DEFAULT NULL COMMENT '?듯솕??,
                `additional_call_type` VARCHAR(50) DEFAULT NULL COMMENT '異붽? ?듯솕 ???,
                `additional_call` VARCHAR(20) DEFAULT NULL COMMENT '異붽? ?듯솕??,
                `sms_type` VARCHAR(50) DEFAULT NULL COMMENT 'SMS ???,
                `sms_amount` VARCHAR(20) DEFAULT NULL COMMENT 'SMS??,
                `mobile_hotspot` VARCHAR(50) DEFAULT NULL COMMENT '紐⑤컮???レ뒪??,
                `mobile_hotspot_value` VARCHAR(20) DEFAULT NULL COMMENT '紐⑤컮???レ뒪??媛?,
                `regular_sim_available` VARCHAR(10) DEFAULT NULL COMMENT '?쇰컲 SIM 媛???щ?',
                `regular_sim_price` VARCHAR(20) DEFAULT NULL COMMENT '?쇰컲 SIM 媛寃?,
                `nfc_sim_available` VARCHAR(10) DEFAULT NULL COMMENT 'NFC SIM 媛???щ?',
                `nfc_sim_price` VARCHAR(20) DEFAULT NULL COMMENT 'NFC SIM 媛寃?,
                `esim_available` VARCHAR(10) DEFAULT NULL COMMENT 'eSIM 媛???щ?',
                `esim_price` VARCHAR(20) DEFAULT NULL COMMENT 'eSIM 媛寃?,
                `over_data_price` VARCHAR(20) DEFAULT NULL COMMENT '?곗씠??珥덇낵 ??媛寃?,
                `over_voice_price` VARCHAR(20) DEFAULT NULL COMMENT '?뚯꽦 珥덇낵 ??媛寃?,
                `over_video_price` VARCHAR(20) DEFAULT NULL COMMENT '?곸긽?듯솕 珥덇낵 ??媛寃?,
                `over_sms_price` VARCHAR(20) DEFAULT NULL COMMENT 'SMS 珥덇낵 ??媛寃?,
                `over_lms_price` VARCHAR(20) DEFAULT NULL COMMENT 'LMS 珥덇낵 ??媛寃?,
                `over_mms_price` VARCHAR(20) DEFAULT NULL COMMENT 'MMS 珥덇낵 ??媛寃?,
                `promotion_title` VARCHAR(200) DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 ?쒕ぉ',
                `promotions` TEXT DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 紐⑸줉 (JSON)',
                `benefits` TEXT DEFAULT NULL COMMENT '?쒗깮 紐⑸줉 (JSON)',
                `delivery_method` VARCHAR(20) DEFAULT 'delivery' COMMENT '諛곗넚 諛⑸쾿',
                `visit_region` VARCHAR(50) DEFAULT NULL COMMENT '諛⑸Ц 吏??,
                `redirect_url` VARCHAR(500) DEFAULT NULL COMMENT '?좎껌 ??由щ떎?대젆??URL',
                `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                PRIMARY KEY (`id`),
                UNIQUE KEY `uk_product_id` (`product_id`),
                KEY `idx_device_name` (`device_name`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='MNO ?곹뭹 ?곸꽭 ?뺣낫';
            ";
            $pdo->exec($createTableSQL);
            error_log("product_mno_details ?뚯씠釉붿씠 ?먮룞?쇰줈 ?앹꽦?섏뿀?듬땲??");
        }
        
        // products ?뚯씠釉??뺤씤 諛??앹꽦
        ensureProductsTable($pdo);
    } catch (PDOException $e) {
        error_log("?뚯씠釉??앹꽦 以??ㅻ쪟: " . $e->getMessage());
        // ?뚯씠釉??앹꽦 ?ㅽ뙣?대룄 怨꾩냽 吏꾪뻾 (?몃옒???쒖빟議곌굔???덉쓣 ???덉쓬)
    }
    
    try {
        $pdo->beginTransaction();
        
        $isEditMode = isset($productData['product_id']) && $productData['product_id'] > 0;
        
        if ($isEditMode) {
            // ?섏젙 紐⑤뱶: 湲곗〈 ?곹뭹 ?낅뜲?댄듃
            $productId = $productData['product_id'];
            
            // ?곹뭹 ?뚯쑀沅??뺤씤
            $checkStmt = $pdo->prepare("SELECT id FROM products WHERE id = ? AND seller_id = ? AND product_type = 'mno'");
            $checkStmt->execute([$productId, $productData['seller_id']]);
            if (!$checkStmt->fetch()) {
                throw new Exception("?곹뭹??李얠쓣 ???녾굅???섏젙 沅뚰븳???놁뒿?덈떎.");
            }
            
            // ?곹깭 ?낅뜲?댄듃 (?쒓났??寃쎌슦)
            if (isset($productData['status']) && in_array($productData['status'], ['active', 'inactive'])) {
                $statusStmt = $pdo->prepare("UPDATE products SET status = ? WHERE id = ?");
                $statusStmt->execute([$productData['status'], $productId]);
            }
        } else {
            // 1. 湲곕낯 ?곹뭹 ?뺣낫 ???            $status = isset($productData['status']) && in_array($productData['status'], ['active', 'inactive']) ? $productData['status'] : 'active';
            $stmt = $pdo->prepare("
                INSERT INTO products (seller_id, product_type, status, view_count)
                VALUES (:seller_id, 'mno', :status, 0)
            ");
            $stmt->execute([
                ':seller_id' => $productData['seller_id'],
                ':status' => $status
            ]);
            $productId = $pdo->lastInsertId();
        }
        
        // 2. MNO ?곸꽭 ?뺣낫 ????낅뜲?댄듃
        // 怨듯넻 ?뚮씪誘명꽣 諛곗뿴 ?앹꽦
        $executeParams = [
            ':product_id' => $productId,
            ':device_id' => $productData['device_id'] ?? null,
            ':device_name' => $productData['device_name'] ?? '',
            ':device_price' => isset($productData['device_price']) && $productData['device_price'] !== '' ? floatval($productData['device_price']) : null,
            ':device_capacity' => $productData['device_capacity'] ?? null,
            ':device_colors' => !empty($productData['device_colors']) ? json_encode($productData['device_colors']) : null,
            ':common_provider' => !empty($productData['common_provider']) ? json_encode($productData['common_provider']) : null,
            ':common_discount_new' => !empty($productData['common_discount_new']) ? json_encode($productData['common_discount_new']) : null,
            ':common_discount_port' => !empty($productData['common_discount_port']) ? json_encode($productData['common_discount_port']) : null,
            ':common_discount_change' => !empty($productData['common_discount_change']) ? json_encode($productData['common_discount_change']) : null,
            ':contract_provider' => !empty($productData['contract_provider']) ? json_encode($productData['contract_provider']) : null,
            ':contract_discount_new' => !empty($productData['contract_discount_new']) ? json_encode($productData['contract_discount_new']) : null,
            ':contract_discount_port' => !empty($productData['contract_discount_port']) ? json_encode($productData['contract_discount_port']) : null,
            ':contract_discount_change' => !empty($productData['contract_discount_change']) ? json_encode($productData['contract_discount_change']) : null,
            ':service_type' => $productData['service_type'] ?? null,
            ':contract_period' => $productData['contract_period'] ?? null,
            ':contract_period_value' => $productData['contract_period_value'] ?? null,
            ':price_main' => isset($productData['price_main']) && $productData['price_main'] !== '' ? intval($productData['price_main']) : null,
            ':data_amount' => $productData['data_amount'] ?? null,
            ':data_amount_value' => $productData['data_amount_value'] ?? null,
            ':data_unit' => $productData['data_unit'] ?? null,
            ':data_exhausted' => $productData['data_exhausted'] ?? null,
            ':data_exhausted_value' => $productData['data_exhausted_value'] ?? null,
            ':call_type' => $productData['call_type'] ?? null,
            ':call_amount' => $productData['call_amount'] ?? null,
            ':additional_call_type' => $productData['additional_call_type'] ?? null,
            ':additional_call' => $productData['additional_call'] ?? null,
            ':sms_type' => $productData['sms_type'] ?? null,
            ':sms_amount' => $productData['sms_amount'] ?? null,
            ':mobile_hotspot' => $productData['mobile_hotspot'] ?? null,
            ':mobile_hotspot_value' => $productData['mobile_hotspot_value'] ?? null,
            ':regular_sim_available' => $productData['regular_sim_available'] ?? null,
            ':regular_sim_price' => $productData['regular_sim_price'] ?? null,
            ':nfc_sim_available' => $productData['nfc_sim_available'] ?? null,
            ':nfc_sim_price' => $productData['nfc_sim_price'] ?? null,
            ':esim_available' => $productData['esim_available'] ?? null,
            ':esim_price' => $productData['esim_price'] ?? null,
            ':over_data_price' => $productData['over_data_price'] ?? null,
            ':over_voice_price' => $productData['over_voice_price'] ?? null,
            ':over_video_price' => $productData['over_video_price'] ?? null,
            ':over_sms_price' => $productData['over_sms_price'] ?? null,
            ':over_lms_price' => $productData['over_lms_price'] ?? null,
            ':over_mms_price' => $productData['over_mms_price'] ?? null,
            ':promotion_title' => $productData['promotion_title'] ?? null,
            ':promotions' => !empty($productData['promotions']) ? json_encode($productData['promotions']) : null,
            ':benefits' => !empty($productData['benefits']) ? json_encode($productData['benefits']) : null,
            ':delivery_method' => $productData['delivery_method'] ?? 'delivery',
            ':visit_region' => $productData['visit_region'] ?? null,
            ':redirect_url' => !empty($productData['redirect_url']) ? trim($productData['redirect_url']) : null,
        ];
        
        if ($isEditMode) {
            // ?낅뜲?댄듃
            $stmt = $pdo->prepare("
                UPDATE product_mno_details SET
                    device_id = :device_id,
                    device_name = :device_name,
                    device_price = :device_price,
                    device_capacity = :device_capacity,
                    device_colors = :device_colors,
                    common_provider = :common_provider,
                    common_discount_new = :common_discount_new,
                    common_discount_port = :common_discount_port,
                    common_discount_change = :common_discount_change,
                    contract_provider = :contract_provider,
                    contract_discount_new = :contract_discount_new,
                    contract_discount_port = :contract_discount_port,
                    contract_discount_change = :contract_discount_change,
                    service_type = :service_type,
                    contract_period = :contract_period,
                    contract_period_value = :contract_period_value,
                    price_main = :price_main,
                    data_amount = :data_amount,
                    data_amount_value = :data_amount_value,
                    data_unit = :data_unit,
                    data_exhausted = :data_exhausted,
                    data_exhausted_value = :data_exhausted_value,
                    call_type = :call_type,
                    call_amount = :call_amount,
                    additional_call_type = :additional_call_type,
                    additional_call = :additional_call,
                    sms_type = :sms_type,
                    sms_amount = :sms_amount,
                    mobile_hotspot = :mobile_hotspot,
                    mobile_hotspot_value = :mobile_hotspot_value,
                    regular_sim_available = :regular_sim_available,
                    regular_sim_price = :regular_sim_price,
                    nfc_sim_available = :nfc_sim_available,
                    nfc_sim_price = :nfc_sim_price,
                    esim_available = :esim_available,
                    esim_price = :esim_price,
                    over_data_price = :over_data_price,
                    over_voice_price = :over_voice_price,
                    over_video_price = :over_video_price,
                    over_sms_price = :over_sms_price,
                    over_lms_price = :over_lms_price,
                    over_mms_price = :over_mms_price,
                    promotion_title = :promotion_title,
                    promotions = :promotions,
                    benefits = :benefits,
                    delivery_method = :delivery_method,
                    visit_region = :visit_region,
                    redirect_url = :redirect_url
                WHERE product_id = :product_id
            ");
            $stmt->execute($executeParams);
        } else {
            // ?좉퇋 ?깅줉
            $stmt = $pdo->prepare("
                INSERT INTO product_mno_details (
                product_id, device_id, device_name, device_price, device_capacity, device_colors,
                common_provider, common_discount_new, common_discount_port, common_discount_change,
                contract_provider, contract_discount_new, contract_discount_port, contract_discount_change,
                service_type, contract_period, contract_period_value, price_main,
                data_amount, data_amount_value, data_unit, data_exhausted, data_exhausted_value,
                call_type, call_amount, additional_call_type, additional_call,
                sms_type, sms_amount, mobile_hotspot, mobile_hotspot_value,
                regular_sim_available, regular_sim_price, nfc_sim_available, nfc_sim_price,
                esim_available, esim_price, over_data_price, over_voice_price,
                over_video_price, over_sms_price, over_lms_price, over_mms_price,
                promotion_title, promotions, benefits, delivery_method, visit_region, redirect_url
            ) VALUES (
                :product_id, :device_id, :device_name, :device_price, :device_capacity, :device_colors,
                :common_provider, :common_discount_new, :common_discount_port, :common_discount_change,
                :contract_provider, :contract_discount_new, :contract_discount_port, :contract_discount_change,
                :service_type, :contract_period, :contract_period_value, :price_main,
                :data_amount, :data_amount_value, :data_unit, :data_exhausted, :data_exhausted_value,
                :call_type, :call_amount, :additional_call_type, :additional_call,
                :sms_type, :sms_amount, :mobile_hotspot, :mobile_hotspot_value,
                :regular_sim_available, :regular_sim_price, :nfc_sim_available, :nfc_sim_price,
                :esim_available, :esim_price, :over_data_price, :over_voice_price,
                :over_video_price, :over_sms_price, :over_lms_price, :over_mms_price,
                :promotion_title, :promotions, :benefits, :delivery_method, :visit_region, :redirect_url
            )
        ");
            $stmt->execute($executeParams);
        }
        
        $pdo->commit();
        return $productId;
    } catch (PDOException $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        $errorMsg = "Error saving MNO product: " . $e->getMessage();
        $errorMsg .= "\nSQL State: " . $e->getCode();
        $errorMsg .= "\nError Info: " . json_encode($pdo->errorInfo() ?? []);
        $errorMsg .= "\nStack trace: " . $e->getTraceAsString();
        $errorMsg .= "\nProduct data: " . json_encode($productData);
        
        error_log($errorMsg);
        
        // ?꾩뿭 蹂?섏뿉 ?먮윭 ?뺣낫 ???        global $lastDbError;
        $lastDbError = "PDO ?ㅻ쪟: " . $e->getMessage() . " (SQL State: " . $e->getCode() . ")";
        
        return false;
    } catch (Exception $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        $errorMsg = "Unexpected error saving MNO product: " . $e->getMessage();
        $errorMsg .= "\nStack trace: " . $e->getTraceAsString();
        error_log($errorMsg);
        
        global $lastDbError;
        $lastDbError = "?덉쇅 諛쒖깮: " . $e->getMessage();
        
        return false;
    }
}

/**
 * Internet ?곹뭹 ??? * @param array $productData ?곹뭹 ?곗씠?? * @return int|false ?곹뭹 ID ?먮뒗 false
 */
function saveInternetProduct($productData) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    // ?뚯씠釉??먮룞 ?앹꽦 (?뚯씠釉붿씠 ?놁쓣 ?뚮쭔)
    try {
        if (!$pdo->query("SHOW TABLES LIKE 'product_internet_details'")->fetch()) {
            $pdo->exec("
                CREATE TABLE IF NOT EXISTS `product_internet_details` (
                    `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
                    `product_id` INT(11) UNSIGNED NOT NULL COMMENT '?곹뭹 ID',
                    `registration_place` VARCHAR(50) NOT NULL COMMENT '?명꽣?룰??낆쿂',
                    `service_type` VARCHAR(20) NOT NULL DEFAULT '?명꽣?? COMMENT '?쒕퉬?????(?명꽣???먮뒗 ?명꽣??TV)',
                    `speed_option` VARCHAR(20) DEFAULT NULL COMMENT '媛?낆냽??,
                    `monthly_fee` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '???붽툑??(?띿뒪???뺤떇)',
                    `cash_payment_names` TEXT DEFAULT NULL COMMENT '?꾧툑吏湲???ぉ紐?(JSON)',
                    `cash_payment_prices` TEXT DEFAULT NULL COMMENT '?꾧툑吏湲?媛寃?(JSON)',
                    `gift_card_names` TEXT DEFAULT NULL COMMENT '?곹뭹沅?吏湲???ぉ紐?(JSON)',
                    `gift_card_prices` TEXT DEFAULT NULL COMMENT '?곹뭹沅?吏湲?媛寃?(JSON)',
                    `equipment_names` TEXT DEFAULT NULL COMMENT '?λ퉬 ?쒓났 ??ぉ紐?(JSON)',
                    `equipment_prices` TEXT DEFAULT NULL COMMENT '?λ퉬 ?쒓났 媛寃?(JSON)',
                    `installation_names` TEXT DEFAULT NULL COMMENT '?ㅼ튂 諛?湲고? ?쒕퉬????ぉ紐?(JSON)',
                    `installation_prices` TEXT DEFAULT NULL COMMENT '?ㅼ튂 諛?湲고? ?쒕퉬??媛寃?(JSON)',
                    `promotion_title` VARCHAR(200) DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 ?쒕ぉ',
                    `promotions` TEXT DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 紐⑸줉 (JSON)',
                    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    PRIMARY KEY (`id`),
                    UNIQUE KEY `uk_product_id` (`product_id`),
                    KEY `idx_registration_place` (`registration_place`),
                    KEY `idx_service_type` (`service_type`),
                    KEY `idx_speed_option` (`speed_option`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Internet ?곹뭹 ?곸꽭 ?뺣낫'
            ");
            error_log("product_internet_details ?뚯씠釉붿씠 ?앹꽦?섏뿀?듬땲??");
        }

        // products ?뚯씠釉??뺤씤 諛??앹꽦
        ensureProductsTable($pdo);
        
        // promotion_title 而щ읆 ?뺤씤 諛?異붽?
        $checkPromotionTitle = $pdo->query("SHOW COLUMNS FROM product_internet_details LIKE 'promotion_title'");
        if (!$checkPromotionTitle->fetch()) {
            $pdo->exec("ALTER TABLE product_internet_details ADD COLUMN promotion_title VARCHAR(200) DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 ?쒕ぉ'");
            error_log("product_internet_details ?뚯씠釉붿뿉 promotion_title 而щ읆??異붽??섏뿀?듬땲??");
        }
        
        // promotions 而щ읆 ?뺤씤 諛?異붽?
        $checkPromotions = $pdo->query("SHOW COLUMNS FROM product_internet_details LIKE 'promotions'");
        if (!$checkPromotions->fetch()) {
            $pdo->exec("ALTER TABLE product_internet_details ADD COLUMN promotions TEXT DEFAULT NULL COMMENT '?꾨줈紐⑥뀡 紐⑸줉 (JSON)'");
            error_log("product_internet_details ?뚯씠釉붿뿉 promotions 而щ읆??異붽??섏뿀?듬땲??");
        }
    } catch (PDOException $e) {
        error_log("?뚯씠釉??앹꽦 以??ㅻ쪟: " . $e->getMessage());
    }
    
    try {
        $pdo->beginTransaction();
        
        $isEditMode = isset($productData['product_id']) && $productData['product_id'] > 0;
        $productId = $isEditMode ? $productData['product_id'] : null;
        
        if ($isEditMode) {
            $status = isset($productData['status']) && in_array($productData['status'], ['active', 'inactive']) ? $productData['status'] : 'active';
            
            $checkStmt = $pdo->prepare("SELECT id FROM products WHERE id = ? AND seller_id = ? AND product_type = 'internet'");
            $checkStmt->execute([$productId, $productData['seller_id']]);
            if (!$checkStmt->fetch()) {
                throw new Exception("?곹뭹??李얠쓣 ???녾굅???섏젙 沅뚰븳???놁뒿?덈떎.");
            }
            
            $stmt = $pdo->prepare("UPDATE products SET status = :status WHERE id = :product_id AND seller_id = :seller_id");
            $stmt->execute([
                ':status' => $status,
                ':product_id' => $productId,
                ':seller_id' => $productData['seller_id']
            ]);
        } else {
            $stmt = $pdo->prepare("INSERT INTO products (seller_id, product_type, status, view_count) VALUES (:seller_id, 'internet', 'active', 0)");
            $stmt->execute([':seller_id' => $productData['seller_id']]);
            $productId = $pdo->lastInsertId();
        }
        
        // 媛寃??곗씠??泥섎━ 諛??꾪꽣留?(?낅젰??媛?洹몃?濡??띿뒪?몃줈 ??? ?뚯닔???쒓굅)
        $processPrices = function($prices, $units = []) {
            if (empty($prices) || !is_array($prices)) return [];
            return array_map(function($price, $index) use ($units) {
                if (empty($price)) return '';
                
                // ?대? ?⑥쐞媛 ?ы븿??寃쎌슦 (?? "50000??)
                if (preg_match('/^(\d+)([媛-??+)$/', $price, $matches)) {
                    // ?レ옄 遺遺꾩쓽 ?쇳몴? ?뚯닔???쒓굅 ???뺤닔濡?蹂??                    $numericPart = str_replace([',', '.'], '', $matches[1]);
                    $numericValue = intval($numericPart); // ?뺤닔濡?蹂??(?뚯닔???쒓굅)
                    $unit = $matches[2];
                    return $numericValue . $unit;
                }
                
                // ?レ옄留??덈뒗 寃쎌슦 (?쇳몴, ?뚯닔???쒓굅 ???뺤닔濡?蹂??
                $cleanNumeric = str_replace([',', '.'], '', preg_replace('/[^0-9.,]/', '', $price));
                $numericValue = intval($cleanNumeric); // ?뺤닔濡?蹂??(?뚯닔???쒓굅)
                $unit = isset($units[$index]) && !empty($units[$index]) ? $units[$index] : '??;
                return $numericValue ? ($numericValue . $unit) : '';
            }, $prices, array_keys($prices));
        };
        
        // ?꾨뱶紐??뺣━ ?⑥닔 (?몄퐫???ㅻ쪟 諛??ㅽ? ?섏젙)
        $cleanFieldName = function($name) {
            if (empty($name) || !is_string($name)) return '';
            
            // 怨듬갚 ?쒓굅
            $name = trim($name);
            
            // ?쇰컲?곸씤 ?ㅽ? 諛??몄퐫???ㅻ쪟 ?섏젙
            $corrections = [
                // ??댄뙆?닿났?좉린 愿???ㅽ?
                '/??댄뙆?닿났?좉린\s*[?뉎꽮?곥꽩?귙뀉]+/u' => '??댄뙆?닿났?좉린',
                '/??댄뙆?닿났?좉린\s*[?뉎꽮]/u' => '??댄뙆?닿났?좉린',
                // ?ㅼ튂鍮?愿???ㅽ?
                '/??\s*???듽뀍]??대퉬/u' => '?ㅼ튂鍮?,
                '/???듽뀍]??대퉬/u' => '?ㅼ튂鍮?,
            ];
            
            // ?⑦꽩 湲곕컲 ?섏젙
            foreach ($corrections as $pattern => $replacement) {
                $name = preg_replace($pattern, $replacement, $name);
            }
            
            // ?뱀닔臾몄옄???댁긽??臾몄옄 ?쒓굅 (?쒓?, ?レ옄, ?곷Ц, 怨듬갚留??덉슜)
            $name = preg_replace('/[^\p{Hangul}\p{L}\p{N}\s]/u', '', $name);
            
            // ?⑥뼱 ?앹뿉 ?섎??녿뒗 ?먯쓬??遺숈? 寃쎌슦 ?쒓굅
            $name = preg_replace('/\s+[?뉎꽮?곥꽩?귙뀉?뉎꽮]+$/u', '', $name);
            
            // ?욌뮘 怨듬갚 ?쒓굅
            $name = trim($name);
            
            return $name;
        };
        
        $filterArrays = function($names, $prices) use ($cleanFieldName) {
            $filtered = ['names' => [], 'prices' => []];
            if (empty($names) || !is_array($names)) return $filtered;
            
            $seen = []; // 以묐났 泥댄겕??            
            foreach ($names as $index => $name) {
                // ?꾨뱶紐??뺣━
                $cleanedName = $cleanFieldName($name);
                
                // 鍮??대쫫 ?쒓굅
                if (empty($cleanedName) || $cleanedName === '-') continue;
                
                // 以묐났 ?쒓굅 (?대쫫 湲곗?, ??뚮Ц??援щ텇 ?놁씠)
                $key = mb_strtolower($cleanedName, 'UTF-8');
                if (isset($seen[$key])) continue;
                $seen[$key] = true;
                
                $filtered['names'][] = $cleanedName;
                $filtered['prices'][] = $prices[$index] ?? '';
            }
            return $filtered;
        };
        
        // ???붽툑 泥섎━ (?낅젰??媛믪쓣 洹몃?濡??띿뒪?몃줈 ???
        $monthlyFee = '';
        if (!empty($productData['monthly_fee'])) {
            // ?낅젰??媛믪쓣 洹몃?濡????(?쇳몴???쒓굅?섎릺, ?レ옄? ?⑥쐞??洹몃?濡??좎?)
            $inputValue = trim($productData['monthly_fee']);
            
            // ?대? ?⑥쐞媛 ?ы븿??寃쎌슦 洹몃?濡????(?쇳몴留??쒓굅)
            if (preg_match('/^(\d+)([媛-??+)$/', $inputValue, $matches)) {
                // ?レ옄 遺遺꾩쓽 ?쇳몴? ?뚯닔???쒓굅 ???뺤닔濡?蹂??                $numericPart = str_replace([',', '.'], '', $matches[1]);
                $numericValue = intval($numericPart);
                $unit = $matches[2];
                $monthlyFee = $numericValue . $unit;
            } else {
                // ?レ옄留??덈뒗 寃쎌슦 ?쇳몴 ?쒓굅 ???⑥쐞 異붽?
                // ?뚯닔?먯씠 ?ы븿??寃쎌슦(?? 30000.00) ?뺤닔 遺遺꾨쭔 異붿텧
                $numericPart = str_replace(',', '', preg_replace('/[^0-9.]/', '', $inputValue));
                // ?뚯닔???쒓굅 (?뺤닔濡?蹂?? - intval ?ъ슜
                $numericValue = intval($numericPart);
                $unit = $productData['monthly_fee_unit'] ?? '??;
                $monthlyFee = $numericValue ? ($numericValue . $unit) : '';
            }
        }
        
        $cashData = $filterArrays(
            $productData['cash_payment_names'] ?? [],
            $processPrices($productData['cash_payment_prices'] ?? [], $productData['cash_payment_price_units'] ?? [])
        );
        $giftCardData = $filterArrays(
            $productData['gift_card_names'] ?? [],
            $processPrices($productData['gift_card_prices'] ?? [], $productData['gift_card_price_units'] ?? [])
        );
        // ?λ퉬 諛??ㅼ튂 媛寃⑹? ?띿뒪??洹몃?濡????(?レ옄 蹂???놁씠, ?욌뮘 怨듬갚留??쒓굅)
        // 鍮?媛??꾪꽣留? ?대쫫??鍮꾩뼱?덉쑝硫??대떦 ??ぉ ?쒓굅
        $equipmentNames = $productData['equipment_names'] ?? [];
        $equipmentPrices = $productData['equipment_prices'] ?? [];
        $filteredEquipment = [];
        foreach ($equipmentNames as $index => $name) {
            $trimmedName = is_string($name) ? trim($name) : '';
            // ?대쫫??鍮꾩뼱?덉? ?딆쑝硫??ы븿 (媛寃⑹? 鍮꾩뼱?덉뼱????
            if (!empty($trimmedName)) {
                $filteredEquipment['names'][] = $trimmedName;
                $filteredEquipment['prices'][] = isset($equipmentPrices[$index]) ? (is_string($equipmentPrices[$index]) ? trim($equipmentPrices[$index]) : (string)$equipmentPrices[$index]) : '';
            }
        }
        
        $installationNames = $productData['installation_names'] ?? [];
        $installationPrices = $productData['installation_prices'] ?? [];
        $filteredInstallation = [];
        foreach ($installationNames as $index => $name) {
            $trimmedName = is_string($name) ? trim($name) : '';
            // ?대쫫??鍮꾩뼱?덉? ?딆쑝硫??ы븿 (媛寃⑹? 鍮꾩뼱?덉뼱????
            if (!empty($trimmedName)) {
                $filteredInstallation['names'][] = $trimmedName;
                $filteredInstallation['prices'][] = isset($installationPrices[$index]) ? (is_string($installationPrices[$index]) ? trim($installationPrices[$index]) : (string)$installationPrices[$index]) : '';
            }
        }
        
        // ?꾨뱶紐??뺣━ ?곸슜
        $equipmentData = $filterArrays(
            $filteredEquipment['names'] ?? [],
            $filteredEquipment['prices'] ?? []
        );
        $installationData = $filterArrays(
            $filteredInstallation['names'] ?? [],
            $filteredInstallation['prices'] ?? []
        );
        
        // ?꾨줈紐⑥뀡 ?곗씠??泥섎━
        $promotionTitle = isset($productData['promotion_title']) ? trim($productData['promotion_title']) : '';
        $promotions = isset($productData['promotions']) && is_array($productData['promotions']) ? $productData['promotions'] : [];
        // 鍮???ぉ ?쒓굅
        $promotions = array_filter(array_map('trim', $promotions), function($item) {
            return !empty($item);
        });
        $promotions = array_values($promotions); // ?몃뜳???ъ젙??        
        // ?곸꽭 ?뺣낫 ????낅뜲?댄듃
        $detailExists = false;
        if ($isEditMode) {
            $checkStmt = $pdo->prepare("SELECT COUNT(*) FROM product_internet_details WHERE product_id = :product_id");
            $checkStmt->execute([':product_id' => $productId]);
            $detailExists = $checkStmt->fetchColumn() > 0;
        }
        
        // service_type 泥섎━ (?명꽣?? ?명꽣??TV, ?명꽣??TV+?몃뱶??
        $serviceType = '?명꽣??; // 湲곕낯媛?        if (!empty($productData['service_type']) && in_array($productData['service_type'], ['?명꽣??, '?명꽣??TV', '?명꽣??TV+?몃뱶??])) {
            $serviceType = $productData['service_type'];
        }
        
        if ($isEditMode && $detailExists) {
            $stmt = $pdo->prepare("
                UPDATE product_internet_details SET
                    registration_place = :registration_place,
                    service_type = :service_type,
                    speed_option = :speed_option,
                    monthly_fee = :monthly_fee,
                    cash_payment_names = :cash_payment_names,
                    cash_payment_prices = :cash_payment_prices,
                    gift_card_names = :gift_card_names,
                    gift_card_prices = :gift_card_prices,
                    equipment_names = :equipment_names,
                    equipment_prices = :equipment_prices,
                    installation_names = :installation_names,
                    installation_prices = :installation_prices,
                    promotion_title = :promotion_title,
                    promotions = :promotions
                WHERE product_id = :product_id
            ");
        } else {
            $stmt = $pdo->prepare("
                INSERT INTO product_internet_details (
                    product_id, registration_place, service_type, speed_option, monthly_fee,
                    cash_payment_names, cash_payment_prices,
                    gift_card_names, gift_card_prices,
                    equipment_names, equipment_prices,
                    installation_names, installation_prices,
                    promotion_title, promotions
                ) VALUES (
                    :product_id, :registration_place, :service_type, :speed_option, :monthly_fee,
                    :cash_payment_names, :cash_payment_prices,
                    :gift_card_names, :gift_card_prices,
                    :equipment_names, :equipment_prices,
                    :installation_names, :installation_prices,
                    :promotion_title, :promotions
                )
            ");
        }
        
        // 紐⑤뱺 媛寃?媛믪? ?띿뒪???뺤떇?쇰줈 ???(?낅젰??媛?洹몃?濡? ?뚯닔???놁씠)
        // DECIMAL 而щ읆????λ맆 ???レ옄濡?蹂?섎릺吏 ?딅룄濡??뺤떎??臾몄옄?대줈 蹂댁옣
        $monthlyFeeValue = (string)$monthlyFee; // 紐낆떆?곸쑝濡?臾몄옄?대줈 蹂??        // 鍮?臾몄옄?댁씠 ?꾨땶 寃쎌슦?먮쭔 泥섎━ (鍮?臾몄옄?댁? 洹몃?濡??좎?)
        if ($monthlyFeeValue !== '' && !preg_match('/[媛-??/', $monthlyFeeValue)) {
            // ?⑥쐞媛 ?놁쑝硫?異붽?
            $monthlyFeeValue = $monthlyFeeValue . '??;
        }
        
        // 媛寃?諛곗뿴??紐⑤몢 ?띿뒪???뺤떇?쇰줈 蹂댁옣
        $cashPricesText = array_map(function($price) {
            return (string)$price; // ?띿뒪?몃줈 蹂??        }, $cashData['prices'] ?? []);
        
        $giftCardPricesText = array_map(function($price) {
            return (string)$price; // ?띿뒪?몃줈 蹂??        }, $giftCardData['prices'] ?? []);
        
        $equipmentPricesText = array_map(function($price) {
            return (string)$price; // ?띿뒪?몃줈 蹂??        }, $equipmentData['prices'] ?? []);
        
        $installationPricesText = array_map(function($price) {
            return (string)$price; // ?띿뒪?몃줈 蹂??        }, $installationData['prices'] ?? []);
        
        $executeParams = [
            ':product_id' => $productId,
            ':registration_place' => $productData['registration_place'] ?? '',
            ':service_type' => $serviceType, // ?명꽣???먮뒗 ?명꽣??TV
            ':speed_option' => $productData['speed_option'] ?? null,
            ':monthly_fee' => $monthlyFeeValue, // ?띿뒪???뺤떇?쇰줈 ???(?? "3250??)
            ':cash_payment_names' => json_encode($cashData['names'] ?? [], JSON_UNESCAPED_UNICODE),
            ':cash_payment_prices' => json_encode($cashPricesText, JSON_UNESCAPED_UNICODE), // ?띿뒪??諛곗뿴 (?? ["50000??, "36500??])
            ':gift_card_names' => json_encode($giftCardData['names'] ?? [], JSON_UNESCAPED_UNICODE),
            ':gift_card_prices' => json_encode($giftCardPricesText, JSON_UNESCAPED_UNICODE), // ?띿뒪??諛곗뿴 (?? ["150000??, "15400??])
            ':equipment_names' => json_encode($equipmentData['names'] ?? [], JSON_UNESCAPED_UNICODE),
            ':equipment_prices' => json_encode($equipmentPricesText, JSON_UNESCAPED_UNICODE), // ?띿뒪??諛곗뿴 (?? ["10000??, "臾대즺"])
            ':installation_names' => json_encode($installationData['names'] ?? [], JSON_UNESCAPED_UNICODE),
            ':installation_prices' => json_encode($installationPricesText, JSON_UNESCAPED_UNICODE), // ?띿뒪??諛곗뿴 (?? ["臾대즺", "?ㅼ튂鍮?])
            ':promotion_title' => $promotionTitle,
            ':promotions' => json_encode($promotions, JSON_UNESCAPED_UNICODE)
        ];
        
        // ?붾쾭源? ?ㅽ뻾 ?뚮씪誘명꽣 濡쒓렇
        error_log("Executing SQL with params - service_type: " . $serviceType . ", product_id: " . $productId);
        
        try {
            $stmt->execute($executeParams);
            $pdo->commit();
            return $productId;
        } catch (PDOException $executeError) {
            $pdo->rollBack();
            $errorMsg = "SQL ?ㅽ뻾 ?ㅻ쪟: " . $executeError->getMessage();
            $errorMsg .= "\nSQL State: " . $executeError->getCode();
            $errorMsg .= "\nError Info: " . json_encode($pdo->errorInfo() ?? []);
            $errorMsg .= "\nService Type: " . $serviceType;
            $errorMsg .= "\nProduct ID: " . $productId;
            error_log($errorMsg);
            
            global $lastDbError;
            $lastDbError = $errorMsg;
            throw $executeError;
        }
    } catch (PDOException $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        $errorMsg = "Error saving Internet product: " . $e->getMessage();
        $errorMsg .= "\nSQL State: " . $e->getCode();
        $errorMsg .= "\nError Info: " . json_encode($pdo->errorInfo() ?? []);
        $errorMsg .= "\nStack trace: " . $e->getTraceAsString();
        error_log($errorMsg);
        
        global $lastDbError;
        $lastDbError = "PDO ?ㅻ쪟: " . $e->getMessage();
        
        return false;
    } catch (Exception $e) {
        if (isset($pdo)) {
            $pdo->rollBack();
        }
        error_log("Unexpected error saving Internet product: " . $e->getMessage());
        
        global $lastDbError;
        $lastDbError = "?덉쇅 諛쒖깮: " . $e->getMessage();
        
        return false;
    }
}

/**
 * 由щ럭 異붽? (MVNO, MNO, Internet)
 * @param int $productId ?곹뭹 ID
 * @param string $userId ?ъ슜??ID
 * @param string $productType ?곹뭹 ???('mvno', 'mno', 'internet')
 * @param int $rating 蹂꾩젏 (1-5)
 * @param string $content 由щ럭 ?댁슜
 * @param string $title 由щ럭 ?쒕ぉ (?좏깮)
 * @param int|null $kindnessRating 移쒖젅?댁슂 蹂꾩젏 (?명꽣??由щ럭?? ?좏깮)
 * @param int|null $speedRating ?ㅼ튂 鍮⑤씪??蹂꾩젏 (?명꽣??由щ럭?? ?좏깮)
 * @param int|null $applicationId ?좎껌 ID (application蹂?由щ럭 援щ텇?? ?좏깮)
 * @return int|false 由щ럭 ID ?먮뒗 false
 */
/**
 * 由щ럭 ?듦퀎 ?뚯씠釉??낅뜲?댄듃
 * 
 * 泥섏쓬 ?묒꽦??由щ럭???먯닔留??듦퀎 ?뚯씠釉붿뿉 異붽??? * 由щ럭 ?섏젙/??젣 ?쒖뿉???듦퀎 ?뚯씠釉붿씠 蹂寃쎈릺吏 ?딆쓬
 * 
 * @param int $productId ?곹뭹 ID
 * @param float $rating ?됱젏
 * @param float|null $kindnessRating 移쒖젅?댁슂 ?됱젏 (?좏깮)
 * @param float|null $speedRating ?ㅼ튂/媛쒗넻 鍮⑤씪???됱젏 (?좏깮)
 */
/**
 * 由щ럭 ?듦퀎 ?낅뜲?댄듃 (?섏씠釉뚮━??諛⑹떇)
 * 泥섏쓬 ?묒꽦 ?쒖젏 媛?initial_*)怨??ㅼ떆媛??듦퀎 紐⑤몢 ?낅뜲?댄듃
 * @param int $productId ?곹뭹 ID
 * @param int $rating ?됱젏
 * @param int|null $kindnessRating 移쒖젅?댁슂 ?됱젏
 * @param int|null $speedRating 媛쒗넻/?ㅼ튂 鍮⑤씪???됱젏
 */
/**
 * 由щ럭 ?듦퀎 ?낅뜲?댄듃 (?꾩껜 由щ럭 ?ш퀎??諛⑹떇)
 * ??긽 紐⑤뱺 approved 由щ럭瑜??ㅼ떆 怨꾩궛?섏뿬 ?듦퀎瑜??낅뜲?댄듃?⑸땲??
 * ?됯퇏 = ?꾩껜 由щ럭 ?섏뿉 ???珥앺빀怨꾩쓽 ?됯퇏
 * 
 * @param int $productId ?곹뭹 ID
 * @param string|null $productType ?곹뭹 ???(?좏깮, ?놁쑝硫?product_reviews?먯꽌 議고쉶)
 */
function updateReviewStatistics($productId, $rating = null, $kindnessRating = null, $speedRating = null, $productType = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return;
    }
    
    try {
        // ?몃옖??뀡 ?쒖옉 (?숈떆??臾몄젣 諛⑹?)
        $pdo->beginTransaction();
        
        // productType???놁쑝硫?product_reviews?먯꽌 議고쉶
        if ($productType === null) {
            $typeStmt = $pdo->prepare("
                SELECT DISTINCT product_type 
                FROM product_reviews 
                WHERE product_id = :product_id 
                AND status = 'approved'
                LIMIT 1
            ");
            $typeStmt->execute([':product_id' => $productId]);
            $typeResult = $typeStmt->fetch(PDO::FETCH_ASSOC);
            $productType = $typeResult['product_type'] ?? 'mvno';
        }
        
        // 紐⑤뱺 approved 由щ럭瑜??ㅼ떆 怨꾩궛?섏뿬 ?듦퀎 ?낅뜲?댄듃
        // ?됯퇏 = ?꾩껜 由щ럭 ?섏뿉 ???珥앺빀怨꾩쓽 ?됯퇏
        $allReviewsStmt = $pdo->prepare("
            SELECT 
                rating,
                kindness_rating,
                speed_rating
            FROM product_reviews
            WHERE product_id = :product_id
            AND product_type = :product_type
            AND status = 'approved'
        ");
        $allReviewsStmt->execute([
            ':product_id' => $productId,
            ':product_type' => $productType
        ]);
        $allReviews = $allReviewsStmt->fetchAll(PDO::FETCH_ASSOC);
        
        // ?듦퀎 ?ш퀎??        $totalRatingSum = 0;
        $reviewCount = count($allReviews);
        $kindnessSum = 0;
        $kindnessCount = 0;
        $speedSum = 0;
        $speedCount = 0;
        
        foreach ($allReviews as $review) {
            $totalRatingSum += (int)$review['rating'];
            if ($review['kindness_rating'] !== null) {
                $kindnessSum += (int)$review['kindness_rating'];
                $kindnessCount++;
            }
            if ($review['speed_rating'] !== null) {
                $speedSum += (int)$review['speed_rating'];
                $speedCount++;
            }
        }
        
        // ?듦퀎 ?뚯씠釉??낅뜲?댄듃 (?꾩껜 ?ш퀎??
        $updateStmt = $pdo->prepare("
            INSERT INTO product_review_statistics (
                product_id,
                total_rating_sum,
                total_review_count,
                kindness_rating_sum,
                kindness_review_count,
                speed_rating_sum,
                speed_review_count,
                updated_at
            ) VALUES (
                :product_id,
                :total_rating_sum,
                :total_review_count,
                :kindness_rating_sum,
                :kindness_review_count,
                :speed_rating_sum,
                :speed_review_count,
                NOW()
            )
            ON DUPLICATE KEY UPDATE
                total_rating_sum = :total_rating_sum2,
                total_review_count = :total_review_count2,
                kindness_rating_sum = :kindness_rating_sum2,
                kindness_review_count = :kindness_review_count2,
                speed_rating_sum = :speed_rating_sum2,
                speed_review_count = :speed_review_count2,
                updated_at = NOW()
        ");
        
        $updateStmt->execute([
            ':product_id' => $productId,
            ':total_rating_sum' => $totalRatingSum,
            ':total_review_count' => $reviewCount,
            ':kindness_rating_sum' => $kindnessSum,
            ':kindness_review_count' => $kindnessCount,
            ':speed_rating_sum' => $speedSum,
            ':speed_review_count' => $speedCount,
            ':total_rating_sum2' => $totalRatingSum,
            ':total_review_count2' => $reviewCount,
            ':kindness_rating_sum2' => $kindnessSum,
            ':kindness_review_count2' => $kindnessCount,
            ':speed_rating_sum2' => $speedSum,
            ':speed_review_count2' => $speedCount
        ]);
        
        // ?몃옖??뀡 而ㅻ컠
        $pdo->commit();
        
        error_log("updateReviewStatistics: ?듦퀎 ?ш퀎???꾨즺 - product_id={$productId}, count={$reviewCount}, sum={$totalRatingSum}");
    } catch (PDOException $e) {
        // ?몃옖??뀡 濡ㅻ갚
        if ($pdo->inTransaction()) {
            $pdo->rollBack();
        }
        // ?듦퀎 ?뚯씠釉??낅뜲?댄듃 ?ㅽ뙣??移섎챸?곸씠吏 ?딆쑝誘濡?濡쒓렇留??④?
        error_log("updateReviewStatistics: ?듦퀎 ?낅뜲?댄듃 ?ㅽ뙣 - " . $e->getMessage());
    }
}

/**
 * ?곹뭹 由щ럭 異붽? (?섏씠釉뚮━??諛⑹떇)
 * 
 * 泥섏쓬 ?묒꽦??由щ럭???먯닔???듦퀎 ?뚯씠釉?product_review_statistics)??異붽??? * - ?ㅼ떆媛??듦퀎: ?붾㈃ ?쒖떆??(?섏젙/??젣 ???낅뜲?댄듃)
 * - 泥섏쓬 ?묒꽦 ?쒖젏 ?듦퀎: 怨좎젙媛?(?섏젙/??젣 ??蹂寃?????
 * 
 * ??젣 ???ㅼ떆 ?묒꽦??寃쎌슦 ?듦퀎 ?뚯씠釉붿뿉 異붽??섏? ?딆쓬 (泥섏쓬 ?묒꽦???먯닔 ?좎?)
 * ?ㅻⅨ 二쇰Ц嫄?application_id)??由щ럭???듦퀎??諛섏쁺?? * 
 * @param int $productId ?곹뭹 ID
 * @param string $userId ?ъ슜??ID
 * @param string $productType ?곹뭹 ???('mvno', 'mno', 'internet')
 * @param int $rating ?됱젏
 * @param string $content 由щ럭 ?댁슜
 * @param string|null $title 由щ럭 ?쒕ぉ (?좏깮)
 * @param int|null $kindnessRating 移쒖젅?댁슂 ?됱젏 (?좏깮)
 * @param int|null $speedRating ?ㅼ튂/媛쒗넻 鍮⑤씪???됱젏 (?좏깮)
 * @param int|null $applicationId ?좎껌 ID (二쇰Ц蹂?由щ럭 援щ텇?? ?좏깮)
 * @return int|false 由щ럭 ID (?깃났 ?? ?먮뒗 false (?ㅽ뙣 ??
 */
function addProductReview($productId, $userId, $productType, $rating, $content, $title = null, $kindnessRating = null, $speedRating = null, $applicationId = null) {
    if (!in_array($productType, ['mvno', 'mno', 'internet', 'mno-sim'])) {
        return false;
    }
    
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    try {
        // application_id 而щ읆 議댁옱 ?щ? ?뺤씤 (以묐났 泥댄겕 ?꾩뿉 ?뺤씤 ?꾩슂)
        $hasApplicationId = false;
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
            $hasApplicationId = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {
            // 而щ읆???놁쑝硫?false
        }
        
        // 以묐났 由щ럭 泥댄겕 ?쒓굅: 二쇰Ц嫄대퀎濡??щ윭 由щ럭 ?묒꽦 媛??        // 媛숈? ?곹뭹??????щ윭 二쇰Ц嫄?application_id)?쇰줈 由щ럭瑜??묒꽦?????덉쓬
        // 媛숈? 二쇰Ц嫄?application_id)????댁꽌???щ윭 由щ럭 ?묒꽦 媛??(?붽뎄?ы빆???곕씪)
        // 以묐났 泥댄겕 ?놁씠 ??긽 由щ럭 ?묒꽦 ?덉슜
        
        // ?명꽣?룰낵 MVNO, MNO-SIM 由щ럭???먮룞?쇰줈 ?뱀씤, MNO??pending ?곹깭濡????        $status = ($productType === 'mno') ? 'pending' : 'approved';
        
        // ?명꽣??MVNO/MNO/MNO-SIM 由щ럭??寃쎌슦 kindness_rating怨?speed_rating?쇰줈 rating 怨꾩궛
        if (in_array($productType, ['internet', 'mvno', 'mno', 'mno-sim']) && $kindnessRating !== null && $speedRating !== null) {
            $rating = round(($kindnessRating + $speedRating) / 2);
        }
        
        // kindness_rating, speed_rating 而щ읆 議댁옱 ?щ? ?뺤씤
        $hasKindnessRating = false;
        $hasSpeedRating = false;
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'kindness_rating'");
            $hasKindnessRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'speed_rating'");
            $hasSpeedRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        
        // ?숈쟻?쇰줈 INSERT 荑쇰━ ?앹꽦
        $columns = ['product_id', 'user_id', 'product_type', 'rating', 'title', 'content', 'status'];
        $values = [':product_id', ':user_id', ':product_type', ':rating', ':title', ':content', ':status'];
        $executeParams = [
            ':product_id' => $productId,
            ':user_id' => $userId,
            ':product_type' => $productType,
            ':rating' => $rating,
            ':title' => $title,
            ':content' => $content,
            ':status' => $status
        ];
        
        if ($hasApplicationId && $applicationId !== null) {
            $columns[] = 'application_id';
            $values[] = ':application_id';
            $executeParams[':application_id'] = $applicationId;
        }
        
        if ($hasKindnessRating && $hasSpeedRating && $kindnessRating !== null && $speedRating !== null) {
            $columns[] = 'kindness_rating';
            $columns[] = 'speed_rating';
            $values[] = ':kindness_rating';
            $values[] = ':speed_rating';
            $executeParams[':kindness_rating'] = $kindnessRating;
            $executeParams[':speed_rating'] = $speedRating;
        }
        
        $columnsStr = implode(', ', $columns);
        $valuesStr = implode(', ', $values);
        
        $stmt = $pdo->prepare("
            INSERT INTO product_reviews ($columnsStr)
            VALUES ($valuesStr)
        ");
        
        $stmt->execute($executeParams);
        $newId = $pdo->lastInsertId();
        
        // ?듦퀎 ?낅뜲?댄듃???몃━嫄?trg_update_review_statistics_on_insert)媛 ?먮룞?쇰줈 泥섎━
        // ?몃━嫄곌? approved ?곹깭??由щ럭留??듦퀎???먮룞 異붽??섏뿬 ?듦퀎 ?낅뜲?댄듃
        
        return $newId;
    } catch (PDOException $e) {
        error_log("addProductReview: PDO ?덉쇅 諛쒖깮 - " . $e->getMessage());
        // ?곗씠?곕쿋?댁뒪 ?ㅽ궎留??ㅻ쪟??寃쎌슦
        if (strpos($e->getMessage(), 'product_type') !== false || strpos($e->getMessage(), 'ENUM') !== false) {
            error_log("Database schema error: product_reviews.product_type ENUM may not include 'internet'");
        }
        return false;
    }
}

/**
 * ?ъ슜?먯쓽 湲곗〈 由щ럭 媛?몄삤湲? * @param int $productId ?곹뭹 ID
 * @param string $userId ?ъ슜??ID
 * @param string $productType ?곹뭹 ???('mvno', 'mno', 'internet')
 * @param int|null $applicationId ?좎껌 ID (application蹂?由щ럭 援щ텇?? ?좏깮)
 * @return array|false 由щ럭 ?곗씠???먮뒗 false
 */
function getUserReview($productId, $userId, $productType, $applicationId = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        error_log("getUserReview: Database connection failed");
        return false;
    }
    
    try {
        // application_id 而щ읆 議댁옱 ?щ? ?뺤씤
        $hasApplicationId = false;
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
            $hasApplicationId = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {
            // 而щ읆???놁쑝硫?false
        }
        
        // kindness_rating, speed_rating 而щ읆 議댁옱 ?щ? ?뺤씤
        $hasKindnessRating = false;
        $hasSpeedRating = false;
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'kindness_rating'");
            $hasKindnessRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'speed_rating'");
            $hasSpeedRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        
        // SELECT ?꾨뱶 ?숈쟻 ?앹꽦
        $selectFields = "id, product_id, user_id, product_type, rating, title, content, status, created_at, updated_at";
        if ($hasApplicationId) {
            $selectFields = str_replace("product_id,", "product_id, application_id,", $selectFields);
        }
        if ($hasKindnessRating && $hasSpeedRating) {
            $selectFields = "id, product_id, " . ($hasApplicationId ? "application_id, " : "") . "user_id, product_type, rating, kindness_rating, speed_rating, title, content, status, created_at, updated_at";
        } elseif ($hasKindnessRating) {
            $selectFields = "id, product_id, " . ($hasApplicationId ? "application_id, " : "") . "user_id, product_type, rating, kindness_rating, title, content, status, created_at, updated_at";
        } elseif ($hasSpeedRating) {
            $selectFields = "id, product_id, " . ($hasApplicationId ? "application_id, " : "") . "user_id, product_type, rating, speed_rating, title, content, status, created_at, updated_at";
        }
        
        error_log("getUserReview: Searching for review - product_id=$productId, user_id=$userId, product_type=$productType, application_id=" . ($applicationId ?? 'null'));
        
        // application_id媛 ?덉쑝硫?application_id濡??곗꽑 議고쉶, ?놁쑝硫?product_id濡?議고쉶
        if ($hasApplicationId && $applicationId !== null && $applicationId > 0) {
            $stmt = $pdo->prepare("
                SELECT $selectFields
                FROM product_reviews
                WHERE product_id = :product_id 
                AND user_id = :user_id 
                AND product_type = :product_type
                AND application_id = :application_id
                ORDER BY 
                    CASE WHEN status = 'approved' THEN 0 ELSE 1 END,
                    created_at DESC
                LIMIT 1
            ");
            $stmt->execute([
                ':product_id' => $productId,
                ':user_id' => $userId,
                ':product_type' => $productType,
                ':application_id' => $applicationId
            ]);
        } else {
            $stmt = $pdo->prepare("
                SELECT $selectFields
                FROM product_reviews
                WHERE product_id = :product_id 
                AND user_id = :user_id 
                AND product_type = :product_type
                " . ($hasApplicationId && $applicationId === null ? "AND (application_id IS NULL OR application_id = 0)" : "") . "
                ORDER BY 
                    CASE WHEN status = 'approved' THEN 0 ELSE 1 END,
                    created_at DESC
                LIMIT 1
            ");
            $params = [
                ':product_id' => $productId,
                ':user_id' => $userId,
                ':product_type' => $productType
            ];
            $stmt->execute($params);
        }
        
        $review = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($review) {
            error_log("getUserReview: Review found - id=" . $review['id'] . ", rating=" . ($review['rating'] ?? 'N/A'));
            return $review;
        }
        
        // ?뺥솗??product_id濡?李얠? 紐삵븳 寃쎌슦, 媛숈? ?먮ℓ?먯쓽 媛숈? ????곹뭹 由щ럭 以묒뿉??李얘린
        error_log("getUserReview: No review found for exact product_id=$productId, trying to find in same seller's products");
        
        // ?곹뭹??seller_id 媛?몄삤湲?        $productStmt = $pdo->prepare("
            SELECT seller_id 
            FROM products 
            WHERE id = :product_id 
            AND product_type = :product_type
            LIMIT 1
        ");
        $productStmt->execute([
            ':product_id' => $productId,
            ':product_type' => $productType
        ]);
        $product = $productStmt->fetch(PDO::FETCH_ASSOC);
        
        if ($product && !empty($product['seller_id'])) {
            $sellerId = $product['seller_id'];
            
            // 媛숈? ?먮ℓ?먯쓽 媛숈? ??낆쓽 紐⑤뱺 ?곹뭹 ID 媛?몄삤湲?            $productsStmt = $pdo->prepare("
                SELECT id 
                FROM products 
                WHERE seller_id = :seller_id 
                AND product_type = :product_type
                AND status = 'active'
            ");
            $productsStmt->execute([
                ':seller_id' => $sellerId,
                ':product_type' => $productType
            ]);
            $productIds = $productsStmt->fetchAll(PDO::FETCH_COLUMN);
            
            if (!empty($productIds)) {
                $placeholders = implode(',', array_fill(0, count($productIds), '?'));
                $stmt = $pdo->prepare("
                    SELECT 
                        id,
                        product_id,
                        user_id,
                        product_type,
                        rating,
                        kindness_rating,
                        speed_rating,
                        title,
                        content,
                        status,
                        created_at,
                        updated_at
                    FROM product_reviews
                    WHERE product_id IN ($placeholders)
                    AND user_id = ?
                    AND product_type = ?
                    ORDER BY 
                        CASE WHEN status = 'approved' THEN 0 ELSE 1 END,
                        created_at DESC
                    LIMIT 1
                ");
                $params = array_merge($productIds, [$userId, $productType]);
                $stmt->execute($params);
                $review = $stmt->fetch(PDO::FETCH_ASSOC);
                
                if ($review) {
                    error_log("getUserReview: Review found in same seller's products - id=" . $review['id'] . ", product_id=" . $review['product_id']);
                    return $review;
                }
            }
        }
        
        error_log("getUserReview: No review found for product_id=$productId, user_id=$userId, product_type=$productType");
        
        // ?붾쾭源? ?대떦 議곌굔?쇰줈 由щ럭媛 ?덈뒗吏 ?뺤씤
        $debugStmt = $pdo->prepare("
            SELECT COUNT(*) as count 
            FROM product_reviews 
            WHERE product_id = :product_id AND product_type = :product_type
        ");
        $debugStmt->execute([
            ':product_id' => $productId,
            ':product_type' => $productType
        ]);
        $totalCount = $debugStmt->fetch(PDO::FETCH_ASSOC)['count'] ?? 0;
        
        $debugStmt2 = $pdo->prepare("
            SELECT COUNT(*) as count 
            FROM product_reviews 
            WHERE user_id = :user_id AND product_type = :product_type
        ");
        $debugStmt2->execute([
            ':user_id' => $userId,
            ':product_type' => $productType
        ]);
        $userCount = $debugStmt2->fetch(PDO::FETCH_ASSOC)['count'] ?? 0;
        
        error_log("getUserReview: Debug - Total reviews for product_id=$productId: $totalCount, Total reviews for user_id=$userId: $userCount");
        
        return false;
    } catch (PDOException $e) {
        error_log("Error fetching user review: " . $e->getMessage());
        return false;
    }
}

/**
 * 由щ럭 ?섏젙
 * 
 * ?대떦 由щ럭??蹂꾩젏怨??댁슜? ?섏젙??媛믪쑝濡??낅뜲?댄듃?섏?留?
 * ?듦퀎 ?뚯씠釉?product_review_statistics)? ?낅뜲?댄듃?섏? ?딆쓬
 * 由щ럭 ?섏젙 ??珥앸퀎?먭낵 ??ぉ蹂?珥앸퀎?먯? 蹂寃쎈릺吏 ?딆쓬 (泥섏쓬 ?묒꽦???먯닔 ?좎?)
 * 
 * @param int $reviewId 由щ럭 ID
 * @param string $userId ?ъ슜??ID
 * @param int $rating 蹂꾩젏 (?대떦 由щ럭?먮쭔 諛섏쁺)
 * @param string $content 由щ럭 ?댁슜
 * @param string|null $title 由щ럭 ?쒕ぉ (?좏깮)
 * @param int|null $kindnessRating 移쒖젅?댁슂 蹂꾩젏 (?대떦 由щ럭?먮쭔 諛섏쁺)
 * @param int|null $speedRating ?ㅼ튂/媛쒗넻 鍮⑤씪??蹂꾩젏 (?대떦 由щ럭?먮쭔 諛섏쁺)
 * @return bool ?깃났 ?щ?
 */
/**
 * 由щ럭 ?섏젙 (?섏씠釉뚮━??諛⑹떇)
 * 
 * 媛쒕퀎 由щ럭??蹂꾩젏怨??댁슜???낅뜲?댄듃?섍퀬, ?ㅼ떆媛??듦퀎留??낅뜲?댄듃
 * 泥섏쓬 ?묒꽦 ?쒖젏 ?듦퀎(initial_*)??蹂寃쏀븯吏 ?딆쓬
 * 
 * @param int $reviewId 由щ럭 ID
 * @param string $userId ?ъ슜??ID
 * @param int $rating ?됱젏
 * @param string $content 由щ럭 ?댁슜
 * @param string|null $title 由щ럭 ?쒕ぉ
 * @param int|null $kindnessRating 移쒖젅?댁슂 ?됱젏
 * @param int|null $speedRating 媛쒗넻/?ㅼ튂 鍮⑤씪???됱젏
 * @return bool ?깃났 ?щ?
 */
function updateProductReview($reviewId, $userId, $rating, $content, $title = null, $kindnessRating = null, $speedRating = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    try {
        // 由щ럭 ?뚯쑀沅??뺤씤 諛?product_type ?뺤씤
        $checkStmt = $pdo->prepare("
            SELECT id, user_id, product_type, product_id, rating as old_rating, kindness_rating as old_kindness_rating, speed_rating as old_speed_rating
            FROM product_reviews 
            WHERE id = :review_id AND user_id = :user_id
        ");
        $checkStmt->execute([
            ':review_id' => $reviewId,
            ':user_id' => $userId
        ]);
        $review = $checkStmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$review) {
            error_log("DEBUG updateProductReview: 由щ럭瑜?李얠쓣 ???놁쓬 - review_id=$reviewId, user_id=$userId");
            return false;
        }
        
        $productId = $review['product_id'];
        
        // 而щ읆 議댁옱 ?щ? ?뺤씤
        $hasKindnessRating = false;
        $hasSpeedRating = false;
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'kindness_rating'");
            $hasKindnessRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        
        try {
            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'speed_rating'");
            $hasSpeedRating = $checkStmt->rowCount() > 0;
        } catch (PDOException $e) {}
        
        // ?명꽣??MVNO/MNO/MNO-SIM 由щ럭??寃쎌슦 kindness_rating怨?speed_rating?쇰줈 rating 怨꾩궛
        if (in_array($review['product_type'], ['internet', 'mvno', 'mno', 'mno-sim']) && $kindnessRating !== null && $speedRating !== null) {
            $rating = round(($kindnessRating + $speedRating) / 2);
        }
        
        // 由щ럭 ?뺣낫 ?낅뜲?댄듃 (蹂꾩젏怨??댁슜留??섏젙)
        if ($hasKindnessRating && $hasSpeedRating && $kindnessRating !== null && $speedRating !== null) {
            $stmt = $pdo->prepare("
                UPDATE product_reviews
                SET rating = :rating,
                    kindness_rating = :kindness_rating,
                    speed_rating = :speed_rating,
                    content = :content,
                    title = :title,
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = :review_id
                AND user_id = :user_id
            ");
            $stmt->execute([
                ':review_id' => $reviewId,
                ':user_id' => $userId,
                ':rating' => $rating,
                ':kindness_rating' => $kindnessRating,
                ':speed_rating' => $speedRating,
                ':content' => $content,
                ':title' => $title
            ]);
        } else {
            $stmt = $pdo->prepare("
                UPDATE product_reviews
                SET rating = :rating,
                    content = :content,
                    title = :title,
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = :review_id
                AND user_id = :user_id
            ");
            $stmt->execute([
                ':review_id' => $reviewId,
                ':user_id' => $userId,
                ':rating' => $rating,
                ':content' => $content,
                ':title' => $title
            ]);
        }
        
        // ?듦퀎 ?낅뜲?댄듃???몃━嫄?trg_update_review_statistics_on_update)媛 ?먮룞?쇰줈 泥섎━
        // ?몃━嫄곌? 湲곗〈 由щ럭 ?듦퀎瑜??쒓굅?섍퀬 ??由щ럭 ?듦퀎瑜?異붽??섏뿬 ?먮룞 ?낅뜲?댄듃
        // ?몃━嫄곌? ?묐룞?섏? ?딆쓣 寃쎌슦瑜??鍮꾪빐 ?섎룞 ?낅뜲?댄듃???쒕룄
        try {
            updateReviewStatistics($productId, $rating, $kindnessRating, $speedRating, $review['product_type']);
        } catch (Exception $e) {
            // ?듦퀎 ?낅뜲?댄듃 ?ㅽ뙣??移섎챸?곸씠吏 ?딆쑝誘濡?濡쒓렇留??④?
            error_log("updateProductReview: ?듦퀎 ?섎룞 ?낅뜲?댄듃 ?ㅽ뙣 (?몃━嫄곌? 泥섎━?????덉쓬) - " . $e->getMessage());
        }
        
        return true;
    } catch (PDOException $e) {
        error_log("Error updating review: " . $e->getMessage());
        return false;
    }
}

/**
 * 李?異붽?/??젣
 * @param int $productId ?곹뭹 ID
 * @param int $userId ?ъ슜??ID
 * @param string $productType ?곹뭹 ??? * @param bool $isFavorite 李?異붽?(true) ?먮뒗 ??젣(false)
 * @return bool
 */
/**
 * 李?異붽?/??젣 (MVNO, MNO留?
 * @param int $productId ?곹뭹 ID
 * @param int $userId ?ъ슜??ID
 * @param string $productType ?곹뭹 ???(mvno, mno)
 * @param bool $isFavorite 李?異붽?(true) ?먮뒗 ??젣(false)
 * @return bool
 */
function toggleProductFavorite($productId, $userId, $productType, $isFavorite = true) {
    // ?명꽣???곹뭹? 李?遺덇?
    if ($productType === 'internet') {
        return false;
    }
    
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    try {
        $pdo->beginTransaction();
        
        // 癒쇱? products ?뚯씠釉붿뿉 ?대떦 ?곹뭹??議댁옱?섎뒗吏 ?뺤씤
        $productIdInt = (int)$productId;
        $checkStmt = $pdo->prepare("
            SELECT id, product_type FROM products 
            WHERE id = ?
        ");
        $checkStmt->execute([$productIdInt]);
        $product = $checkStmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$product) {
            error_log("toggleProductFavorite: Product not found - product_id=$productId");
            $pdo->rollBack();
            return false;
        }
        
        // product_type ?쇱튂 ?뺤씤
        if ($product['product_type'] !== $productType) {
            error_log("toggleProductFavorite: Product type mismatch - product_id=$productId, expected=$productType, actual={$product['product_type']}");
            $pdo->rollBack();
            return false;
        }
        
        // user_id??users.user_id(VARCHAR) 湲곕컲?쇰줈 ???議고쉶 (DB-only ?뺥빀??
        $userIdStr = (string)$userId;
        
        if ($isFavorite) {
            // 李?異붽?
            $stmt = $pdo->prepare("
                INSERT INTO product_favorites (product_id, user_id, product_type)
                VALUES (?, ?, ?)
                ON DUPLICATE KEY UPDATE created_at = CURRENT_TIMESTAMP
            ");
            $stmt->execute([$productIdInt, $userIdStr, $productType]);
        } else {
            // 李???젣
            $stmt = $pdo->prepare("
                DELETE FROM product_favorites
                WHERE product_id = :product_id AND user_id = :user_id
            ");
            $stmt->bindValue(':product_id', $productIdInt, PDO::PARAM_INT);
            $stmt->bindValue(':user_id', $userIdStr, PDO::PARAM_STR);
            $stmt->execute();
        }
        
        // favorite_count ?섎룞 ?낅뜲?댄듃 (?몃━嫄곌? ?놁뼱???묐룞?섎룄濡?
        $updateStmt = $pdo->prepare("
            UPDATE products 
            SET favorite_count = (
                SELECT COUNT(*) FROM product_favorites 
                WHERE product_id = ?
            )
            WHERE id = ?
        ");
        $updateStmt->execute([$productIdInt, $productIdInt]);
        
        $pdo->commit();
        return true;
    } catch (PDOException $e) {
        if ($pdo->inTransaction()) {
            $pdo->rollBack();
        }
        error_log("Error toggling favorite: product_id=$productId, user_id=$userId, product_type=$productType, isFavorite=$isFavorite, error=" . $e->getMessage());
        error_log("SQL Error Code: " . $e->getCode() . ", SQL State: " . $e->errorInfo[0] ?? 'N/A');
        error_log("Error Info: " . print_r($e->errorInfo, true));
        return false;
    }
}

/**
 * 怨듭쑀 湲곕줉 異붽?
 * @param int $productId ?곹뭹 ID
 * @param string $productType ?곹뭹 ??? * @param string $shareMethod 怨듭쑀 諛⑸쾿
 * @param int|null $userId ?ъ슜??ID (鍮꾪쉶??媛??
 * @param string|null $ipAddress IP 二쇱냼
 * @return bool
 */
function addProductShare($productId, $productType, $shareMethod, $userId = null, $ipAddress = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    try {
        $stmt = $pdo->prepare("
            INSERT INTO product_shares (product_id, user_id, product_type, share_method, ip_address, user_agent)
            VALUES (:product_id, :user_id, :product_type, :share_method, :ip_address, :user_agent)
        ");
        $stmt->execute([
            ':product_id' => $productId,
            ':user_id' => $userId,
            ':product_type' => $productType,
            ':share_method' => $shareMethod,
            ':ip_address' => $ipAddress ?? $_SERVER['REMOTE_ADDR'] ?? null,
            ':user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null
        ]);
        
        return true;
    } catch (PDOException $e) {
        error_log("Error adding share: " . $e->getMessage());
        return false;
    }
}

/**
 * 二쇰Ц踰덊샇 ?앹꽦 (?쇳븨紐??쇰컲 ?뺤떇)
 * ?뺤떇: YYMMDDHH-0001 (?? 25121519-0001) - 珥?12?먮━
 * 媛숈? ?쒓컙(???⑥쐞)???щ윭 二쇰Ц???덉쓣 寃쎌슦 ?쒕쾲 利앷?
 * ?숈떆??臾몄젣瑜?諛⑹??섍린 ?꾪빐 ?몃옖??뀡 ?댁뿉???몄텧?섏뼱???? * @param PDO $pdo ?곗씠?곕쿋?댁뒪 ?곌껐 (?몃옖??뀡 ?댁뿉??
 * @param DateTime $dateTime 二쇰Ц ?쒓컙
 * @param int $maxRetries 理쒕? ?ъ떆???잛닔 (以묐났 諛⑹?)
 * @return string 二쇰Ц踰덊샇
 */
function generateOrderNumber($pdo, $dateTime = null, $maxRetries = 10) {
    if ($dateTime === null) {
        $dateTime = new DateTime('now', new DateTimeZone('Asia/Seoul'));
    }
    
    $attempt = 0;
    while ($attempt < $maxRetries) {
        // ?꾩썡???쒓컙 (YYMMDDHH) - 8?먮━
        $timePrefix = $dateTime->format('ymdH');
        
        // 媛숈? ?쒓컙(?????앹꽦??二쇰Ц ???뺤씤
        // FOR UPDATE瑜??ъ슜?섏뿬 ?숈떆??臾몄젣 諛⑹? (?몃옖??뀡 ?댁뿉?쒕쭔 ?묐룞)
        $startOfHour = $dateTime->format('Y-m-d H:00:00');
        $endOfHour = $dateTime->format('Y-m-d H:59:59');
        
        // 二쇰Ц踰덊샇媛 ?대? 議댁옱?섎뒗吏 ?뺤씤 (FOR UPDATE濡???
        $stmt = $pdo->prepare("
            SELECT COUNT(*) as count 
            FROM product_applications 
            WHERE created_at >= :start_time 
            AND created_at <= :end_time
            AND order_number LIKE :prefix
            FOR UPDATE
        ");
        $stmt->execute([
            ':start_time' => $startOfHour,
            ':end_time' => $endOfHour,
            ':prefix' => $timePrefix . '-%'
        ]);
        $result = $stmt->fetch(PDO::FETCH_ASSOC);
        $existingCount = $result['count'] ?? 0;
        
        // ?쒕쾲 ?앹꽦 (湲곗〈 二쇰Ц ??+ 1)
        $sequenceNumber = $existingCount + 1;
        
        // 4?먮━ ?쒕쾲 ?앹꽦 (0001 ~ 9999)
        // 媛숈? ?쒓컙??9999媛??댁긽??二쇰Ц???덉쑝硫??ㅼ쓬 ?쒓컙?쇰줈 ?섏뼱媛?        if ($sequenceNumber > 9999) {
            $dateTime->modify('+1 hour');
            $timePrefix = $dateTime->format('ymdH');
            $sequenceNumber = 1;
        }
        
        $sequence = str_pad($sequenceNumber, 4, '0', STR_PAD_LEFT);
        $orderNumber = $timePrefix . '-' . $sequence;
        
        // ?앹꽦??二쇰Ц踰덊샇媛 ?대? 議댁옱?섎뒗吏 ?뺤씤 (以묐났 泥댄겕)
        $checkStmt = $pdo->prepare("SELECT COUNT(*) as count FROM product_applications WHERE order_number = :order_number");
        $checkStmt->execute([':order_number' => $orderNumber]);
        $checkResult = $checkStmt->fetch(PDO::FETCH_ASSOC);
        
        if (($checkResult['count'] ?? 0) == 0) {
            // 以묐났???놁쑝硫?二쇰Ц踰덊샇 諛섑솚
            return $orderNumber;
        }
        
        // 以묐났???덉쑝硫??쒕쾲 利앷? ???ъ떆??        $attempt++;
        $sequenceNumber++;
        
        // ?ъ떆??濡쒓렇
        error_log("Order number duplicate detected: {$orderNumber}, retrying... (attempt {$attempt})");
    }
    
    // 理쒕? ?ъ떆???잛닔 珥덇낵 ???덉쇅 諛쒖깮
    throw new Exception("二쇰Ц踰덊샇 ?앹꽦 ?ㅽ뙣: 理쒕? ?ъ떆???잛닔 珥덇낵");
}

/**
 * ?좎껌 ?곹깭瑜??쒓?濡?蹂??(怨듯넻 ?⑥닔)
 * ?먮ℓ???섏씠吏? 怨좉컼 留덉씠?섏씠吏?먯꽌 ?숈씪?섍쾶 ?ъ슜
 * @param string $status ?좎껌 ?곹깭 肄붾뱶
 * @return string ?쒓? ?곹깭紐? */
function getApplicationStatusLabel($status) {
    // ?곹깭 ?뺢퇋??(鍮?臾몄옄?? null, pending ??
    $normalizedStatus = strtolower(trim($status ?? ''));
    if (empty($normalizedStatus) || $normalizedStatus === 'pending') {
        $normalizedStatus = 'received';
    }
    
    // ?곹깭蹂??쒓?紐?留ㅽ븨 (?듭씪???⑹뼱 ?ъ슜)
    // received(?묒닔), activating(媛쒗넻以?, activation_completed(媛쒗넻?꾨즺), installation_completed(?ㅼ튂?꾨즺)
    $statusLabels = [
        'received' => '?묒닔',
        'activating' => '媛쒗넻以?,
        'on_hold' => '蹂대쪟',
        'cancelled' => '痍⑥냼',
        'activation_completed' => '媛쒗넻?꾨즺',
        'installation_completed' => '?ㅼ튂?꾨즺',
        'pending' => '?묒닔',  // pending??received? ?숈씪?섍쾶 泥섎━
        'processing' => '媛쒗넻以?,  // processing??activating怨??숈씪?섍쾶 泥섎━
        'completed' => '媛쒗넻?꾨즺',  // ?듭떊?ы룿/?뚮쑑?? 媛쒗넻?꾨즺, ?명꽣?? installation_completed ?ъ슜
        'rejected' => '蹂대쪟',
        'closed' => '醫낅즺',
        'terminated' => '醫낅즺'
    ];
    
    return $statusLabels[$normalizedStatus] ?? $status;
}

/**
 * user_id 而щ읆 議댁옱 ?щ? ?뺤씤 諛?異붽? (?ы띁 ?⑥닔)
 * @param PDO $pdo ?곗씠?곕쿋?댁뒪 ?곌껐
 * @return bool user_id 而щ읆 議댁옱 ?щ?
 */
function checkAndAddUserIdColumn($pdo) {
    try {
        // ?몃옖??뀡 ?곹깭 ???        $wasInTransaction = $pdo->inTransaction();
        
        // ?몃옖??뀡 諛뽰뿉??而щ읆 ?뺤씤 (???뺤떎??
        if ($wasInTransaction) {
            $pdo->commit();
        }
        
        // SHOW COLUMNS濡?紐⑤뱺 而щ읆 媛?몄????뺤씤 (媛???뺤떎??諛⑸쾿)
        $check = $pdo->query("SHOW COLUMNS FROM application_customers");
        $columns = $check->fetchAll(PDO::FETCH_COLUMN);
        $exists = in_array('user_id', $columns);
        
        error_log("addProductApplication - user_id 而щ읆 ?뺤씤: " . ($exists ? '議댁옱?? : '?놁쓬'));
        error_log("addProductApplication - ?꾩껜 而щ읆 紐⑸줉: " . implode(', ', $columns));
        
        if (!$exists) {
            error_log("addProductApplication - user_id 而щ읆???놁뒿?덈떎. 異붽??⑸땲??");
            
            try {
                $pdo->exec("ALTER TABLE application_customers ADD COLUMN user_id VARCHAR(50) DEFAULT NULL COMMENT '?뚯썝 user_id (鍮꾪쉶???좎껌 媛??' AFTER application_id");
                error_log("addProductApplication - user_id 而щ읆??異붽??섏뿀?듬땲??");
                $exists = true;
                
                // ?몃뜳??異붽?
                try {
                    $pdo->exec("ALTER TABLE application_customers ADD INDEX idx_user_id (user_id)");
                    error_log("addProductApplication - user_id ?몃뜳??異붽? ?꾨즺");
                } catch (PDOException $e) {
                    if (strpos($e->getMessage(), 'Duplicate') === false && strpos($e->getMessage(), 'already exists') === false) {
                        error_log("addProductApplication - ?몃뜳??異붽? 以??ㅻ쪟: " . $e->getMessage());
                    } else {
                        error_log("addProductApplication - ?몃뜳?ㅺ? ?대? 議댁옱?⑸땲??");
                    }
                }
            } catch (PDOException $e) {
                error_log("addProductApplication - 而щ읆 異붽? ?ㅽ뙣: " . $e->getMessage());
                error_log("  SQL State: " . ($e->errorInfo[0] ?? 'unknown'));
                error_log("  Driver Code: " . ($e->errorInfo[1] ?? 'unknown'));
                error_log("  Driver Message: " . ($e->errorInfo[2] ?? 'unknown'));
                
                // 而щ읆 異붽? ?ㅽ뙣 ??- ?대? 議댁옱?섎뒗吏 ?뺤씤
                $checkAgain = $pdo->query("SHOW COLUMNS FROM application_customers");
                $columnsAgain = $checkAgain->fetchAll(PDO::FETCH_COLUMN);
                $exists = in_array('user_id', $columnsAgain);
                
                if (!$exists) {
                    error_log("addProductApplication - 而щ읆 異붽? ?ㅽ뙣?섍퀬 ?ㅼ젣濡쒕룄 ?놁뒿?덈떎. false 諛섑솚");
                    $exists = false; // ?ㅼ젣濡??놁쑝硫?false 諛섑솚
                } else {
                    error_log("addProductApplication - 而щ읆 異붽? ?ㅽ뙣?덉?留??ㅼ젣濡쒕뒗 議댁옱?⑸땲??");
                    $exists = true;
                }
            }
        }
        
        // ?몃옖??뀡 ?ъ떆??        if ($wasInTransaction) {
            $pdo->beginTransaction();
        }
        
        return $exists;
    } catch (PDOException $e) {
        error_log("addProductApplication - 而щ읆 ?뺤씤 以??ㅻ쪟: " . $e->getMessage());
        error_log("  SQL State: " . ($e->errorInfo[0] ?? 'unknown'));
        error_log("  Driver Code: " . ($e->errorInfo[1] ?? 'unknown'));
        error_log("  Driver Message: " . ($e->errorInfo[2] ?? 'unknown'));
        
        // ?몃옖??뀡 ?ъ떆??        if (!$pdo->inTransaction()) {
            $pdo->beginTransaction();
        }
        
        // ?뺤씤 ?ㅽ뙣 ???덉쟾?섍쾶 false濡??ㅼ젙 (user_id ?놁씠 吏꾪뻾)
        return false;
    }
}

/**
 * ?곹뭹 ?좎껌 ?뺣낫 ??? * @param int $productId ?곹뭹 ID
 * @param int $sellerId ?먮ℓ??ID
 * @param string $productType ?곹뭹 ??? * @param array $customerData 怨좉컼 ?뺣낫
 * @return int|false ?좎껌 ID ?먮뒗 false
 */
function addProductApplication($productId, $sellerId, $productType, $customerData) {
    error_log("addProductApplication called - productId: {$productId}, sellerId: {$sellerId}, productType: {$productType}");
    
    $pdo = getDBConnection();
    if (!$pdo) {
        error_log("addProductApplication - Database connection failed");
        return false;
    }
    
    try {
        error_log("addProductApplication - Starting transaction");
        $pdo->beginTransaction();
        
        // order_number 而щ읆 議댁옱 ?뺤씤 諛?異붽? (?몃옖??뀡 諛뽰뿉???ㅽ뻾?댁빞 ??
        try {
            $checkOrderNumber = $pdo->query("SHOW COLUMNS FROM product_applications LIKE 'order_number'");
            if (!$checkOrderNumber->fetch()) {
                $pdo->commit(); // ALTER TABLE? ?몃옖??뀡??而ㅻ컠??                $pdo->exec("ALTER TABLE product_applications ADD COLUMN order_number VARCHAR(20) DEFAULT NULL COMMENT '二쇰Ц踰덊샇' AFTER id");
                // UNIQUE ?쒖빟議곌굔 異붽? (以묐났 諛⑹?)
                try {
                    $pdo->exec("ALTER TABLE product_applications ADD UNIQUE KEY uk_order_number (order_number)");
                } catch (PDOException $e) {
                    // ?대? 議댁옱?섎뒗 寃쎌슦 臾댁떆
                    if (strpos($e->getMessage(), 'Duplicate key name') === false) {
                        throw $e;
                    }
                }
                $pdo->beginTransaction(); // ?몃옖??뀡 ?ъ떆??                error_log("product_applications ?뚯씠釉붿뿉 order_number 而щ읆??異붽??섏뿀?듬땲??");
            }
        } catch (PDOException $e) {
            // 而щ읆 ?뺤씤 以??ㅻ쪟 諛쒖깮 ??臾댁떆?섍퀬 怨꾩냽 吏꾪뻾
            error_log("Order number column check error: " . $e->getMessage());
        }
        
        // 1. ?좎껌 ?깅줉 (紐⑤뱺 ?곹뭹 ??낆? 'pending' ?곹깭濡??쒖옉)
        // ?쒓뎅 ?쒓컙?(KST, UTC+9)濡??꾩옱 ?쒓컙??紐낆떆?곸쑝濡??ㅼ젙?섏뿬 二쇰Ц踰덊샇???쒓컙???뺥솗?섍쾶 ?쒖떆?섎룄濡???        $currentDateTime = new DateTime('now', new DateTimeZone('Asia/Seoul'));
        $currentDateTimeStr = $currentDateTime->format('Y-m-d H:i:s');
        $initialStatus = 'pending';

        // ?좎껌??user_id(users.user_id) - DB-only ?뺥빀??        $userId = $customerData['user_id'] ?? null;
        $userId = ($userId === null) ? null : (string)$userId;
        
        // INSERT ?꾩뿉 ?몃옖??뀡 諛뽰뿉??而щ읆 ?뺤씤 (?ㅽ궎留?蹂寃쎌씠 ?뺤떎??諛섏쁺?섎룄濡?
        $wasInTransaction = $pdo->inTransaction();
        if ($wasInTransaction) {
            $pdo->commit();
        }
        
        // product_applications ?뚯씠釉붿뿉 user_id 而щ읆???덈뒗吏 ?뺤씤
        try {
            $checkColumns = $pdo->query("SHOW COLUMNS FROM product_applications");
            $columns = $checkColumns->fetchAll(PDO::FETCH_COLUMN);
            $hasUserIdInApplications = in_array('user_id', $columns);
            
            error_log("addProductApplication - product_applications ?뚯씠釉?user_id 而щ읆 ?뺤씤: " . ($hasUserIdInApplications ? '議댁옱?? : '?놁쓬'));
            error_log("addProductApplication - product_applications ?꾩껜 而щ읆 紐⑸줉: " . implode(', ', $columns));
            
            if (!$hasUserIdInApplications) {
                error_log("addProductApplication - product_applications??user_id 而щ읆???놁뒿?덈떎. 異붽??⑸땲??");
                try {
                    $pdo->exec("ALTER TABLE product_applications ADD COLUMN user_id VARCHAR(50) DEFAULT NULL COMMENT '?좎껌??user_id (users.user_id)' AFTER product_type");
                    error_log("addProductApplication - product_applications??user_id 而щ읆 異붽? ?꾨즺");
                    
                    // ?몃뜳??異붽?
                    try {
                        $pdo->exec("ALTER TABLE product_applications ADD INDEX idx_user_id (user_id)");
                    } catch (PDOException $idxErr) {
                        if (strpos($idxErr->getMessage(), 'Duplicate') === false) {
                            error_log("addProductApplication - ?몃뜳??異붽? ?ㅽ뙣: " . $idxErr->getMessage());
                        }
                    }
                } catch (PDOException $alterErr) {
                    error_log("addProductApplication - 而щ읆 異붽? ?ㅽ뙣: " . $alterErr->getMessage());
                }
            }
        } catch (PDOException $checkErr) {
            error_log("addProductApplication - 而щ읆 ?뺤씤 ?ㅽ뙣: " . $checkErr->getMessage());
        }
        
        // ?몃옖??뀡 ?ъ떆??        if ($wasInTransaction) {
            $pdo->beginTransaction();
        }
        
        // 二쇰Ц踰덊샇 ?앹꽦 (?몃옖??뀡 ?댁뿉?? UNIQUE ?쒖빟議곌굔?쇰줈 以묐났 諛⑹?)
        $orderNumber = null;
        $maxRetries = 10;
        $retryCount = 0;
        
        while ($retryCount < $maxRetries) {
            try {
                $orderNumber = generateOrderNumber($pdo, $currentDateTime);
                
                // 二쇰Ц踰덊샇濡?INSERT ?쒕룄 (status_changed_at???④퍡 ?ㅼ젙)
                // user_id 而щ읆???덈뒗吏 ?ㅼ떆 ??踰??뺤씤?섏뿬 SQL 寃곗젙
                $insertColumns = "order_number, product_id, seller_id, product_type, application_status, created_at, status_changed_at";
                $insertValues = ":order_number, :product_id, :seller_id, :product_type, :application_status, :created_at, :status_changed_at";
                $insertParams = [
                    ':order_number' => $orderNumber,
                    ':product_id' => $productId,
                    ':seller_id' => $sellerId,
                    ':product_type' => $productType,
                    ':application_status' => $initialStatus,
                    ':created_at' => $currentDateTimeStr,
                    ':status_changed_at' => $currentDateTimeStr
                ];
                
                // user_id媛 ?덉쑝硫??ы븿
                if (!empty($userId)) {
                    $insertColumns = "order_number, product_id, seller_id, user_id, product_type, application_status, created_at, status_changed_at";
                    $insertValues = ":order_number, :product_id, :seller_id, :user_id, :product_type, :application_status, :created_at, :status_changed_at";
                    $insertParams[':user_id'] = $userId;
                }
                
                $sql = "INSERT INTO product_applications ({$insertColumns}) VALUES ({$insertValues})";
                
                error_log("addProductApplication - product_applications INSERT SQL: " . $sql);
                error_log("addProductApplication - user_id ?ы븿 ?щ?: " . (!empty($userId) ? 'YES' : 'NO'));
                
                $stmt = $pdo->prepare($sql);
                $stmt->execute($insertParams);
                
                // INSERT ?깃났 ??猷⑦봽 醫낅즺
                break;
                
            } catch (PDOException $e) {
                // user_id 而щ읆 愿???먮윭??寃쎌슦 user_id ?놁씠 ?ъ떆??                $isUserIdError = ($e->getCode() == 1054 || 
                                 strpos($e->getMessage(), "Unknown column 'user_id'") !== false || 
                                 strpos($e->getMessage(), "Unknown column `user_id`") !== false ||
                                 (strpos($e->getMessage(), "user_id") !== false && strpos($e->getMessage(), "field list") !== false));
                
                if ($isUserIdError) {
                    error_log("addProductApplication - product_applications INSERT ??user_id 而щ읆 ?먮윭 媛먯?, user_id ?놁씠 ?ъ떆?꾪빀?덈떎.");
                    error_log("  ?먮낯 ?먮윭: " . $e->getMessage());
                    
                    // user_id ?놁씠 ?ъ떆??                    $sqlRetry = "INSERT INTO product_applications (order_number, product_id, seller_id, product_type, application_status, created_at, status_changed_at) VALUES (:order_number, :product_id, :seller_id, :product_type, :application_status, :created_at, :status_changed_at)";
                    $retryParams = [
                        ':order_number' => $orderNumber,
                        ':product_id' => $productId,
                        ':seller_id' => $sellerId,
                        ':product_type' => $productType,
                        ':application_status' => $initialStatus,
                        ':created_at' => $currentDateTimeStr,
                        ':status_changed_at' => $currentDateTimeStr
                    ];
                    
                    try {
                        error_log("addProductApplication - product_applications INSERT ?ъ떆??(user_id ?놁씠)");
                        $stmtRetry = $pdo->prepare($sqlRetry);
                        $stmtRetry->execute($retryParams);
                        error_log("addProductApplication - product_applications INSERT ?깃났 (user_id ?놁씠)");
                        break; // ?깃났?덉쑝誘濡?猷⑦봽 醫낅즺
                    } catch (PDOException $e2) {
                        error_log("addProductApplication - product_applications INSERT ?ъ떆???ㅽ뙣: " . $e2->getMessage());
                        throw $e2;
                    }
                }
                
                // UNIQUE ?쒖빟議곌굔 ?꾨컲 (以묐났 二쇰Ц踰덊샇)
                if ($e->getCode() == 23000 || strpos($e->getMessage(), 'Duplicate entry') !== false) {
                    $retryCount++;
                    error_log("Order number duplicate detected: {$orderNumber}, retrying... (attempt {$retryCount})");
                    
                    // ?ㅼ쓬 ?쒕쾲?쇰줈 ?ъ떆?꾪븯湲??꾪빐 ?쒓컙???쎄컙 議곗젙?섍굅???쒕쾲 利앷?
                    if ($retryCount >= $maxRetries) {
                        throw new Exception("二쇰Ц踰덊샇 ?앹꽦 ?ㅽ뙣: 以묐났 諛⑹? ?쒕룄 ?잛닔 珥덇낵");
                    }
                    
                    // ?ㅼ쓬 ?쒕쾲???꾪빐 ?쒓컙??1珥?利앷? (媛숈? ?쒓컙???щ윭 二쇰Ц???숈떆???ㅼ뼱??寃쎌슦)
                    $currentDateTime->modify('+1 second');
                    $currentDateTimeStr = $currentDateTime->format('Y-m-d H:i:s');
                    continue;
                } else {
                    // ?ㅻⅨ ?ㅻ쪟??利됱떆 throw
                    throw $e;
                }
            }
        }
        
        if ($orderNumber === null) {
            throw new Exception("二쇰Ц踰덊샇 ?앹꽦 ?ㅽ뙣");
        }
        
        $applicationId = $pdo->lastInsertId();
        error_log("addProductApplication - Application created with ID: {$applicationId}, Order Number: {$orderNumber}");
        
        // application_count ?낅뜲?댄듃 (?몃━嫄곌? ?묐룞?섏? ?딆쓣 寃쎌슦瑜??鍮?
        try {
            $updateStmt = $pdo->prepare("
                UPDATE products 
                SET application_count = application_count + 1 
                WHERE id = :product_id
            ");
            $updateStmt->execute([':product_id' => $productId]);
            error_log("addProductApplication - application_count updated");
        } catch (PDOException $e) {
            // ?낅뜲?댄듃 ?ㅽ뙣?대룄 怨꾩냽 吏꾪뻾 (?몃━嫄곌? 泥섎━?????덉쓬)
            error_log("Failed to update application_count: " . $e->getMessage());
        }
        
        // 2. 怨좉컼 ?뺣낫 ?깅줉
        error_log("addProductApplication - Step 2: Inserting customer data");
        
        // user_id 而щ읆 議댁옱 ?뺤씤 諛?異붽?
        // ?뚯씠釉?援ъ“ ?뺤씤: application_customers ?뚯씠釉붿뿉 user_id 而щ읆??議댁옱??(?ㅽ궎留??뺤씤??
        // user_id???꾩닔 ?뺣낫?대?濡??뺤긽?곸쑝濡???ν빐????        $hasUserIdColumn = true; // 湲곕낯媛믪쓣 true濡??ㅼ젙 (而щ읆??議댁옱??
        
        // 而щ읆 ?뺤씤 (?몃옖??뀡 諛뽰뿉???ㅽ뻾?섏뿬 ?뺥솗???ㅽ궎留??뺤씤)
        try {
            $wasInTransaction = $pdo->inTransaction();
            if ($wasInTransaction) {
                $pdo->commit();
            }
            
            // ?ㅼ젣濡?而щ읆???덈뒗吏 ?뺤씤
            $checkColumns = $pdo->query("SHOW COLUMNS FROM application_customers");
            $columns = $checkColumns->fetchAll(PDO::FETCH_COLUMN);
            $hasUserIdColumn = in_array('user_id', $columns);
            
            error_log("addProductApplication - user_id 而щ읆 ?뺤씤 寃곌낵: " . ($hasUserIdColumn ? '議댁옱?? : '?놁쓬'));
            error_log("addProductApplication - ?꾩껜 而щ읆 紐⑸줉: " . implode(', ', $columns));
            
            if ($wasInTransaction) {
                $pdo->beginTransaction();
            }
        } catch (PDOException $checkErr) {
            error_log("addProductApplication - 而щ읆 ?뺤씤 ?ㅽ뙣: " . $checkErr->getMessage());
            // ?뺤씤 ?ㅽ뙣 ?쒖뿉??true濡??좎? (而щ읆??議댁옱?쒕떎怨?媛??
            $hasUserIdColumn = true;
            if (!$pdo->inTransaction()) {
                $pdo->beginTransaction();
            }
        }
        
        error_log("addProductApplication - 理쒖쥌 hasUserIdColumn: " . ($hasUserIdColumn ? 'true' : 'false'));
        error_log("addProductApplication - userId 媛? " . ($userId ?? 'null'));
        
        // user_id 寃利?(濡쒓렇?명븳 ?ъ슜?먮쭔 ?좎껌 媛?ν븯誘濡?user_id???꾩닔)
        if (empty($userId) || $userId === null) {
            error_log("WARNING: Application created without user_id. Application ID: " . $applicationId);
            // user_id媛 ?놁쑝硫??먮윭 (濡쒓렇???꾩닔)
            throw new Exception('?ъ슜???뺣낫瑜??뺤씤?????놁뒿?덈떎. ?ㅼ떆 濡쒓렇?명빐二쇱꽭??');
        }
        
        // additional_info JSON ?몄퐫??        $additionalInfoJson = null;
        if (!empty($customerData['additional_info'])) {
            $additionalInfoJson = json_encode($customerData['additional_info'], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            if ($additionalInfoJson === false) {
                error_log("ERROR: Failed to encode additional_info to JSON. Error: " . json_last_error_msg());
                $additionalInfoJson = null;
            }
        }
        
        // INSERT 荑쇰━ 諛??뚮씪誘명꽣 以鍮?        $baseParams = [
            ':application_id' => $applicationId,
            ':name' => $customerData['name'] ?? '',
            ':phone' => $customerData['phone'] ?? '',
            ':email' => $customerData['email'] ?? null,
            ':address' => $customerData['address'] ?? null,
            ':address_detail' => $customerData['address_detail'] ?? null,
            ':birth_date' => $customerData['birth_date'] ?? null,
            ':gender' => $customerData['gender'] ?? null,
            ':additional_info' => $additionalInfoJson
        ];
        
        // INSERT ??理쒖쥌 ?뺤씤 - user_id ?ы븿?섏뿬 ?뺤긽?곸쑝濡????        // ?뚯씠釉붿뿉 user_id 而щ읆??議댁옱?섍퀬, user_id???꾩닔 ?뺣낫?대?濡??ы븿?섏뿬 ???        error_log("addProductApplication - ========================================");
        error_log("addProductApplication - 理쒖쥌 寃곗젙: user_id ?ы븿?섏뿬 ??ν빀?덈떎.");
        error_log("addProductApplication - hasUserIdColumn: " . ($hasUserIdColumn ? 'true' : 'false'));
        error_log("addProductApplication - userId: " . ($userId ?? 'null'));
        error_log("addProductApplication - ========================================");
        
        // user_id ?ы븿?섏뿬 INSERT (?뺤긽 諛⑹떇)
        if ($hasUserIdColumn && !empty($userId)) {
            $sql = "INSERT INTO application_customers (application_id, user_id, name, phone, email, address, address_detail, birth_date, gender, additional_info) VALUES (:application_id, :user_id, :name, :phone, :email, :address, :address_detail, :birth_date, :gender, :additional_info)";
            $baseParams[':user_id'] = $userId;
            error_log("addProductApplication - user_id ?ы븿?섏뿬 INSERT ?ㅽ뻾");
        } else {
            // user_id 而щ읆???녾굅??user_id媛 ?녿뒗 寃쎌슦 (鍮꾩긽 ?곹솴)
            $sql = "INSERT INTO application_customers (application_id, name, phone, email, address, address_detail, birth_date, gender, additional_info) VALUES (:application_id, :name, :phone, :email, :address, :address_detail, :birth_date, :gender, :additional_info)";
            if (isset($baseParams[':user_id'])) {
                unset($baseParams[':user_id']);
            }
            error_log("addProductApplication - 寃쎄퀬: user_id ?놁씠 INSERT ?ㅽ뻾 (鍮꾩긽 ?곹솴)");
        }
        
        $executeParams = $baseParams;
        
        error_log("addProductApplication - 理쒖쥌 executeParams ??紐⑸줉: " . implode(', ', array_keys($executeParams)));
        error_log("addProductApplication - user_id ?ы븿 ?щ?: " . (isset($executeParams[':user_id']) ? 'YES (?뺤긽)' : 'NO'));
        
        // INSERT ?ㅽ뻾
        error_log("addProductApplication - ========================================");
        error_log("addProductApplication - INSERT ?ㅽ뻾 ?쒖옉");
        error_log("addProductApplication - SQL: " . $sql);
        error_log("addProductApplication - SQL??'user_id' ?ы븿 ?щ?: " . (strpos($sql, 'user_id') !== false ? 'YES (?뺤긽)' : 'NO'));
        error_log("addProductApplication - Parameter keys: " . implode(', ', array_keys($executeParams)));
        error_log("addProductApplication - ========================================");
        
        // ?뚮씪誘명꽣 媛?濡쒓퉭 (誘쇨컧 ?뺣낫 ?쒖쇅)
        $logParams = $executeParams;
        if (isset($logParams[':phone'])) {
            $logParams[':phone'] = substr($logParams[':phone'], 0, 3) . '****' . substr($logParams[':phone'], -4);
        }
        if (isset($logParams[':email'])) {
            $logParams[':email'] = preg_replace('/(.{2})(.*)(@.*)/', '$1***$3', $logParams[':email'] ?? '');
        }
        if (isset($logParams[':additional_info'])) {
            $logParams[':additional_info'] = '[' . strlen($executeParams[':additional_info'] ?? '') . ' bytes]';
        }
        error_log("addProductApplication - Parameter values (masked): " . json_encode($logParams, JSON_UNESCAPED_UNICODE));
        
        $stmt = $pdo->prepare($sql);
        
        try {
            $stmt->execute($executeParams);
            error_log("addProductApplication - Customer data inserted successfully");
            
            insert_success: // ?ъ떆???깃났 ???ш린濡??대룞
            // INSERT ?깃났 (?먮옒 ?쒕룄 ?먮뒗 ?ъ떆??
            error_log("addProductApplication - Customer data insert completed successfully");
        } catch (PDOException $e) {
            // ?꾩쟾???먮윭 ?뺣낫 濡쒓퉭
            $fullError = [
                'code' => $e->getCode(),
                'message' => $e->getMessage(),
                'sql_state' => $e->errorInfo[0] ?? 'unknown',
                'driver_code' => $e->errorInfo[1] ?? 'unknown',
                'driver_message' => $e->errorInfo[2] ?? 'unknown',
                'sql' => $sql,
                'param_keys' => array_keys($executeParams)
            ];
            error_log("addProductApplication - PDOException FULL ERROR: " . json_encode($fullError, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
            
            // ?먮윭 硫붿떆吏?먯꽌 而щ읆紐?異붿텧 ?쒕룄
            if (preg_match("/Unknown column ['\"]([^'\"]+)['\"]/i", $e->getMessage(), $matches)) {
                $missingColumn = $matches[1];
                error_log("addProductApplication - 異붿텧???꾨씫 而щ읆紐? " . $missingColumn);
            } elseif (preg_match("/Unknown column `([^`]+)`/i", $e->getMessage(), $matches)) {
                $missingColumn = $matches[1];
                error_log("addProductApplication - 異붿텧???꾨씫 而щ읆紐?(backtick): " . $missingColumn);
            }
            
            // 而щ읆???녿뒗 寃쎌슦 - ?ㅼ젣 ?뚯씠釉?援ъ“ ?뺤씤
            if ($e->getCode() == 1054 || strpos($e->getMessage(), "Unknown column") !== false) {
                error_log("addProductApplication - 而щ읆 ?ㅻ쪟 媛먯?, ?뚯씠釉?援ъ“ ?뺤씤 以?..");
                try {
                    $columnsStmt = $pdo->query("SHOW COLUMNS FROM application_customers");
                    $columns = $columnsStmt->fetchAll(PDO::FETCH_COLUMN);
                    error_log("application_customers ?뚯씠釉?而щ읆 紐⑸줉: " . implode(', ', $columns));
                } catch (PDOException $colErr) {
                    error_log("而щ읆 紐⑸줉 議고쉶 ?ㅽ뙣: " . $colErr->getMessage());
                }
            }
            
            // user_id 而щ읆 愿???먮윭??寃쎌슦 臾댁“嫄?user_id ?놁씠 ?ъ떆??            $isUserIdError = ($e->getCode() == 1054 || 
                             strpos($e->getMessage(), "Unknown column 'user_id'") !== false || 
                             strpos($e->getMessage(), "Unknown column `user_id`") !== false ||
                             (strpos($e->getMessage(), "user_id") !== false && strpos($e->getMessage(), "field list") !== false));
            
            if ($isUserIdError) {
                error_log("addProductApplication - user_id 而щ읆 ?먮윭 媛먯?, user_id ?놁씠 ?ъ떆?꾪빀?덈떎.");
                error_log("  ?먮낯 ?먮윭: " . $e->getMessage());
                error_log("  hasUserIdColumn: " . ($hasUserIdColumn ? 'true' : 'false'));
                
                // user_id ?놁씠 ?ъ떆??(hasUserIdColumn 媛믨낵 愿怨꾩뾾??
                $sqlRetry = "INSERT INTO application_customers (application_id, name, phone, email, address, address_detail, birth_date, gender, additional_info) VALUES (:application_id, :name, :phone, :email, :address, :address_detail, :birth_date, :gender, :additional_info)";
                $retryParams = $baseParams;
                unset($retryParams[':user_id']); // user_id ?쒓굅
                
                try {
                    error_log("addProductApplication - Retrying without user_id");
                    error_log("  Retry SQL: " . $sqlRetry);
                    error_log("  Retry Parameters: " . implode(', ', array_keys($retryParams)));
                    
                    $stmt2 = $pdo->prepare($sqlRetry);
                    $stmt2->execute($retryParams);
                    error_log("addProductApplication - Customer data inserted successfully (without user_id)");
                    
                    // ?ъ떆???깃났 - catch 釉붾줉??鍮좎졇?섍????⑥닔媛 ?뺤긽?곸쑝濡?怨꾩냽 吏꾪뻾?섎룄濡???                    // ?댁젣 ?⑥닔???뺤긽?곸쑝濡?怨꾩냽 吏꾪뻾?섏뼱 而ㅻ컠?섍퀬 諛섑솚??                    goto insert_success; // ?깃났 ???⑥닔 怨꾩냽 吏꾪뻾
                } catch (PDOException $e2) {
                    error_log("addProductApplication - ERROR inserting customer data (retry): " . $e2->getMessage());
                    error_log("  Retry SQL State: " . ($e2->errorInfo[0] ?? 'unknown'));
                    error_log("  Retry Driver Code: " . ($e2->errorInfo[1] ?? 'unknown'));
                    error_log("  Retry Driver Message: " . ($e2->errorInfo[2] ?? 'unknown'));
                    throw $e2;
                }
            } else {
                // ?ㅻⅨ 而щ읆 ?ㅻ쪟??寃쎌슦 - ?대뼡 而щ읆??臾몄젣?몄? ?뚯븙
                $errorMsg = $e->getMessage();
                if (preg_match("/Unknown column ['\"]([^'\"]+)['\"]/i", $errorMsg, $matches)) {
                    $missingColumn = $matches[1];
                    error_log("addProductApplication - ?꾨씫??而щ읆 媛먯?: " . $missingColumn);
                    
                    // ?꾨씫??而щ읆???덉쑝硫??먮룞?쇰줈 異붽? ?쒕룄
                    if ($missingColumn && $missingColumn !== 'user_id') {
                        try {
                            error_log("addProductApplication - ?꾨씫??而щ읆 '{$missingColumn}' 異붽? ?쒕룄 以?..");
                            if ($pdo->inTransaction()) {
                                $pdo->commit();
                            }
                            
                            // 而щ읆 ???異붿젙 (?쇰컲?곸씤 寃쎌슦)
                            $columnDef = '';
                            switch ($missingColumn) {
                                case 'additional_info':
                                    $columnDef = "ADD COLUMN additional_info TEXT DEFAULT NULL COMMENT '異붽? ?뺣낫 (JSON)' AFTER gender";
                                    break;
                                case 'address':
                                    $columnDef = "ADD COLUMN address VARCHAR(255) DEFAULT NULL COMMENT '二쇱냼' AFTER email";
                                    break;
                                case 'address_detail':
                                    $columnDef = "ADD COLUMN address_detail VARCHAR(255) DEFAULT NULL COMMENT '?곸꽭二쇱냼' AFTER address";
                                    break;
                                case 'birth_date':
                                    $columnDef = "ADD COLUMN birth_date DATE DEFAULT NULL COMMENT '?앸뀈?붿씪' AFTER address_detail";
                                    break;
                                case 'gender':
                                    $columnDef = "ADD COLUMN gender ENUM('male', 'female', 'other') DEFAULT NULL COMMENT '?깅퀎' AFTER birth_date";
                                    break;
                                default:
                                    error_log("addProductApplication - ?????녿뒗 而щ읆: {$missingColumn}");
                            }
                            
                            if ($columnDef) {
                                $pdo->exec("ALTER TABLE application_customers {$columnDef}");
                                error_log("addProductApplication - 而щ읆 '{$missingColumn}' 異붽? ?꾨즺");
                                
                                if (!$pdo->inTransaction()) {
                                    $pdo->beginTransaction();
                                }
                                
                                // ?ъ떆??                                $stmt->execute($executeParams);
                                error_log("addProductApplication - Customer data inserted successfully (after adding column)");
                                // ?깃났?덉쑝誘濡??⑥닔 怨꾩냽 吏꾪뻾
                            } else {
                                throw new Exception("?꾩닔 而щ읆 '{$missingColumn}'???놁뒿?덈떎. ?곗씠?곕쿋?댁뒪 ?ㅽ궎留덈? ?뺤씤?섏꽭??");
                            }
                        } catch (PDOException $alterErr) {
                            error_log("addProductApplication - 而щ읆 異붽? ?ㅽ뙣: " . $alterErr->getMessage());
                            if (!$pdo->inTransaction()) {
                                $pdo->beginTransaction();
                            }
                            throw new Exception("?꾩닔 而щ읆 '{$missingColumn}'???놁뒿?덈떎. ?곗씠?곕쿋?댁뒪 ?ㅽ궎留덈? ?뺤씤?섏꽭?? " . $alterErr->getMessage());
                        }
                    } else {
                        error_log("addProductApplication - ERROR inserting customer data: " . $errorMsg);
                        throw $e;
                    }
                } else {
                    error_log("addProductApplication - ERROR inserting customer data: " . $errorMsg);
                    throw $e;
                }
            }
        }
        
        // ?붾쾭源? ??λ맂 additional_info ?뺤씤
        if (!empty($customerData['additional_info'])) {
            $savedInfo = json_encode($customerData['additional_info'], JSON_UNESCAPED_UNICODE);
            error_log("Saved additional_info length: " . strlen($savedInfo));
            if (isset($customerData['additional_info']['product_snapshot'])) {
                error_log("product_snapshot exists in additional_info");
                error_log("product_snapshot plan_name: " . ($customerData['additional_info']['product_snapshot']['plan_name'] ?? 'NULL'));
            } else {
                error_log("ERROR: product_snapshot NOT found in additional_info!");
            }
        }
        
        error_log("addProductApplication - Committing transaction");
        $pdo->commit();
        error_log("addProductApplication - SUCCESS! Returning application ID: {$applicationId}");
        return $applicationId;
    } catch (PDOException $e) {
        if (isset($pdo) && $pdo->inTransaction()) {
            error_log("addProductApplication - Rolling back transaction due to PDOException");
            $pdo->rollBack();
        }
        error_log("addProductApplication - PDOException occurred:");
        error_log("  Message: " . $e->getMessage());
        error_log("  Code: " . $e->getCode());
        error_log("  SQL State: " . ($e->errorInfo[0] ?? 'unknown'));
        error_log("  Driver Error Code: " . ($e->errorInfo[1] ?? 'unknown'));
        error_log("  Driver Error Message: " . ($e->errorInfo[2] ?? 'unknown'));
        error_log("  Stack trace: " . $e->getTraceAsString());
        
        // ?꾩뿭 蹂?섏뿉 ?먮윭 ?뺣낫 ???        global $lastDbError;
        $lastDbError = "PDO ?ㅻ쪟: " . $e->getMessage() . " (SQL State: " . ($e->errorInfo[0] ?? 'unknown') . ", Driver Code: " . ($e->errorInfo[1] ?? 'unknown') . ")";
        
        return false;
    } catch (Exception $e) {
        if (isset($pdo) && $pdo->inTransaction()) {
            error_log("addProductApplication - Rolling back transaction due to Exception");
            $pdo->rollBack();
        }
        error_log("addProductApplication - Exception occurred:");
        error_log("  Message: " . $e->getMessage());
        error_log("  Stack trace: " . $e->getTraceAsString());
        
        // ?꾩뿭 蹂?섏뿉 ?먮윭 ?뺣낫 ???        global $lastDbError;
        $lastDbError = "?덉쇅 諛쒖깮: " . $e->getMessage();
        
        return false;
    }
}

/**
 * ?곹뭹 ??낅퀎 ?쒕쾲 議고쉶 (媛???낅퀎濡?1踰덈????쒖옉, 媛???ㅻ옒???곹뭹??1踰?
 * @param int $productId ?곹뭹 ID
 * @param string $productType ?곹뭹 ???('mvno', 'mno', 'internet')
 * @return int|false ?쒕쾲 ?먮뒗 false
 */
function getProductNumberByType($productId, $productType) {
    $pdo = getDBConnection();
    if (!$pdo || empty($productId) || empty($productType)) {
        return false;
    }
    
    try {
        // ?대떦 ??낆쓽 ?곹뭹 以묒뿉??id媛 ?묒? ?쒖꽌?濡??쒕쾲 怨꾩궛 (媛???ㅻ옒???곹뭹??1踰?
        $stmt = $pdo->prepare("
            SELECT COUNT(*) + 1 as product_number
            FROM products
            WHERE product_type = :product_type 
            AND id < :product_id 
            AND status != 'deleted'
        ");
        $stmt->execute([
            ':product_type' => $productType,
            ':product_id' => $productId
        ]);
        $result = $stmt->fetch(PDO::FETCH_ASSOC);
        
        return $result ? (int)$result['product_number'] : 1;
    } catch (PDOException $e) {
        error_log("Error getting product number: " . $e->getMessage());
        return false;
    }
}

/**
 * 議고쉶??利앷?
 * @param int $productId ?곹뭹 ID
 * @return bool
 */
function incrementProductView($productId) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return false;
    }
    
    try {
        $stmt = $pdo->prepare("
            UPDATE products SET view_count = view_count + 1 WHERE id = :product_id
        ");
        $stmt->execute([':product_id' => $productId]);
        return true;
    } catch (PDOException $e) {
        error_log("Error incrementing view: " . $e->getMessage());
        return false;
    }
}

/**
 * ?ъ슜?먯쓽 MVNO ?좎껌 ?댁뿭 媛?몄삤湲? * @param int $userId ?ъ슜??ID
 * @return array ?좎껌 ?댁뿭 諛곗뿴
 */
function getUserMvnoApplications($userId, $limit = null, $offset = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return [];
    }
    
    try {
        // ?⑥닚??荑쇰━濡?蹂寃? application_customers?먯꽌 理쒖떊 ?덉퐫?쒕쭔 媛?몄삤湲?        $sql = "
            SELECT 
                a.id as application_id,
                a.order_number,
                a.product_id,
                a.application_status,
                a.created_at as order_date,
                p.seller_id,
                c.name,
                c.phone,
                c.email,
                c.additional_info,
                mvno.plan_name,
                mvno.provider,
                mvno.price_main,
                mvno.price_after,
                mvno.discount_period,
                mvno.data_amount,
                mvno.data_amount_value,
                mvno.data_unit,
                mvno.data_additional,
                mvno.data_additional_value,
                mvno.data_exhausted,
                mvno.data_exhausted_value,
                mvno.call_type,
                mvno.call_amount,
                mvno.sms_type,
                mvno.sms_amount,
                mvno.service_type,
                mvno.promotions,
                p.status as product_status
            FROM product_applications a
            INNER JOIN (
                SELECT c1.application_id, c1.id, c1.user_id, c1.additional_info, c1.name, c1.phone, c1.email
                FROM application_customers c1
                INNER JOIN (
                    SELECT application_id, MAX(id) as max_id
                    FROM application_customers
                    GROUP BY application_id
                ) c2 ON c1.application_id = c2.application_id AND c1.id = c2.max_id
            ) c ON a.id = c.application_id
            INNER JOIN products p ON a.product_id = p.id
            LEFT JOIN product_mvno_details mvno ON p.id = mvno.product_id
            WHERE c.user_id = :user_id 
            AND a.product_type = 'mvno'
            ORDER BY a.created_at DESC
        ";
        
        if ($limit !== null && $offset !== null) {
            $sql .= " LIMIT :limit OFFSET :offset";
        }
        
        $stmt = $pdo->prepare($sql);
        $params = [':user_id' => $userId];
        if ($limit !== null && $offset !== null) {
            $params[':limit'] = (int)$limit;
            $params[':offset'] = (int)$offset;
        }
        $stmt->execute($params);
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // ?붾쾭源?濡쒓렇
        error_log("getUserMvnoApplications - User ID: " . $userId);
        error_log("getUserMvnoApplications - Found applications: " . count($applications));
        if (!empty($applications)) {
            error_log("getUserMvnoApplications - First app: " . print_r($applications[0], true));
        }
        
        // ?곗씠???щ㎎??        $formattedApplications = [];
        $processingIndex = 0;
        foreach ($applications as $app) {
            $processingIndex++;
            try {
            error_log("=== START Processing application #{$processingIndex} ===");
            $appId = $app['application_id'] ?? null;
            if (!$appId) {
                error_log("WARNING: Skipping application with no application_id at index {$processingIndex}");
                error_log("App data keys: " . implode(', ', array_keys($app)));
                continue;
            }
            
            error_log("Processing application_id: {$appId}");
            error_log("App data: " . json_encode(array_keys($app)));
            
            // additional_info ?뚯떛 (?좎껌 ?뱀떆 ?곹뭹 ?뺣낫媛 ??λ맂 怨?
            $additionalInfo = [];
            $productSnapshot = null; // 珥덇린??            
            error_log("Step 1: Starting additional_info parsing for application_id: {$appId}");
            
            if (!empty($app['additional_info'])) {
                error_log("Step 1.1: additional_info is not empty, length: " . strlen($app['additional_info']));
                $decoded = json_decode($app['additional_info'], true);
                $jsonError = json_last_error();
                error_log("Step 1.2: JSON decode result - error code: {$jsonError}, error msg: " . json_last_error_msg());
                
                if ($jsonError === JSON_ERROR_NONE && is_array($decoded)) {
                    $additionalInfo = $decoded;
                    error_log("Step 1.3: JSON decode successful, keys: " . implode(', ', array_keys($additionalInfo)));
                    
                    // product_snapshot ?뺤씤 (?좎껌 ?뱀떆 ?곹뭹 ?뺣낫媛 ?ш린 ??λ릺???덉쓬)
                    if (isset($additionalInfo['product_snapshot'])) {
                        error_log("Step 1.4: product_snapshot key exists");
                        if (is_array($additionalInfo['product_snapshot'])) {
                            $productSnapshot = $additionalInfo['product_snapshot'];
                            error_log("Step 1.5: product_snapshot is array with " . count($productSnapshot) . " keys");
                            error_log("Step 1.6: product_snapshot keys: " . implode(', ', array_slice(array_keys($productSnapshot), 0, 10)));
                            error_log("Step 1.7: product_snapshot['plan_name'] = [" . ($productSnapshot['plan_name'] ?? 'NOT_SET') . "]");
                            error_log("Step 1.8: product_snapshot['provider'] = [" . ($productSnapshot['provider'] ?? 'NOT_SET') . "]");
                        } else {
                            error_log("WARNING Step 1.5: product_snapshot is not array, type: " . gettype($additionalInfo['product_snapshot']));
                        }
                    } else {
                        error_log("WARNING Step 1.4: product_snapshot key not found in additional_info");
                        error_log("Available keys: " . implode(', ', array_keys($additionalInfo)));
                    }
                } else {
                    error_log("ERROR Step 1.3: JSON decode failed for application {$appId}");
                    error_log("JSON error code: {$jsonError}, message: " . json_last_error_msg());
                    if (!empty($app['additional_info'])) {
                        $preview = substr($app['additional_info'], 0, 200);
                        error_log("additional_info preview: " . $preview);
                    }
                }
            } else {
                error_log("WARNING Step 1.1: additional_info is empty for application_id: {$appId}");
                error_log("additional_info value: " . var_export($app['additional_info'] ?? null, true));
            }
            
            // ?곹뭹 ?뺣낫 蹂??珥덇린??            $planName = '';
            $provider = '';
            $priceMain = 0;
            $priceAfter = null;
            $contractPeriod = '';
            $discountPeriod = '';
            $dataAmount = '';
            $dataAmountValue = '';
            $dataUnit = '';
            $dataAdditional = '';
            $dataAdditionalValue = '';
            $dataExhausted = '';
            $dataExhaustedValue = '';
            $callType = '';
            $callAmount = '';
            $smsType = '';
            $smsAmount = '';
            $serviceType = '';
            $promotions = '';
            
            // product_snapshot???덉쑝硫??곗꽑 ?ъ슜 (?좎껌 ?뱀떆 ?곹뭹 ?뺣낫)
            error_log("Step 2: Checking productSnapshot for application_id: {$appId}");
            error_log("Step 2.1: productSnapshot empty check: " . (empty($productSnapshot) ? 'EMPTY' : 'NOT_EMPTY'));
            error_log("Step 2.2: productSnapshot type: " . gettype($productSnapshot));
            error_log("Step 2.3: productSnapshot is_array: " . (is_array($productSnapshot) ? 'YES' : 'NO'));
            
            if (!empty($productSnapshot) && is_array($productSnapshot)) {
                error_log("Step 2.4: Using product_snapshot data");
                // ?ㅻ깄???곗씠???ъ슜 - 吏곸젒 諛곗뿴 ?묎렐 (媛꾨떒?섍퀬 紐낇솗?섍쾶)
                if (isset($productSnapshot['plan_name'])) {
                    error_log("Step 2.5: plan_name exists, value: [" . var_export($productSnapshot['plan_name'], true) . "]");
                    if (!empty($productSnapshot['plan_name'])) {
                        $planName = trim((string)$productSnapshot['plan_name']);
                        error_log("Step 2.6: planName assigned: [{$planName}]");
                    } else {
                        error_log("Step 2.6: plan_name is empty, skipping assignment");
                    }
                } else {
                    error_log("Step 2.5: plan_name key does not exist in productSnapshot");
                }
                
                if (isset($productSnapshot['provider'])) {
                    error_log("Step 2.7: provider exists, value: [" . var_export($productSnapshot['provider'], true) . "]");
                    if (!empty($productSnapshot['provider'])) {
                        $provider = trim((string)$productSnapshot['provider']);
                        error_log("Step 2.8: provider assigned: [{$provider}]");
                    } else {
                        error_log("Step 2.8: provider is empty, skipping assignment");
                    }
                } else {
                    error_log("Step 2.7: provider key does not exist in productSnapshot");
                }
                $priceMain = isset($productSnapshot['price_main']) && is_numeric($productSnapshot['price_main']) ? (float)$productSnapshot['price_main'] : 0;
                $priceAfter = isset($productSnapshot['price_after']) && is_numeric($productSnapshot['price_after']) && $productSnapshot['price_after'] != '0' ? (float)$productSnapshot['price_after'] : null;
                $contractPeriod = isset($productSnapshot['contract_period']) && $productSnapshot['contract_period'] !== null ? trim((string)$productSnapshot['contract_period']) : '';
                $discountPeriod = isset($productSnapshot['discount_period']) && $productSnapshot['discount_period'] !== null ? trim((string)$productSnapshot['discount_period']) : '';
                $dataAmount = isset($productSnapshot['data_amount']) && $productSnapshot['data_amount'] !== null ? trim((string)$productSnapshot['data_amount']) : '';
                $dataAmountValue = isset($productSnapshot['data_amount_value']) && $productSnapshot['data_amount_value'] !== null ? trim((string)$productSnapshot['data_amount_value']) : '';
                $dataUnit = isset($productSnapshot['data_unit']) && $productSnapshot['data_unit'] !== null ? trim((string)$productSnapshot['data_unit']) : '';
                $dataAdditional = isset($productSnapshot['data_additional']) && $productSnapshot['data_additional'] !== null ? trim((string)$productSnapshot['data_additional']) : '';
                $dataAdditionalValue = isset($productSnapshot['data_additional_value']) && $productSnapshot['data_additional_value'] !== null ? trim((string)$productSnapshot['data_additional_value']) : '';
                $dataExhausted = isset($productSnapshot['data_exhausted']) && $productSnapshot['data_exhausted'] !== null ? trim((string)$productSnapshot['data_exhausted']) : '';
                $dataExhaustedValue = isset($productSnapshot['data_exhausted_value']) && $productSnapshot['data_exhausted_value'] !== null ? trim((string)$productSnapshot['data_exhausted_value']) : '';
                $callType = isset($productSnapshot['call_type']) && $productSnapshot['call_type'] !== null ? trim((string)$productSnapshot['call_type']) : '';
                $callAmount = isset($productSnapshot['call_amount']) && $productSnapshot['call_amount'] !== null ? trim((string)$productSnapshot['call_amount']) : '';
                $smsType = isset($productSnapshot['sms_type']) && $productSnapshot['sms_type'] !== null ? trim((string)$productSnapshot['sms_type']) : '';
                $smsAmount = isset($productSnapshot['sms_amount']) && $productSnapshot['sms_amount'] !== null ? trim((string)$productSnapshot['sms_amount']) : '';
                $serviceType = isset($productSnapshot['service_type']) && $productSnapshot['service_type'] !== null ? trim((string)$productSnapshot['service_type']) : '';
                $promotions = isset($productSnapshot['promotions']) && $productSnapshot['promotions'] !== null 
                    ? (is_string($productSnapshot['promotions']) ? $productSnapshot['promotions'] : json_encode($productSnapshot['promotions'])) 
                    : '';
                
                error_log("Step 2.9: FINAL - planName=[{$planName}], provider=[{$provider}]");
            } else {
                // product_snapshot???놁쑝硫?product_id濡??꾩옱 ?곹뭹 ?뺣낫瑜?吏곸젒 議고쉶
                error_log("WARNING: Application " . $appId . " - product_snapshot not found, fetching current product info by product_id");
                
                $currentProduct = null;
                
                // product_id濡??꾩옱 ?곹뭹 ?뺣낫 吏곸젒 議고쉶
                if (!empty($app['product_id'])) {
                    $productStmt = $pdo->prepare("
                        SELECT * FROM product_mvno_details WHERE product_id = :product_id LIMIT 1
                    ");
                    $productStmt->execute([':product_id' => $app['product_id']]);
                    $currentProduct = $productStmt->fetch(PDO::FETCH_ASSOC);
                    
                    if ($currentProduct) {
                        error_log("Debug - Fetched current product info by product_id: " . ($currentProduct['plan_name'] ?? 'NULL'));
                    } else {
                        error_log("Debug - No product found for product_id: " . $app['product_id']);
                    }
                }
                
                // ?꾩옱 ?곹뭹 ?뺣낫 ?ъ슜 (fallback)
                // 癒쇱? product_id濡?吏곸젒 議고쉶???뺣낫媛 ?덉쑝硫??ъ슜, ?놁쑝硫?JOIN???뺣낫 ?ъ슜
                if (!empty($currentProduct)) {
                    $planName = $currentProduct['plan_name'] ?? '';
                    $provider = $currentProduct['provider'] ?? '';
                    $priceMain = isset($currentProduct['price_main']) && $currentProduct['price_main'] !== null && $currentProduct['price_main'] !== '' ? (float)$currentProduct['price_main'] : 0;
                    $priceAfter = isset($currentProduct['price_after']) && $currentProduct['price_after'] !== null && $currentProduct['price_after'] !== '' ? (float)$currentProduct['price_after'] : null;
                    $contractPeriod = $currentProduct['contract_period'] ?? '';
                    $discountPeriod = $currentProduct['discount_period'] ?? '';
                    $dataAmount = $currentProduct['data_amount'] ?? '';
                    $dataAmountValue = $currentProduct['data_amount_value'] ?? '';
                    $dataUnit = $currentProduct['data_unit'] ?? '';
                    $dataAdditional = $currentProduct['data_additional'] ?? '';
                    $dataAdditionalValue = $currentProduct['data_additional_value'] ?? '';
                    $dataExhausted = $currentProduct['data_exhausted'] ?? '';
                    $dataExhaustedValue = $currentProduct['data_exhausted_value'] ?? '';
                    $callType = $currentProduct['call_type'] ?? '';
                    $callAmount = $currentProduct['call_amount'] ?? '';
                    $smsType = $currentProduct['sms_type'] ?? '';
                    $smsAmount = $currentProduct['sms_amount'] ?? '';
                    $serviceType = $currentProduct['service_type'] ?? '';
                    $promotions = $currentProduct['promotions'] ?? '';
                    error_log("Debug - Using directly fetched product info for application " . $appId);
                } else {
                    // JOIN?쇰줈 媛?몄삩 ?뺣낫 ?ъ슜
                    $planName = !empty($app['plan_name']) ? $app['plan_name'] : '';
                    $provider = !empty($app['provider']) ? $app['provider'] : '';
                    $priceMain = isset($app['price_main']) && $app['price_main'] !== null && $app['price_main'] !== '' ? (float)$app['price_main'] : 0;
                    $priceAfter = isset($app['price_after']) && $app['price_after'] !== null && $app['price_after'] !== '' ? (float)$app['price_after'] : null;
                    $contractPeriod = !empty($app['contract_period']) ? $app['contract_period'] : '';
                    $discountPeriod = !empty($app['discount_period']) ? $app['discount_period'] : '';
                    $dataAmount = !empty($app['data_amount']) ? $app['data_amount'] : '';
                    $dataAmountValue = !empty($app['data_amount_value']) ? $app['data_amount_value'] : '';
                    $dataUnit = !empty($app['data_unit']) ? $app['data_unit'] : '';
                    $dataAdditional = !empty($app['data_additional']) ? $app['data_additional'] : '';
                    $dataAdditionalValue = !empty($app['data_additional_value']) ? $app['data_additional_value'] : '';
                    $dataExhausted = !empty($app['data_exhausted']) ? $app['data_exhausted'] : '';
                    $dataExhaustedValue = !empty($app['data_exhausted_value']) ? $app['data_exhausted_value'] : '';
                    $callType = !empty($app['call_type']) ? $app['call_type'] : '';
                    $callAmount = !empty($app['call_amount']) ? $app['call_amount'] : '';
                    $smsType = !empty($app['sms_type']) ? $app['sms_type'] : '';
                    $smsAmount = !empty($app['sms_amount']) ? $app['sms_amount'] : '';
                    $serviceType = !empty($app['service_type']) ? $app['service_type'] : '';
                    $promotions = !empty($app['promotions']) ? $app['promotions'] : '';
                    error_log("Debug - Using JOIN product info for application " . ($app['application_id'] ?? 'unknown'));
                }
                
                error_log("Debug - Final plan_name: " . ($planName ?: 'EMPTY'));
                error_log("Debug - Final provider: " . ($provider ?: 'EMPTY'));
            }
            
            // ?곗씠???쒓났???щ㎎??            $dataMain = '';
            if (!empty($dataAmount)) {
                if ($dataAmount === '臾댁젣??) {
                    $dataMain = '臾댁젣??;
                } elseif ($dataAmount === '吏곸젒?낅젰' && !empty($dataAmountValue)) {
                    $dataMain = '??' . number_format((float)$dataAmountValue) . $dataUnit;
                } else {
                    $dataMain = $dataAmount;
                }
                
                if (!empty($dataAdditional) && $dataAdditional !== '?놁쓬') {
                    if ($dataAdditional === '吏곸젒?낅젰' && !empty($dataAdditionalValue)) {
                        $dataMain .= ' + ' . $dataAdditionalValue;
                    } else {
                        $dataMain .= ' + ' . $dataAdditional;
                    }
                }
                
                if (!empty($dataExhausted) && $dataExhausted !== '吏곸젒?낅젰') {
                    $dataMain .= ' + ' . $dataExhausted;
                } elseif (!empty($dataExhausted) && $dataExhausted === '吏곸젒?낅젰' && !empty($dataExhaustedValue)) {
                    $dataMain .= ' + ' . $dataExhaustedValue;
                }
            }
            
            // 湲곕뒫 諛곗뿴 ?앹꽦
            $features = [];
            if (!empty($callType)) {
                if ($callType === '臾댁젣??) {
                    $features[] = '?듯솕 臾댁젣??;
                } elseif ($callType === '湲곕낯?쒓났') {
                    $features[] = '?듯솕 湲곕낯?쒓났';
                } elseif ($callType === '吏곸젒?낅젰' && !empty($callAmount)) {
                    $features[] = '?듯솕 ' . number_format((float)$callAmount) . '遺?;
                }
            }
            
            if (!empty($smsType)) {
                if ($smsType === '臾댁젣??) {
                    $features[] = '臾몄옄 臾댁젣??;
                } elseif ($smsType === '湲곕낯?쒓났') {
                    $features[] = '臾몄옄 湲곕낯?쒓났';
                } elseif ($smsType === '吏곸젒?낅젰' && !empty($smsAmount)) {
                    $features[] = '臾몄옄 ' . number_format((float)$smsAmount) . '嫄?;
                }
            }
            
            if (!empty($provider)) {
                $features[] = $provider;
            }
            
            if (!empty($serviceType)) {
                $features[] = $serviceType;
            }
            
            // 媛寃??щ㎎??            $priceMainFormatted = '';
            if ($priceAfter !== null && $priceAfter !== '' && $priceAfter !== '0') {
                $priceMainFormatted = '??' . number_format((float)$priceAfter) . '??;
            } else {
                $priceMainFormatted = '??' . number_format((float)$priceMain) . '??;
            }
            
            $priceAfterFormatted = '';
            if (!empty($discountPeriod)) {
                $priceAfterFormatted = $discountPeriod . ' ?댄썑 ??' . number_format((float)$priceMain) . '??;
            } else {
                $priceAfterFormatted = '??' . number_format((float)$priceMain) . '??;
            }
            
            // ?꾨줈紐⑥뀡 ?뚯떛
            $gifts = [];
            if (!empty($promotions)) {
                $promotionsArray = json_decode($promotions, true);
                if (is_array($promotionsArray)) {
                    $gifts = array_filter($promotionsArray, function($p) {
                        return !empty(trim($p));
                    });
                }
            }
            
            // 由щ럭 ?묒꽦 ?щ? ?뺤씤 (MVNO??二쇰Ц蹂꾨줈 由щ럭 ?묒꽦 媛??
            error_log("Step 3: Starting review check for application_id: {$appId}");
            $hasReview = false;
            $rating = '';
            if (!empty($app['product_id'])) {
                error_log("Step 3.1: product_id exists: " . $app['product_id']);
                try {
                    // application_id 而щ읆 議댁옱 ?щ? ?뺤씤
                    $hasApplicationId = false;
                    try {
                        $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
                        $hasApplicationId = $checkStmt->rowCount() > 0;
                    } catch (PDOException $e) {}
                    
                    // MVNO??application_id濡?由щ럭 泥댄겕 (二쇰Ц蹂?由щ럭)
                    if ($hasApplicationId && !empty($app['application_id'])) {
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE application_id = :application_id 
                            AND user_id = :user_id 
                            AND product_type = 'mvno'
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':application_id' => $app['application_id'],
                            ':user_id' => $userId
                        ]);
                    } else {
                        // application_id媛 ?녿뒗 寃쎌슦 湲곗〈 諛⑹떇 (?섏쐞 ?명솚??
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE product_id = :product_id 
                            AND user_id = :user_id 
                            AND product_type = 'mvno'
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':product_id' => $app['product_id'],
                            ':user_id' => $userId
                        ]);
                    }
                    $reviewResult = $reviewStmt->fetch(PDO::FETCH_ASSOC);
                    $hasReview = ($reviewResult['count'] ?? 0) > 0;
                    error_log("Step 3.2: Review check completed, hasReview: " . ($hasReview ? 'YES' : 'NO'));
                    
                    // ?됯퇏 蹂꾩젏 媛?몄삤湲?                    error_log("Step 3.3: Starting average rating fetch");
                    if (!function_exists('getProductAverageRating')) {
                        error_log("Step 3.4: getProductAverageRating function does not exist, requiring plan-data.php");
                        $planDataPath = __DIR__ . '/plan-data.php';
                        error_log("Step 3.5: plan-data.php path: {$planDataPath}");
                        error_log("Step 3.6: File exists: " . (file_exists($planDataPath) ? 'YES' : 'NO'));
                        require_once $planDataPath;
                        error_log("Step 3.7: plan-data.php required");
                    }
                    error_log("Step 3.8: Calling getProductAverageRating(" . $app['product_id'] . ", 'mvno')");
                    $averageRating = getProductAverageRating($app['product_id'], 'mvno');
                    error_log("Step 3.9: getProductAverageRating returned: " . var_export($averageRating, true));
                    $rating = $averageRating > 0 ? number_format($averageRating, 1) : '';
                    error_log("Step 3.10: rating formatted: [{$rating}]");
                } catch (Exception $e) {
                    error_log("ERROR Step 3: Exception in review/rating check for application {$appId}");
                    error_log("Exception message: " . $e->getMessage());
                    error_log("Exception code: " . $e->getCode());
                    error_log("Exception file: " . $e->getFile() . ":" . $e->getLine());
                    error_log("Stack trace: " . $e->getTraceAsString());
                    $rating = '';
                }
            } else {
                error_log("Step 3.1: product_id is empty, skipping review check");
            }
            
            // ?곹깭 ?쒓? 蹂??(怨듯넻 ?⑥닔 ?ъ슜)
            error_log("Step 4: Converting application status to Korean");
            error_log("Step 4.1: application_status: " . ($app['application_status'] ?? 'NULL'));
            try {
                $statusKor = getApplicationStatusLabel($app['application_status']);
                error_log("Step 4.2: statusKor: [{$statusKor}]");
            } catch (Exception $e) {
                error_log("ERROR Step 4: Exception in getApplicationStatusLabel: " . $e->getMessage());
                $statusKor = '?묒닔?꾨즺'; // 湲곕낯媛?            }
            
            // 理쒖쥌 媛??뺤씤 濡쒓렇
            error_log("Step 5: Before formatting - planName=[{$planName}], provider=[{$provider}]");
            
            $formattedApplications[] = [
                'id' => (int)$app['product_id'], // ?섏쐞 ?명솚?깆쓣 ?꾪빐 ?좎?
                'product_id' => (int)$app['product_id'], // product_id ??異붽?
                'application_id' => (int)$app['application_id'],
                'seller_id' => (int)($app['seller_id'] ?? 0), // seller_id 異붽?
                'order_number' => $app['order_number'] ?? '',
                'provider' => !empty($provider) ? $provider : '?????놁쓬',
                'rating' => $rating,
                'title' => !empty($planName) ? $planName : '?붽툑???뺣낫 ?놁쓬',
                'data_main' => !empty($dataMain) ? $dataMain : '?곗씠???뺣낫 ?놁쓬',
                'features' => $features,
                'price_main' => !empty($priceMainFormatted) ? $priceMainFormatted : '媛寃??뺣낫 ?놁쓬',
                'price_after' => $priceAfterFormatted,
                'contract_period' => $contractPeriod,
                'discount_period' => $discountPeriod,
                'gifts' => $gifts,
                'gift_count' => count($gifts),
                'order_date' => !empty($app['order_date']) ? date('Y.m.d', strtotime($app['order_date'])) : date('Y.m.d'),
                'activation_date' => '', // 媛쒗넻?쇱? 蹂꾨룄 愿由??꾩슂
                'has_review' => $hasReview,
                'is_sold_out' => ($app['product_status'] ?? 'active') !== 'active',
                'status' => $statusKor,
                'application_status' => $app['application_status']
            ];
            
            $lastIndex = count($formattedApplications) - 1;
            error_log("Step 6: After formatting - index: {$lastIndex}");
            error_log("Step 6.1: formatted provider: [" . $formattedApplications[$lastIndex]['provider'] . "]");
            error_log("Step 6.2: formatted title: [" . $formattedApplications[$lastIndex]['title'] . "]");
            error_log("=== END Processing application #{$processingIndex} (SUCCESS) ===");
            
            } catch (Exception $e) {
                // 媛쒕퀎 ??ぉ ?щ㎎???ㅽ뙣 ?쒖뿉??怨꾩냽 吏꾪뻾
                error_log("=== ERROR Processing application #{$processingIndex} ===");
                error_log("ERROR: Exception in getUserMvnoApplications");
                error_log("ERROR: application_id: " . ($app['application_id'] ?? 'unknown'));
                error_log("ERROR: Exception class: " . get_class($e));
                error_log("ERROR: Exception message: " . $e->getMessage());
                error_log("ERROR: Exception code: " . $e->getCode());
                error_log("ERROR: Exception file: " . $e->getFile());
                error_log("ERROR: Exception line: " . $e->getLine());
                error_log("ERROR: Stack trace:\n" . $e->getTraceAsString());
                error_log("ERROR: Application data keys: " . implode(', ', array_keys($app)));
                error_log("ERROR: Application data preview: " . json_encode(array_slice($app, 0, 5)));
                error_log("ERROR: additional_info exists: " . (isset($app['additional_info']) ? 'YES' : 'NO'));
                if (isset($app['additional_info'])) {
                    error_log("ERROR: additional_info length: " . strlen($app['additional_info']));
                    error_log("ERROR: additional_info preview: " . substr($app['additional_info'], 0, 100));
                }
                error_log("ERROR: product_id: " . ($app['product_id'] ?? 'NULL'));
                error_log("ERROR: Variables at exception time:");
                error_log("ERROR: - planName: [" . (isset($planName) ? $planName : 'NOT_SET') . "]");
                error_log("ERROR: - provider: [" . (isset($provider) ? $provider : 'NOT_SET') . "]");
                error_log("ERROR: - productSnapshot: " . (isset($productSnapshot) ? (is_array($productSnapshot) ? 'ARRAY(' . count($productSnapshot) . ' keys)' : gettype($productSnapshot)) : 'NOT_SET'));
                // 理쒖냼?쒖쓽 ?뺣낫?쇰룄 ?쒖떆
                $formattedApplications[] = [
                    'id' => (int)($app['product_id'] ?? 0),
                    'application_id' => (int)($app['application_id'] ?? 0),
                    'provider' => '?????놁쓬',
                    'rating' => '',
                    'title' => '?붽툑???뺣낫 ?놁쓬',
                    'data_main' => '?곗씠???뺣낫 ?놁쓬',
                    'features' => [],
                    'price_main' => '媛寃??뺣낫 ?놁쓬',
                    'price_after' => '',
                    'gifts' => [],
                    'gift_count' => 0,
                    'order_date' => !empty($app['order_date']) ? date('Y.m.d', strtotime($app['order_date'])) : date('Y.m.d'),
                    'activation_date' => '',
                    'has_review' => false,
                    'is_sold_out' => false,
                    'status' => getApplicationStatusLabel($app['application_status'] ?? 'pending'),
                    'application_status' => $app['application_status'] ?? 'pending'
                ];
            }
        }
        
        return $formattedApplications;
    } catch (PDOException $e) {
        error_log("Error fetching user MVNO applications: " . $e->getMessage());
        return [];
    }
}

/**
 * ?ъ슜?먯쓽 ?듭떊?ы룿 ?좎껌 ?댁뿭 議고쉶
 * @param int $userId ?ъ슜??ID
 * @return array ?좎껌 ?댁뿭 諛곗뿴
 */
function getUserMnoApplications($userId, $limit = null, $offset = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        error_log("getUserMnoApplications: DB connection failed");
        return [];
    }
    
    try {
        // ?붾쾭源? user_id ?뺤씤
        error_log("getUserMnoApplications: userId = " . var_export($userId, true));
        
        $sql = "
            SELECT 
                a.id as application_id,
                a.order_number,
                a.product_id,
                a.application_status,
                a.created_at as order_date,
                p.seller_id,
                c.name,
                c.phone,
                c.email,
                c.additional_info,
                mno.device_name,
                mno.device_price,
                mno.device_capacity,
                mno.device_colors,
                mno.common_provider,
                mno.common_discount_new,
                mno.common_discount_port,
                mno.common_discount_change,
                mno.contract_provider,
                mno.contract_discount_new,
                mno.contract_discount_port,
                mno.contract_discount_change,
                mno.service_type,
                mno.contract_period,
                mno.contract_period_value,
                mno.price_main,
                mno.data_amount,
                mno.data_amount_value,
                mno.data_unit,
                mno.data_exhausted,
                mno.data_exhausted_value,
                mno.call_type,
                mno.call_amount,
                mno.sms_type,
                mno.sms_amount,
                mno.promotions,
                p.status as product_status
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            INNER JOIN products p ON a.product_id = p.id
            LEFT JOIN product_mno_details mno ON p.id = mno.product_id
            WHERE c.user_id = :user_id 
            AND a.product_type = 'mno'
            ORDER BY a.created_at DESC
        ";
        
        if ($limit !== null && $offset !== null) {
            $sql .= " LIMIT :limit OFFSET :offset";
        }
        
        $stmt = $pdo->prepare($sql);
        $params = [':user_id' => $userId];
        if ($limit !== null && $offset !== null) {
            $params[':limit'] = (int)$limit;
            $params[':offset'] = (int)$offset;
        }
        $stmt->execute($params);
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // ?붾쾭源? 荑쇰━ 寃곌낵 ?뺤씤
        error_log("getUserMnoApplications: Found " . count($applications) . " applications for user_id: " . $userId);
        if (count($applications) > 0) {
            error_log("getUserMnoApplications: First application keys: " . implode(', ', array_keys($applications[0])));
            error_log("getUserMnoApplications: First application_id: " . ($applications[0]['application_id'] ?? 'N/A'));
            error_log("getUserMnoApplications: First product_id: " . ($applications[0]['product_id'] ?? 'N/A'));
            error_log("getUserMnoApplications: First additional_info exists: " . (isset($applications[0]['additional_info']) ? 'YES' : 'NO'));
        } else {
            error_log("getUserMnoApplications: No applications found - checking query...");
            // 荑쇰━ ?ъ떎?됲븯???뺤씤
            $testStmt = $pdo->prepare("
                SELECT COUNT(*) as cnt 
                FROM product_applications a
                INNER JOIN application_customers c ON a.id = c.application_id
                WHERE c.user_id = :user_id AND a.product_type = 'mno'
            ");
            $testStmt->execute([':user_id' => $userId]);
            $testResult = $testStmt->fetch(PDO::FETCH_ASSOC);
            error_log("getUserMnoApplications: Test query count: " . ($testResult['cnt'] ?? 0));
        }
        
        // ?곗씠???щ㎎??        $formattedApplications = [];
        foreach ($applications as $index => $app) {
            try {
            // additional_info ?뚯떛
            $additionalInfo = [];
            if (!empty($app['additional_info'])) {
                $additionalInfo = json_decode($app['additional_info'], true) ?: [];
            }
            
            // ?곹뭹 ?ㅻ깄?룹씠 ?덉쑝硫??ъ슜 (?좎껌 ?뱀떆 ?곹뭹 ?뺣낫)
            $productSnapshot = $additionalInfo['product_snapshot'] ?? null;
            if ($productSnapshot) {
                $deviceName = $productSnapshot['device_name'] ?? $app['device_name'] ?? '';
                $devicePrice = $productSnapshot['device_price'] ?? $app['device_price'] ?? '';
                $deviceCapacity = $productSnapshot['device_capacity'] ?? $app['device_capacity'] ?? '';
                $commonProvider = $productSnapshot['common_provider'] ?? $app['common_provider'] ?? '';
                $priceMain = $productSnapshot['price_main'] ?? $app['price_main'] ?? 0;
                $dataAmount = $productSnapshot['data_amount'] ?? $app['data_amount'] ?? '';
                $callType = $productSnapshot['call_type'] ?? $app['call_type'] ?? '';
                $promotions = $productSnapshot['promotions'] ?? $app['promotions'] ?? '';
            } else {
                $deviceName = $app['device_name'] ?? '';
                $devicePrice = $app['device_price'] ?? '';
                $deviceCapacity = $app['device_capacity'] ?? '';
                $commonProvider = $app['common_provider'] ?? '';
                $priceMain = $app['price_main'] ?? 0;
                $dataAmount = $app['data_amount'] ?? '';
                $callType = $app['call_type'] ?? '';
                $promotions = $app['promotions'] ?? '';
            }
            
            // ?듭떊??異붿텧 (additional_info?먯꽌 carrier ?뺣낫 ?곗꽑 ?ъ슜)
            $provider = 'SKT';
            if (!empty($additionalInfo['carrier'])) {
                $provider = $additionalInfo['carrier'];
            } else if (!empty($commonProvider)) {
                $commonProviderArray = json_decode($commonProvider, true);
                if (is_array($commonProviderArray) && !empty($commonProviderArray)) {
                    $provider = $commonProviderArray[0] ?? 'SKT';
                }
            }
            
            // ?붽툑?쒕챸 ?앹꽦 (product_snapshot?먯꽌 媛?몄삩 ?뺣낫 ?ъ슜)
            $planName = $provider . ' ' . ($dataAmount ?: '湲곕낯 ?붽툑??);
            if (empty($dataAmount) && empty($planName)) {
                $planName = $provider . ' ?붽툑??;
            }
            
            // 媛寃??щ㎎??(additional_info?먯꽌 price ?뺣낫 ?곗꽑 ?ъ슜)
            $displayPrice = $priceMain;
            if (isset($additionalInfo['price']) && $additionalInfo['price'] !== '' && $additionalInfo['price'] !== '0') {
                $displayPrice = (float)$additionalInfo['price'];
            }
            $priceFormatted = '??' . number_format((float)$displayPrice) . '??;
            if ($displayPrice == 0 || empty($displayPrice)) {
                $priceFormatted = '?붽툑 ?뺣낫 ?놁쓬';
            }
            
            // ?됱긽 ?뺣낫 異붿텧
            $deviceColor = '';
            if (!empty($additionalInfo['device_colors']) && is_array($additionalInfo['device_colors']) && count($additionalInfo['device_colors']) > 0) {
                $deviceColor = $additionalInfo['device_colors'][0];
            }
            
            // ?좎씤 ?뺣낫 異붿텧
            $discountType = $additionalInfo['discount_type'] ?? '';
            $subscriptionType = $additionalInfo['subscription_type'] ?? '';
            $discountPrice = $additionalInfo['price'] ?? '';
            
            // 媛?낇삎???쒓? 蹂??            $subscriptionTypeMap = [
                'new' => '?좉퇋媛??,
                'mnp' => '踰덊샇?대룞',
                'port' => '踰덊샇?대룞', // ?섏쐞 ?명솚??                'change' => '湲곌린蹂寃?
            ];
            $subscriptionTypeKor = $subscriptionTypeMap[strtolower($subscriptionType)] ?? $subscriptionType;
            
            $discountInfo = '';
            if ($discountType && $subscriptionType && $discountPrice !== '') {
                // 媛寃⑹씠 0?댁뼱???쒖떆
                $discountInfo = $provider . ' ' . $discountType . ' ' . $subscriptionTypeKor . ' ' . $discountPrice;
            }
            
            // ?꾨줈紐⑥뀡 ?뚯떛
            $gifts = [];
            if (!empty($promotions)) {
                $promotionsArray = json_decode($promotions, true);
                if (is_array($promotionsArray)) {
                    $gifts = array_filter($promotionsArray, function($p) {
                        return !empty(trim($p));
                    });
                }
            }
            
            // 由щ럭 ?묒꽦 ?щ? ?뺤씤 (MNO??二쇰Ц蹂꾨줈 由щ럭 ?묒꽦 媛??
            $hasReview = false;
            $rating = '';
            if (!empty($app['product_id'])) {
                try {
                    // application_id 而щ읆 議댁옱 ?щ? ?뺤씤
                    $hasApplicationId = false;
                    try {
                        $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
                        $hasApplicationId = $checkStmt->rowCount() > 0;
                    } catch (PDOException $e) {}
                    
                    // MNO??application_id濡?由щ럭 泥댄겕 (二쇰Ц蹂?由щ럭)
                    if ($hasApplicationId && !empty($app['application_id'])) {
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE application_id = :application_id 
                            AND user_id = :user_id 
                            AND product_type = 'mno'
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':application_id' => $app['application_id'],
                            ':user_id' => $userId
                        ]);
                    } else {
                        // application_id媛 ?녿뒗 寃쎌슦 湲곗〈 諛⑹떇 (?섏쐞 ?명솚??
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE product_id = :product_id 
                            AND user_id = :user_id 
                            AND product_type = 'mno'
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':product_id' => $app['product_id'],
                            ':user_id' => $userId
                        ]);
                    }
                    $reviewResult = $reviewStmt->fetch(PDO::FETCH_ASSOC);
                    $hasReview = ($reviewResult['count'] ?? 0) > 0;
                    
                    // ?됯퇏 蹂꾩젏 媛?몄삤湲?(?좏깮?ы빆, ?먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾)
                    try {
                        if (!function_exists('getProductAverageRating')) {
                            $planDataFile = __DIR__ . '/plan-data.php';
                            if (file_exists($planDataFile)) {
                                require_once $planDataFile;
                            }
                        }
                        if (function_exists('getProductAverageRating')) {
                            $averageRating = getProductAverageRating($app['product_id'], 'mno');
                            $rating = $averageRating > 0 ? number_format($averageRating, 1) : '';
                        }
                    } catch (Exception $e) {
                        error_log("Error getting average rating for product {$app['product_id']}: " . $e->getMessage());
                        // ?먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾
                    }
                } catch (Exception $e) {
                    error_log("Error fetching review info for product {$app['product_id']}: " . $e->getMessage());
                    // ?먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾
                }
            }
            
            // ?곹깭 ?쒓? 蹂??(怨듯넻 ?⑥닔 ?ъ슜 - ?듭씪???⑹뼱)
            $statusKor = getApplicationStatusLabel($app['application_status'] ?? 'pending');
            
            $formattedApplications[] = [
                'id' => (int)$app['product_id'],
                'product_id' => (int)$app['product_id'], // product_id ??異붽?
                'application_id' => (int)$app['application_id'],
                'seller_id' => (int)($app['seller_id'] ?? 0), // seller_id 異붽? (MVNO? ?숈씪?섍쾶)
                'order_number' => $app['order_number'] ?? null,
                'provider' => $provider,
                'device_name' => $deviceName,
                'device_storage' => $deviceCapacity,
                'device_price' => $devicePrice ? number_format((float)$devicePrice) . '?? : '',
                'device_color' => $deviceColor,
                'discount_info' => $discountInfo,
                'plan_name' => $planName,
                'price' => $priceFormatted,
                'company_name' => '?댁빞湲곕え諛붿씪', // 湲곕낯媛?                'rating' => $rating,
                'order_date' => !empty($app['order_date']) ? date('Y.m.d', strtotime($app['order_date'])) : '',
                'order_time' => !empty($app['order_date']) ? date('H:i', strtotime($app['order_date'])) : '',
                'activation_date' => '', // 媛쒗넻?쇱? 蹂꾨룄 愿由??꾩슂
                'activation_time' => '',
                'has_review' => $hasReview,
                'is_sold_out' => ($app['product_status'] ?? 'active') !== 'active',
                'status' => $statusKor,
                'application_status' => $app['application_status'],
                'gifts' => $gifts,
                'link_url' => '/MVNO/mno/mno-phone-detail.php?id=' . $app['product_id']
            ];
            } catch (Exception $e) {
                error_log("Error formatting application #{$index} (application_id: " . ($app['application_id'] ?? 'unknown') . "): " . $e->getMessage());
                error_log("Application data: " . json_encode($app, JSON_UNESCAPED_UNICODE));
                // ?먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾
                continue;
            }
        }
        
        error_log("getUserMnoApplications: Formatted " . count($formattedApplications) . " applications");
        error_log("getUserMnoApplications: Returning array with " . count($formattedApplications) . " items");
        if (count($formattedApplications) > 0) {
            error_log("getUserMnoApplications: First formatted item keys: " . implode(', ', array_keys($formattedApplications[0])));
        }
        return $formattedApplications;
    } catch (PDOException $e) {
        error_log("Error fetching user MNO applications: " . $e->getMessage());
        error_log("Error trace: " . $e->getTraceAsString());
        return [];
    } catch (Exception $e) {
        error_log("General error in getUserMnoApplications: " . $e->getMessage());
        return [];
    }
}

/**
 * ?ъ슜?먯쓽 ?명꽣???좎껌 ?댁뿭 議고쉶
 * @param int $userId ?ъ슜??ID
 * @return array ?좎껌 ?댁뿭 諛곗뿴
 */
function getUserInternetApplications($userId, $limit = null, $offset = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        error_log("getUserInternetApplications: Database connection failed for user_id: " . $userId);
        return [];
    }
    
    try {
        error_log("getUserInternetApplications: Querying for user_id: " . $userId);
        $sql = "
            SELECT 
                a.id as application_id,
                a.order_number,
                a.product_id,
                a.application_status,
                a.created_at as order_date,
                p.seller_id,
                c.name,
                c.phone,
                c.email,
                c.additional_info,
                internet.registration_place,
                internet.service_type,
                internet.speed_option,
                internet.monthly_fee,
                internet.cash_payment_names,
                internet.cash_payment_prices,
                internet.gift_card_names,
                internet.gift_card_prices,
                internet.equipment_names,
                internet.equipment_prices,
                internet.installation_names,
                internet.installation_prices,
                p.status as product_status
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            INNER JOIN products p ON a.product_id = p.id
            LEFT JOIN product_internet_details internet ON p.id = internet.product_id
            WHERE c.user_id = :user_id 
            AND a.product_type = 'internet'
            ORDER BY a.created_at DESC
        ";
        
        if ($limit !== null && $offset !== null) {
            $sql .= " LIMIT :limit OFFSET :offset";
        }
        
        $stmt = $pdo->prepare($sql);
        $params = [':user_id' => $userId];
        if ($limit !== null && $offset !== null) {
            $params[':limit'] = (int)$limit;
            $params[':offset'] = (int)$offset;
        }
        $stmt->execute($params);
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        error_log("getUserInternetApplications: Found " . count($applications) . " raw applications for user_id: " . $userId);
        
        if (count($applications) > 0) {
            error_log("getUserInternetApplications: First application keys: " . implode(', ', array_keys($applications[0])));
            error_log("getUserInternetApplications: First application application_id: " . ($applications[0]['application_id'] ?? 'N/A'));
            error_log("getUserInternetApplications: First application has additional_info: " . (!empty($applications[0]['additional_info']) ? 'yes (' . strlen($applications[0]['additional_info']) . ' chars)' : 'no'));
            if (!empty($applications[0]['additional_info'])) {
                error_log("getUserInternetApplications: First application additional_info preview: " . substr($applications[0]['additional_info'], 0, 100));
            }
        } else {
            error_log("getUserInternetApplications: WARNING - No applications found for user_id: " . $userId);
            error_log("getUserInternetApplications: Query executed but returned 0 results. Check if user_id matches.");
        }
        
        // ?곗씠???щ㎎??        $formattedApplications = [];
        foreach ($applications as $index => $app) {
            try {
                error_log("getUserInternetApplications: Processing application " . ($index + 1) . " (application_id: " . ($app['application_id'] ?? 'unknown') . ")");
                
                // additional_info ?뚯떛
                $additionalInfo = [];
            if (!empty($app['additional_info'])) {
                // JSON 臾몄옄?댁씠 ?댁뒪耳?댄봽??寃쎌슦 泥섎━
                $additionalInfoStr = $app['additional_info'];
                
                // ?ㅼ젣 以꾨컮轅?臾몄옄 ?쒓굅 (JSON ?뚯떛 ?꾩뿉)
                $additionalInfoStr = str_replace(["\n", "\r", "\t"], ['', '', ''], $additionalInfoStr);
                
                // JSON ?뚯떛 ?쒕룄
                $additionalInfo = json_decode($additionalInfoStr, true);
                
                if (json_last_error() !== JSON_ERROR_NONE) {
                    // JSON ?뚯떛 ?ㅽ뙣 ??鍮?諛곗뿴
                    error_log("JSON decode error for application_id " . ($app['application_id'] ?? 'unknown') . ": " . json_last_error_msg() . " | JSON: " . substr($additionalInfoStr, 0, 200));
                    $additionalInfo = [];
                } else {
                    error_log("JSON decode success for application_id " . ($app['application_id'] ?? 'unknown'));
                    // product_snapshot ?뺤씤
                    if (isset($additionalInfo['product_snapshot'])) {
                        error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - product_snapshot found in additional_info");
                        if (isset($additionalInfo['product_snapshot']['registration_place'])) {
                            error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - product_snapshot.registration_place = '" . $additionalInfo['product_snapshot']['registration_place'] . "'");
                        } else {
                            error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - product_snapshot.registration_place NOT FOUND");
                        }
                    } else {
                        error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - product_snapshot NOT FOUND in additional_info");
                    }
                }
            } else {
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - additional_info is empty");
            }
            
            // ?좎껌 ?쒖젏???곹뭹 ?뺣낫瑜??곗꽑 ?ъ슜 (product_snapshot)
            // ?ъ슜?먭? ?좎껌?덈뜕 ?뱀떆??媛믪씠 ?섏쨷??蹂寃쎈릺?대룄 ?좎??섏뼱????            $productSnapshot = $additionalInfo['product_snapshot'] ?? null;
            $hasSnapshot = $productSnapshot && !empty($productSnapshot);
            error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - productSnapshot exists: " . ($hasSnapshot ? 'yes' : 'no'));
            if ($hasSnapshot) {
                $snapshotRegPlace = $productSnapshot['registration_place'] ?? null;
                $tableRegPlace = $app['registration_place'] ?? null;
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - snapshot registration_place: " . ($snapshotRegPlace !== null ? "'" . $snapshotRegPlace . "'" : 'NULL'));
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - table registration_place: " . ($tableRegPlace !== null ? "'" . $tableRegPlace . "'" : 'NULL'));
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - snapshot has registration_place key: " . (isset($productSnapshot['registration_place']) ? 'yes' : 'no'));
            }
            
            // monthly_fee 異붿텧 ?ы띁 ?⑥닔 (?レ옄 ?먮뒗 臾몄옄?댁뿉???レ옄 異붿텧)
            $extractMonthlyFee = function($value) {
                if (empty($value) && $value !== '0' && $value !== 0) {
                    return 0;
                }
                // ?レ옄??寃쎌슦
                if (is_numeric($value)) {
                    $num = (float)$value;
                    return $num > 0 ? $num : 0;
                }
                // 臾몄옄?댁씤 寃쎌슦 (?? "26400??, "26,400??)
                if (is_string($value)) {
                    // ?レ옄? ?쇳몴留?異붿텧
                    $numericPart = preg_replace('/[^0-9,]/', '', $value);
                    $numericPart = str_replace(',', '', $numericPart);
                    if (!empty($numericPart) && is_numeric($numericPart)) {
                        $num = (float)$numericPart;
                        return $num > 0 ? $num : 0;
                    }
                }
                return 0;
            };
            
            // ??λ맂 ?좎껌 ?쒖젏 ?뺣낫(product_snapshot)瑜??곗꽑 ?ъ슜, ?놁쑝硫??꾩옱 ?뚯씠釉?媛??ъ슜
            // 媛꾨떒??濡쒖쭅: product_snapshot???덉쑝硫?臾댁“嫄?洹멸쾬???ъ슜
            if ($hasSnapshot) {
                // product_snapshot????λ맂 ?뺣낫瑜?洹몃?濡??ъ슜 (?좎껌 ?쒖젏???뺣낫)
                $registrationPlace = isset($productSnapshot['registration_place']) ? trim($productSnapshot['registration_place']) : '';
                $speedOption = isset($productSnapshot['speed_option']) ? trim($productSnapshot['speed_option']) : '';
                $serviceType = isset($productSnapshot['service_type']) ? trim($productSnapshot['service_type']) : '';
                $monthlyFee = isset($productSnapshot['monthly_fee']) ? $extractMonthlyFee($productSnapshot['monthly_fee']) : 0;
                
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - snapshot registration_place: " . (isset($productSnapshot['registration_place']) ? "'" . $productSnapshot['registration_place'] . "'" : 'NOT SET'));
                error_log("getUserInternetApplications: application_id " . ($app['application_id'] ?? 'unknown') . " - final registration_place: " . $registrationPlace);
                
                // ?꾧툑吏湲? ?곹뭹沅? ?λ퉬, ?ㅼ튂 ?뺣낫???좎껌 ?쒖젏 ?뺣낫 ?ъ슜
                if (isset($productSnapshot['cash_payment_names'])) {
                    if (is_string($productSnapshot['cash_payment_names'])) {
                        $decoded = json_decode($productSnapshot['cash_payment_names'], true);
                        $cashPaymentNames = is_array($decoded) ? implode(', ', $decoded) : $productSnapshot['cash_payment_names'];
                    } else {
                        $cashPaymentNames = is_array($productSnapshot['cash_payment_names']) ? implode(', ', $productSnapshot['cash_payment_names']) : '';
                    }
                } else {
                    $cashPaymentNames = '';
                }
                
                if (isset($productSnapshot['gift_card_names'])) {
                    if (is_string($productSnapshot['gift_card_names'])) {
                        $decoded = json_decode($productSnapshot['gift_card_names'], true);
                        $giftCardNames = is_array($decoded) ? implode(', ', $decoded) : $productSnapshot['gift_card_names'];
                    } else {
                        $giftCardNames = is_array($productSnapshot['gift_card_names']) ? implode(', ', $productSnapshot['gift_card_names']) : '';
                    }
                } else {
                    $giftCardNames = '';
                }
                
                if (isset($productSnapshot['equipment_names'])) {
                    if (is_string($productSnapshot['equipment_names'])) {
                        $decoded = json_decode($productSnapshot['equipment_names'], true);
                        $equipmentNames = is_array($decoded) ? implode(', ', $decoded) : $productSnapshot['equipment_names'];
                    } else {
                        $equipmentNames = is_array($productSnapshot['equipment_names']) ? implode(', ', $productSnapshot['equipment_names']) : '';
                    }
                } else {
                    $equipmentNames = '';
                }
                
                if (isset($productSnapshot['installation_names'])) {
                    if (is_string($productSnapshot['installation_names'])) {
                        $decoded = json_decode($productSnapshot['installation_names'], true);
                        $installationNames = is_array($decoded) ? implode(', ', $decoded) : $productSnapshot['installation_names'];
                    } else {
                        $installationNames = is_array($productSnapshot['installation_names']) ? implode(', ', $productSnapshot['installation_names']) : '';
                    }
                } else {
                    $installationNames = '';
                }
            } elseif (!empty($app['registration_place']) || !empty($app['service_type']) || !empty($app['speed_option']) || isset($app['monthly_fee'])) {
                // product_snapshot???놁쑝硫??꾩옱 ?뚯씠釉?媛??ъ슜 (fallback)
                $registrationPlace = $app['registration_place'] ?? '';
                $speedOption = $app['speed_option'] ?? '';
                $serviceType = $app['service_type'] ?? '';
                $monthlyFee = $extractMonthlyFee($app['monthly_fee'] ?? 0);
                
                // ?꾧툑吏湲? ?곹뭹沅? ?λ퉬, ?ㅼ튂 ?뺣낫???꾩옱 ?뚯씠釉?媛??ъ슜
                $cashPaymentNames = $app['cash_payment_names'] ?? '';
                $giftCardNames = $app['gift_card_names'] ?? '';
                $equipmentNames = $app['equipment_names'] ?? '';
                $installationNames = $app['installation_names'] ?? '';
            } else {
                // ?????놁쑝硫?鍮?媛?                $registrationPlace = '';
                $speedOption = '';
                $serviceType = '';
                $monthlyFee = 0;
                $cashPaymentNames = '';
                $giftCardNames = '';
                $equipmentNames = '';
                $installationNames = '';
            }
            
            // ?붽툑?쒕챸 ?앹꽦 (DB????λ맂 service_type 洹몃?濡??ъ슜)
            if (!empty($serviceType)) {
                $planName = $serviceType;
            } else {
                // service_type???놁쑝硫?湲곕낯 ?앹꽦
                $planName = '?명꽣??' . ($speedOption ?: '湲곕낯');
                if (!empty($cashPaymentNames) || !empty($giftCardNames) || !empty($equipmentNames) || !empty($installationNames)) {
                    $planName .= ' + TV';
                }
            }
            
            // 媛寃??щ㎎??            $priceFormatted = '??' . number_format((float)$monthlyFee) . '??;
            
            // ?띾룄 ?щ㎎??            $speedFormatted = $speedOption ?: '100MB';
            
            // 由щ럭 ?묒꽦 ?щ? ?뺤씤 (?뚯씠釉붿씠 ?놁쓣 ???덉쑝誘濡?try-catch濡?泥섎━)
            $hasReview = false;
            $reviewCount = 0;
            if (!empty($app['product_id'])) {
                try {
                    // application_id 而щ읆 議댁옱 ?щ? ?뺤씤
                    $hasApplicationId = false;
                    try {
                        $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
                        $hasApplicationId = $checkStmt->rowCount() > 0;
                    } catch (PDOException $e) {}
                    
                    // application_id媛 ?덉쑝硫?application_id濡?議고쉶, ?놁쑝硫?product_id濡?議고쉶
                    if ($hasApplicationId && !empty($app['application_id'])) {
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE product_id = :product_id
                            AND user_id = :user_id
                            AND application_id = :application_id
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':product_id' => $app['product_id'],
                            ':user_id' => $userId,
                            ':application_id' => $app['application_id']
                        ]);
                    } else {
                        $reviewStmt = $pdo->prepare("
                            SELECT COUNT(*) as count
                            FROM product_reviews
                            WHERE product_id = :product_id
                            AND user_id = :user_id
                            AND status = 'approved'
                        ");
                        $reviewStmt->execute([
                            ':product_id' => $app['product_id'],
                            ':user_id' => $userId
                        ]);
                    }
                    $reviewResult = $reviewStmt->fetch(PDO::FETCH_ASSOC);
                    $hasReview = ($reviewResult['count'] ?? 0) > 0;
                    
                    // ?꾩껜 由щ럭 媛쒖닔
                    $allReviewStmt = $pdo->prepare("
                        SELECT COUNT(*) as count
                        FROM product_reviews
                        WHERE product_id = :product_id 
                        AND status = 'approved'
                    ");
                    $allReviewStmt->execute([':product_id' => $app['product_id']]);
                    $allReviewResult = $allReviewStmt->fetch(PDO::FETCH_ASSOC);
                    $reviewCount = (int)($allReviewResult['count'] ?? 0);
                } catch (PDOException $e) {
                    // product_reviews ?뚯씠釉붿씠 ?녾굅???먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾
                    error_log("getUserInternetApplications: Could not fetch reviews for application_id " . ($app['application_id'] ?? 'unknown') . ": " . $e->getMessage());
                    $hasReview = false;
                    $reviewCount = 0;
                }
            }
            
            // 湲곗〈 ?명꽣???뚯꽑 ?뺣낫 媛?몄삤湲?(additional_info?먯꽌)
            $existingCompany = '';
            if (!empty($additionalInfo)) {
                $existingCompany = $additionalInfo['currentCompany'] ?? $additionalInfo['existing_company'] ?? $additionalInfo['existingCompany'] ?? '';
            }
            
            // ?곹깭 ?쒓? 蹂??(怨듯넻 ?⑥닔 ?ъ슜 - ?뚮쑑?곌낵 ?숈씪)
            $statusKor = getApplicationStatusLabel($app['application_status']);
            
            $formattedApplications[] = [
                'id' => (int)$app['product_id'],
                'product_id' => (int)$app['product_id'],
                'application_id' => (int)$app['application_id'],
                'order_number' => $app['order_number'] ?? null,
                'provider' => $registrationPlace,
                'plan_name' => $planName,
                'speed' => $speedFormatted,
                'tv_combined' => !empty($cashPaymentNames) || !empty($giftCardNames) || !empty($equipmentNames) || !empty($installationNames),
                'price' => $priceFormatted,
                'installation_fee' => '臾대즺',
                'order_date' => $app['order_date'], // ?먮낯 ?좎쭨 ?뺤떇 ?좎? (而댄룷?뚰듃?먯꽌 ?щ㎎??
                'installation_date' => '', // ?ㅼ튂?쇱? 蹂꾨룄 愿由??꾩슂
                'application_status' => $app['application_status'] ?? '', // ?먮낯 ?곹깭 媛?                'status' => $statusKor, // ?쒓? ?곹깭 ?쒖떆
                'has_review' => $hasReview,
                'review_count' => $reviewCount,
                'is_sold_out' => ($app['product_status'] ?? 'active') !== 'active',
                'status' => $statusKor,
                'application_status' => $app['application_status'],
                'existing_company' => $existingCompany
            ];
            
            error_log("getUserInternetApplications: Successfully formatted application_id " . ($app['application_id'] ?? 'unknown') . " - provider: " . $registrationPlace . ", plan_name: " . $planName);
            } catch (Exception $e) {
                error_log("getUserInternetApplications: Error processing application " . ($app['application_id'] ?? 'unknown') . ": " . $e->getMessage());
                // ?먮윭媛 諛쒖깮?대룄 怨꾩냽 吏꾪뻾
                continue;
            }
        }
        
        error_log("getUserInternetApplications: Returning " . count($formattedApplications) . " formatted applications for user_id: " . $userId);
        return $formattedApplications;
    } catch (PDOException $e) {
        error_log("Error fetching user Internet applications for user_id " . $userId . ": " . $e->getMessage());
        error_log("Error trace: " . $e->getTraceAsString());
        return [];
    }
}

/**
 * ?ъ슜?먯쓽 ?듭떊?щ떒?낆쑀???좎껌 ?댁뿭 議고쉶
 * @param int $userId ?ъ슜??ID
 * @return array ?좎껌 ?댁뿭 諛곗뿴
 */
function getUserMnoSimApplications($userId, $limit = null, $offset = null) {
    $pdo = getDBConnection();
    if (!$pdo) {
        error_log("getUserMnoSimApplications: DB connection failed");
        return [];
    }
    
    try {
        $sql = "
            SELECT 
                a.id as application_id,
                a.order_number,
                a.product_id,
                a.application_status,
                a.created_at as order_date,
                p.seller_id,
                c.name,
                c.phone,
                c.email,
                c.additional_info,
                mno_sim.provider,
                mno_sim.service_type,
                mno_sim.plan_name,
                mno_sim.contract_period,
                mno_sim.contract_period_discount_value,
                mno_sim.contract_period_discount_unit,
                mno_sim.price_main,
                mno_sim.price_main_unit,
                mno_sim.discount_period,
                mno_sim.discount_period_value,
                mno_sim.discount_period_unit,
                mno_sim.price_after_type,
                mno_sim.price_after,
                mno_sim.price_after_unit,
                mno_sim.data_amount,
                mno_sim.data_amount_value,
                mno_sim.data_unit,
                mno_sim.data_additional,
                mno_sim.data_additional_value,
                mno_sim.data_exhausted,
                mno_sim.data_exhausted_value,
                mno_sim.call_type,
                mno_sim.call_amount,
                mno_sim.call_amount_unit,
                mno_sim.sms_type,
                mno_sim.sms_amount,
                mno_sim.sms_amount_unit,
                mno_sim.promotions,
                mno_sim.benefits,
                mno_sim.promotion_title,
                mno_sim.plan_maintenance_period_type,
                mno_sim.plan_maintenance_period_prefix,
                mno_sim.plan_maintenance_period_value,
                mno_sim.plan_maintenance_period_unit,
                mno_sim.sim_change_restriction_period_type,
                mno_sim.sim_change_restriction_period_prefix,
                mno_sim.sim_change_restriction_period_value,
                mno_sim.sim_change_restriction_period_unit,
                p.status as product_status
            FROM product_applications a
            INNER JOIN (
                SELECT c1.application_id, c1.id, c1.user_id, c1.additional_info, c1.name, c1.phone, c1.email
                FROM application_customers c1
                INNER JOIN (
                    SELECT application_id, MAX(id) as max_id
                    FROM application_customers
                    GROUP BY application_id
                ) c2 ON c1.application_id = c2.application_id AND c1.id = c2.max_id
            ) c ON a.id = c.application_id
            INNER JOIN products p ON a.product_id = p.id
            LEFT JOIN product_mno_sim_details mno_sim ON p.id = mno_sim.product_id
            WHERE c.user_id = :user_id 
            AND a.product_type = 'mno-sim'
            ORDER BY a.created_at DESC
        ";
        
        if ($limit !== null && $offset !== null) {
            $sql .= " LIMIT :limit OFFSET :offset";
        }
        
        $stmt = $pdo->prepare($sql);
        $params = [':user_id' => $userId];
        if ($limit !== null && $offset !== null) {
            $params[':limit'] = (int)$limit;
            $params[':offset'] = (int)$offset;
        }
        $stmt->execute($params);
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // ?곗씠???щ㎎??        $formattedApplications = [];
        foreach ($applications as $app) {
            try {
                // additional_info ?뚯떛
                $additionalInfo = [];
                $productSnapshot = null;
                
                if (!empty($app['additional_info'])) {
                    $decoded = json_decode($app['additional_info'], true);
                    if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
                        $additionalInfo = $decoded;
                        $productSnapshot = $additionalInfo['product_snapshot'] ?? null;
                    }
                }
                
                // ?곹뭹 ?뺣낫 蹂??珥덇린??                $planName = '';
                $provider = '';
                $priceMain = 0;
                $priceAfter = null;
                $priceAfterType = null;
                $contractPeriod = '';
                $contractPeriodValue = '';
                $contractPeriodUnit = '';
                $discountPeriod = '';
                $discountPeriodValue = '';
                $discountPeriodUnit = '';
                $dataAmount = '';
                $dataAmountValue = '';
                $dataUnit = '';
                $dataAdditional = '';
                $dataAdditionalValue = '';
                $dataExhausted = '';
                $dataExhaustedValue = '';
                $callType = '';
                $callAmount = '';
                $callAmountUnit = '';
                $smsType = '';
                $smsAmount = '';
                $smsAmountUnit = '';
                $serviceType = '';
                $promotions = '';
                $promotionTitle = '';
                $priceMainUnit = '';
                $priceAfterUnit = '';
                $planMaintenancePeriodType = '';
                $planMaintenancePeriodPrefix = '';
                $planMaintenancePeriodValue = '';
                $planMaintenancePeriodUnit = '';
                $simChangeRestrictionPeriodType = '';
                $simChangeRestrictionPeriodPrefix = '';
                $simChangeRestrictionPeriodValue = '';
                $simChangeRestrictionPeriodUnit = '';
                
                // product_snapshot???덉쑝硫??곗꽑 ?ъ슜 (?좎껌 ?뱀떆 ?곹뭹 ?뺣낫)
                if (!empty($productSnapshot) && is_array($productSnapshot)) {
                    $planName = $productSnapshot['plan_name'] ?? '';
                    $provider = $productSnapshot['provider'] ?? '';
                    $priceMain = isset($productSnapshot['price_main']) && is_numeric($productSnapshot['price_main']) ? (float)$productSnapshot['price_main'] : 0;
                    $priceAfter = isset($productSnapshot['price_after']) && $productSnapshot['price_after'] !== null && $productSnapshot['price_after'] !== '' && $productSnapshot['price_after'] != '0' ? (float)$productSnapshot['price_after'] : null;
                    $priceAfterType = $productSnapshot['price_after_type'] ?? null;
                    $contractPeriod = $productSnapshot['contract_period'] ?? '';
                    $contractPeriodValue = $productSnapshot['contract_period_discount_value'] ?? '';
                    $contractPeriodUnit = $productSnapshot['contract_period_discount_unit'] ?? '';
                    $discountPeriod = $productSnapshot['discount_period'] ?? '';
                    $discountPeriodValue = $productSnapshot['discount_period_value'] ?? '';
                    $discountPeriodUnit = $productSnapshot['discount_period_unit'] ?? '';
                    $dataAmount = $productSnapshot['data_amount'] ?? '';
                    $dataAmountValue = $productSnapshot['data_amount_value'] ?? '';
                    $dataUnit = $productSnapshot['data_unit'] ?? '';
                    $dataAdditional = $productSnapshot['data_additional'] ?? '';
                    $dataAdditionalValue = $productSnapshot['data_additional_value'] ?? '';
                    $dataExhausted = $productSnapshot['data_exhausted'] ?? '';
                    $dataExhaustedValue = $productSnapshot['data_exhausted_value'] ?? '';
                    $callType = $productSnapshot['call_type'] ?? '';
                    $callAmount = $productSnapshot['call_amount'] ?? '';
                    $callAmountUnit = $productSnapshot['call_amount_unit'] ?? '遺?;
                    $smsType = $productSnapshot['sms_type'] ?? '';
                    $smsAmount = $productSnapshot['sms_amount'] ?? '';
                    $smsAmountUnit = $productSnapshot['sms_amount_unit'] ?? '嫄?;
                    $serviceType = $productSnapshot['service_type'] ?? '';
                    $promotions = isset($productSnapshot['promotions']) ? (is_string($productSnapshot['promotions']) ? $productSnapshot['promotions'] : json_encode($productSnapshot['promotions'])) : '';
                    $promotionTitle = $productSnapshot['promotion_title'] ?? '';
                    $priceMainUnit = $productSnapshot['price_main_unit'] ?? '??;
                    $priceAfterUnit = $productSnapshot['price_after_unit'] ?? '??;
                    $planMaintenancePeriodType = $productSnapshot['plan_maintenance_period_type'] ?? '';
                    $planMaintenancePeriodPrefix = $productSnapshot['plan_maintenance_period_prefix'] ?? '';
                    $planMaintenancePeriodValue = $productSnapshot['plan_maintenance_period_value'] ?? '';
                    $planMaintenancePeriodUnit = $productSnapshot['plan_maintenance_period_unit'] ?? '';
                    $simChangeRestrictionPeriodType = $productSnapshot['sim_change_restriction_period_type'] ?? '';
                    $simChangeRestrictionPeriodPrefix = $productSnapshot['sim_change_restriction_period_prefix'] ?? '';
                    $simChangeRestrictionPeriodValue = $productSnapshot['sim_change_restriction_period_value'] ?? '';
                    $simChangeRestrictionPeriodUnit = $productSnapshot['sim_change_restriction_period_unit'] ?? '';
                } else {
                    // product_snapshot???놁쑝硫??꾩옱 ?곹뭹 ?뺣낫 ?ъ슜
                    $planName = $app['plan_name'] ?? '';
                    $provider = $app['provider'] ?? '';
                    $priceMain = isset($app['price_main']) && $app['price_main'] !== null && $app['price_main'] !== '' ? (float)$app['price_main'] : 0;
                    $priceAfter = isset($app['price_after']) && $app['price_after'] !== null && $app['price_after'] !== '' && $app['price_after'] != '0' ? (float)$app['price_after'] : null;
                    $priceAfterType = $app['price_after_type'] ?? null;
                    $contractPeriod = $app['contract_period'] ?? '';
                    $contractPeriodValue = $app['contract_period_discount_value'] ?? '';
                    $contractPeriodUnit = $app['contract_period_discount_unit'] ?? '';
                    $discountPeriod = $app['discount_period'] ?? '';
                    $discountPeriodValue = $app['discount_period_value'] ?? '';
                    $discountPeriodUnit = $app['discount_period_unit'] ?? '';
                    $dataAmount = $app['data_amount'] ?? '';
                    $dataAmountValue = $app['data_amount_value'] ?? '';
                    $dataUnit = $app['data_unit'] ?? '';
                    $dataAdditional = $app['data_additional'] ?? '';
                    $dataAdditionalValue = $app['data_additional_value'] ?? '';
                    $dataExhausted = $app['data_exhausted'] ?? '';
                    $dataExhaustedValue = $app['data_exhausted_value'] ?? '';
                    $callType = $app['call_type'] ?? '';
                    $callAmount = $app['call_amount'] ?? '';
                    $callAmountUnit = $app['call_amount_unit'] ?? '遺?;
                    $smsType = $app['sms_type'] ?? '';
                    $smsAmount = $app['sms_amount'] ?? '';
                    $smsAmountUnit = $app['sms_amount_unit'] ?? '嫄?;
                    $serviceType = $app['service_type'] ?? '';
                    $promotions = $app['promotions'] ?? '';
                    $promotionTitle = $app['promotion_title'] ?? '';
                    $priceMainUnit = $app['price_main_unit'] ?? '??;
                    $priceAfterUnit = $app['price_after_unit'] ?? '??;
                    $planMaintenancePeriodType = $app['plan_maintenance_period_type'] ?? '';
                    $planMaintenancePeriodPrefix = $app['plan_maintenance_period_prefix'] ?? '';
                    $planMaintenancePeriodValue = $app['plan_maintenance_period_value'] ?? '';
                    $planMaintenancePeriodUnit = $app['plan_maintenance_period_unit'] ?? '';
                    $simChangeRestrictionPeriodType = $app['sim_change_restriction_period_type'] ?? '';
                    $simChangeRestrictionPeriodPrefix = $app['sim_change_restriction_period_prefix'] ?? '';
                    $simChangeRestrictionPeriodValue = $app['sim_change_restriction_period_value'] ?? '';
                    $simChangeRestrictionPeriodUnit = $app['sim_change_restriction_period_unit'] ?? '';
                }
                
                // ?쎌젙湲곌컙 ?щ㎎??                $contractPeriodFormatted = $contractPeriod;
                if (!empty($contractPeriodValue) && !empty($contractPeriodUnit)) {
                    $contractPeriodFormatted = $contractPeriod . ' ' . $contractPeriodValue . $contractPeriodUnit;
                }
                
                // ?좎씤湲곌컙(?꾨줈紐⑥뀡) ?щ㎎??                $discountPeriodFormatted = '';
                if ($discountPeriod === '?꾨줈紐⑥뀡 ?놁쓬' || empty($discountPeriod)) {
                    $discountPeriodFormatted = '';
                } elseif (!empty($discountPeriodValue) && !empty($discountPeriodUnit)) {
                    $discountPeriodFormatted = $discountPeriodValue . $discountPeriodUnit;
                } elseif (!empty($discountPeriod)) {
                    $discountPeriodFormatted = $discountPeriod;
                }
                
                // ?붽툑???좎?湲곌컙 ?щ㎎??                $planMaintenancePeriodFormatted = '';
                if ($planMaintenancePeriodType === '臾댁빟??) {
                    $planMaintenancePeriodFormatted = '臾댁빟??;
                } elseif ($planMaintenancePeriodType === '吏곸젒?낅젰') {
                    $prefix = $planMaintenancePeriodPrefix ?? '';
                    $value = $planMaintenancePeriodValue ?? null;
                    $unit = $planMaintenancePeriodUnit ?? '';
                    if (!empty($value) && !empty($unit)) {
                        $planMaintenancePeriodFormatted = $prefix . '+' . $value . $unit;
                    }
                }
                
                // ?좎떖湲곕? 遺덇?湲곌컙 ?щ㎎??                $simChangeRestrictionPeriodFormatted = '';
                if ($simChangeRestrictionPeriodType === '臾댁빟??) {
                    $simChangeRestrictionPeriodFormatted = '臾댁빟??;
                } elseif ($simChangeRestrictionPeriodType === '吏곸젒?낅젰') {
                    $prefix = $simChangeRestrictionPeriodPrefix ?? '';
                    $value = $simChangeRestrictionPeriodValue ?? null;
                    $unit = $simChangeRestrictionPeriodUnit ?? '';
                    if (!empty($value) && !empty($unit)) {
                        $simChangeRestrictionPeriodFormatted = $prefix . '+' . $value . $unit;
                    }
                }
                
                // ?곗씠???쒓났???щ㎎??                $dataMain = '';
                if (!empty($dataAmount)) {
                    if ($dataAmount === '臾댁젣??) {
                        $dataMain = '臾댁젣??;
                    } elseif ($dataAmount === '吏곸젒?낅젰' && !empty($dataAmountValue)) {
                        $dataMain = number_format((float)$dataAmountValue) . $dataUnit;
                    } else {
                        $dataMain = $dataAmount;
                    }
                    
                    if (!empty($dataAdditional) && $dataAdditional !== '?놁쓬') {
                        if ($dataAdditional === '吏곸젒?낅젰' && !empty($dataAdditionalValue)) {
                            $dataMain .= ' + ' . $dataAdditionalValue;
                        } else {
                            $dataMain .= ' + ' . $dataAdditional;
                        }
                    }
                    
                    if (!empty($dataExhausted) && $dataExhausted !== '吏곸젒?낅젰') {
                        $dataMain .= ' + ' . $dataExhausted;
                    } elseif (!empty($dataExhausted) && $dataExhausted === '吏곸젒?낅젰' && !empty($dataExhaustedValue)) {
                        $dataMain .= ' + ' . $dataExhaustedValue;
                    }
                }
                
                // ?쒕ぉ ?앹꽦: "KT | LTE | ?좏깮?쎌젙?좎씤 24媛쒖썡" ?뺤떇
                $title = $provider;
                if (!empty($serviceType)) {
                    $title .= ' | ' . $serviceType;
                }
                if (!empty($contractPeriodFormatted) && $contractPeriodFormatted !== $contractPeriod) {
                    $title .= ' | ' . $contractPeriodFormatted;
                }
                
                // 湲곕뒫 諛곗뿴 ?앹꽦
                $features = [];
                if (!empty($callType)) {
                    if ($callType === '臾댁젣??) {
                        $features[] = '?듯솕 臾댁젣??;
                    } elseif ($callType === '湲곕낯?쒓났') {
                        $features[] = '?듯솕 湲곕낯?쒓났';
                    } elseif ($callType === '吏곸젒?낅젰' && !empty($callAmount)) {
                        $callAmountUnit = $app['call_amount_unit'] ?? '遺?;
                        $features[] = '?듯솕 ' . number_format((float)$callAmount) . $callAmountUnit;
                    }
                }
                
                if (!empty($smsType)) {
                    if ($smsType === '臾댁젣??) {
                        $features[] = '臾몄옄 臾댁젣??;
                    } elseif ($smsType === '湲곕낯?쒓났') {
                        $features[] = '臾몄옄 湲곕낯?쒓났';
                    } elseif ($smsType === '吏곸젒?낅젰' && !empty($smsAmount)) {
                        $smsAmountUnit = $app['sms_amount_unit'] ?? '嫄?;
                        $features[] = '臾몄옄 ' . number_format((float)$smsAmount) . $smsAmountUnit;
                    }
                }
                
                if (!empty($provider)) {
                    $features[] = $provider;
                }
                
                if (!empty($serviceType)) {
                    $features[] = $serviceType;
                }
                
                // 媛寃??щ㎎??                $priceMainFormatted = '??' . number_format((int)$priceMain) . $priceMainUnit;
                
                $priceAfterFormatted = '';
                if ($priceAfterType === 'none' || $priceAfter === null) {
                    $priceAfterFormatted = '';
                } elseif ($priceAfterType === 'free' || $priceAfter == 0) {
                    $priceAfterFormatted = '臾대즺';
                } elseif (!empty($priceAfter)) {
                    $priceAfterFormatted = number_format((int)$priceAfter) . $priceAfterUnit;
                }
                
                // ?좎씤 ??媛寃⑹씠 ?덉쑝硫??쒖떆 ?뺤떇 議곗젙
                if ($priceAfterFormatted && $discountPeriodFormatted) {
                    $priceAfterFormatted = $discountPeriodFormatted . ' ?댄썑 ' . $priceAfterFormatted;
                }
                
                // ?꾨줈紐⑥뀡 ?뚯떛
                $gifts = [];
                if (!empty($promotions)) {
                    $promotionsArray = json_decode($promotions, true);
                    if (is_array($promotionsArray)) {
                        $gifts = array_filter($promotionsArray, function($p) {
                            return !empty(trim($p));
                        });
                    }
                }
                
                // 由щ럭 ?묒꽦 ?щ? ?뺤씤
                $hasReview = false;
                $rating = '';
                if (!empty($app['product_id'])) {
                    try {
                        $hasApplicationId = false;
                        try {
                            $checkStmt = $pdo->query("SHOW COLUMNS FROM product_reviews LIKE 'application_id'");
                            $hasApplicationId = $checkStmt->rowCount() > 0;
                        } catch (PDOException $e) {}
                        
                        if ($hasApplicationId && !empty($app['application_id'])) {
                            $reviewStmt = $pdo->prepare("
                                SELECT COUNT(*) as count
                                FROM product_reviews
                                WHERE application_id = :application_id 
                                AND user_id = :user_id 
                                AND product_type = 'mno-sim'
                                AND status = 'approved'
                            ");
                            $reviewStmt->execute([
                                ':application_id' => $app['application_id'],
                                ':user_id' => $userId
                            ]);
                        } else {
                            $reviewStmt = $pdo->prepare("
                                SELECT COUNT(*) as count
                                FROM product_reviews
                                WHERE product_id = :product_id 
                                AND user_id = :user_id 
                                AND product_type = 'mno-sim'
                                AND status = 'approved'
                            ");
                            $reviewStmt->execute([
                                ':product_id' => $app['product_id'],
                                ':user_id' => $userId
                            ]);
                        }
                        $reviewResult = $reviewStmt->fetch(PDO::FETCH_ASSOC);
                        $hasReview = ($reviewResult['count'] ?? 0) > 0;
                        
                        // ?됯퇏 蹂꾩젏 媛?몄삤湲?                        if (!function_exists('getProductAverageRating')) {
                            require_once __DIR__ . '/plan-data.php';
                        }
                        if (function_exists('getProductAverageRating')) {
                            $averageRating = getProductAverageRating($app['product_id'], 'mno-sim');
                            $rating = $averageRating > 0 ? number_format($averageRating, 1) : '';
                        }
                    } catch (Exception $e) {
                        error_log("Error fetching review info for mno-sim product {$app['product_id']}: " . $e->getMessage());
                    }
                }
                
                // ?곹깭 ?쒓? 蹂??                $statusKor = getApplicationStatusLabel($app['application_status'] ?? 'pending');
                
                $formattedApplications[] = [
                    'id' => (int)$app['product_id'],
                    'product_id' => (int)$app['product_id'],
                    'application_id' => (int)$app['application_id'],
                    'seller_id' => (int)($app['seller_id'] ?? 0),
                    'order_number' => $app['order_number'] ?? '',
                    'provider' => !empty($provider) ? $provider : '?????놁쓬',
                    'rating' => $rating,
                    'title' => !empty($title) ? $title : (!empty($planName) ? $planName : '?붽툑???뺣낫 ?놁쓬'),
                    'plan_name' => $planName,
                    'data_main' => !empty($dataMain) ? $dataMain : '?곗씠???뺣낫 ?놁쓬',
                    'features' => $features,
                    'price_main' => !empty($priceMainFormatted) ? $priceMainFormatted : '媛寃??뺣낫 ?놁쓬',
                    'price_after' => $priceAfterFormatted,
                    'contract_period' => $contractPeriodFormatted ?: $contractPeriod,
                    'discount_period' => $discountPeriodFormatted,
                    'plan_maintenance_period' => $planMaintenancePeriodFormatted,
                    'sim_change_restriction_period' => $simChangeRestrictionPeriodFormatted,
                    'gifts' => $gifts,
                    'gift_count' => count($gifts),
                    'promotion_title' => $promotionTitle,
                    'order_date' => !empty($app['order_date']) ? date('Y.m.d', strtotime($app['order_date'])) : date('Y.m.d'),
                    'activation_date' => '',
                    'has_review' => $hasReview,
                    'is_sold_out' => ($app['product_status'] ?? 'active') !== 'active',
                    'status' => $statusKor,
                    'application_status' => $app['application_status']
                ];
            } catch (Exception $e) {
                error_log("Error formatting mno-sim application: " . $e->getMessage());
                continue;
            }
        }
        
        return $formattedApplications;
    } catch (PDOException $e) {
        error_log("Error fetching user MNO-SIM applications: " . $e->getMessage());
        return [];
    } catch (Exception $e) {
        error_log("General error in getUserMnoSimApplications: " . $e->getMessage());
        return [];
    }
}

/**
 * 愿由ъ옄??- 紐⑤뱺 ?먮ℓ?먯쓽 ?뚮쑑???묒닔嫄?議고쉶
 * @param array $filters ?꾪꽣 議곌굔 (seller_id, status, date_from, date_to ??
 * @param int $page ?섏씠吏 踰덊샇
 * @param int $perPage ?섏씠吏????ぉ ?? * @return array ['applications' => [], 'total' => 0, 'totalPages' => 0]
 */
function getAllAdminMvnoApplications($filters = [], $page = 1, $perPage = 20) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
    
    try {
        // WHERE 議곌굔 援ъ꽦
        $whereConditions = ["a.product_type = 'mvno'"];
        $params = [];
        
        // ?먮ℓ???꾪꽣
        if (!empty($filters['seller_id'])) {
            $whereConditions[] = 'a.seller_id = :seller_id';
            $params[':seller_id'] = $filters['seller_id'];
        }
        
        // ?곹깭 ?꾪꽣 (?먮ℓ???섏씠吏? ?숈씪?섍쾶)
        if (!empty($filters['status'])) {
            if ($filters['status'] === 'received') {
                // 'received' ?꾪꽣留???鍮?臾몄옄?? null, 'pending'???ы븿
                $whereConditions[] = "(a.application_status = :status OR a.application_status = '' OR a.application_status IS NULL OR LOWER(TRIM(a.application_status)) = 'pending')";
                $params[':status'] = 'received';
            } else {
                $whereConditions[] = 'a.application_status = :status';
                $params[':status'] = $filters['status'];
            }
        }
        
        // ?좎쭨 ?꾪꽣
        if (!empty($filters['date_from'])) {
            $whereConditions[] = 'DATE(a.created_at) >= :date_from';
            $params[':date_from'] = $filters['date_from'];
        }
        if (!empty($filters['date_to'])) {
            $whereConditions[] = 'DATE(a.created_at) <= :date_to';
            $params[':date_to'] = $filters['date_to'];
        }
        
        // 怨좉컼?뺣낫 寃???꾪꽣 (怨좉컼紐? ?꾪솕踰덊샇, ?대찓?? ?뚯썝?꾩씠??
        if (!empty($filters['customer_search'])) {
            $whereConditions[] = '(c.name LIKE :customer_search OR c.phone LIKE :customer_search OR c.email LIKE :customer_search OR CAST(c.user_id AS CHAR) LIKE :customer_search)';
            $params[':customer_search'] = '%' . $filters['customer_search'] . '%';
        }
        
        // ?먮ℓ?먯젙蹂?寃???꾪꽣???섏쨷??PHP?먯꽌 泥섎━ (users ?뚯씠釉붿씠 ?놁쓣 ???덉쓬)
        // seller_search??荑쇰━ 寃곌낵瑜?媛?몄삩 ??PHP?먯꽌 ?꾪꽣留?        
        // 二쇰Ц踰덊샇 寃??        if (!empty($filters['order_number'])) {
            $whereConditions[] = 'a.order_number LIKE :order_number';
            $params[':order_number'] = '%' . $filters['order_number'] . '%';
        }
        
        $whereClause = implode(' AND ', $whereConditions);
        
        // COUNT 荑쇰━??JOIN 援ъ꽦 (DB-only: users??DB ?뚯씠釉붿씠誘濡??꾩슂 ??JOIN 媛??
        $countJoins = ["INNER JOIN application_customers c ON a.id = c.application_id"];
        
        // seller_search ?꾪꽣???섏쨷??PHP?먯꽌 泥섎━ (users ?뚯씠釉붿씠 ?놁쓣 ???덉쓬)
        
        // ?꾩껜 媛쒖닔 議고쉶
        $countSql = "
            SELECT COUNT(*) as total
            FROM product_applications a
            " . implode("\n            ", $countJoins) . "
            WHERE {$whereClause}
        ";
        
        // ?붾쾭源? 荑쇰━ ?뺣낫 濡쒓퉭
        error_log("MVNO COUNT 荑쇰━ ?붾쾭源?");
        error_log("WHERE ?? " . $whereClause);
        error_log("?뚮씪誘명꽣: " . json_encode($params));
        error_log("SQL: " . $countSql);
        
        try {
            $countStmt = $pdo->prepare($countSql);
            
            // ?뚮씪誘명꽣 諛붿씤??            foreach ($params as $key => $value) {
                $countStmt->bindValue($key, $value);
            }
            
            if (!$countStmt->execute()) {
                $errorInfo = $countStmt->errorInfo();
                error_log("MVNO COUNT 荑쇰━ ?ㅽ뻾 ?ㅽ뙣: " . json_encode($errorInfo));
                error_log("SQL: " . $countSql);
                error_log("Params: " . json_encode($params));
                throw new PDOException("COUNT 荑쇰━ ?ㅽ뻾 ?ㅽ뙣: " . ($errorInfo[2] ?? 'Unknown error'));
            }
            
            $countResult = $countStmt->fetch(PDO::FETCH_ASSOC);
            $total = $countResult ? (int)$countResult['total'] : 0;
            error_log("MVNO COUNT 荑쇰━ 寃곌낵: " . $total);
        } catch (PDOException $e) {
            error_log("MVNO COUNT 荑쇰━ ?덉쇅: " . $e->getMessage());
            error_log("SQL: " . $countSql);
            error_log("Params: " . json_encode($params));
            error_log("WHERE ?? " . $whereClause);
            
            // ?ㅻ쪟 諛쒖깮 ??媛꾨떒??COUNT 荑쇰━濡??泥??쒕룄
            try {
                $fallbackSql = "
                    SELECT COUNT(*) as total
                    FROM product_applications a
                    INNER JOIN application_customers c ON a.id = c.application_id
                    WHERE a.product_type = 'mvno'
                ";
                $fallbackStmt = $pdo->query($fallbackSql);
                $fallbackResult = $fallbackStmt->fetch(PDO::FETCH_ASSOC);
                $total = $fallbackResult ? (int)$fallbackResult['total'] : 0;
                error_log("MVNO COUNT ?泥?荑쇰━ 寃곌낵: " . $total);
            } catch (Exception $fallbackE) {
                error_log("MVNO COUNT ?泥?荑쇰━???ㅽ뙣: " . $fallbackE->getMessage());
                $total = 0;
            }
        }
        
        $totalPages = ceil($total / $perPage);
        
        // ?붾쾭源? COUNT 寃곌낵 ?뺤씤
        if ($total == 0) {
            error_log("MVNO ?묒닔嫄?COUNT 荑쇰━ 寃곌낵: " . $total);
            error_log("WHERE ?? " . $whereClause);
            error_log("?뚮씪誘명꽣: " . json_encode($params));
            error_log("SQL: " . $countSql);
            
            // 媛꾨떒??COUNT 荑쇰━濡?鍮꾧탳
            try {
                $simpleCountStmt = $pdo->query("
                    SELECT COUNT(*) as cnt 
                    FROM product_applications a
                    INNER JOIN application_customers c ON a.id = c.application_id
                    WHERE a.product_type = 'mvno'
                ");
                $simpleCount = $simpleCountStmt->fetch(PDO::FETCH_ASSOC);
                error_log("媛꾨떒??COUNT 寃곌낵: " . ($simpleCount['cnt'] ?? 0));
            } catch (Exception $e) {
                error_log("媛꾨떒??COUNT ?ㅻ쪟: " . $e->getMessage());
            }
        }
        
        // ?묒닔嫄?紐⑸줉 議고쉶
        $offset = ($page - 1) * $perPage;
        $applications = [];
        
        try {
            $selectSql = "
                SELECT 
                    a.id as application_id,
                    a.product_id,
                    a.seller_id,
                    a.order_number,
                    a.application_status,
                    a.created_at as order_date,
                    a.updated_at,
                    c.id as customer_id,
                    c.user_id as customer_user_id,
                    c.name as customer_name,
                    c.phone as customer_phone,
                    c.email as customer_email,
                    c.address,
                    c.address_detail,
                    c.birth_date,
                    c.gender,
                    c.additional_info,
                    mvno.plan_name,
                    mvno.provider,
                    mvno.contract_type,
                    mvno.price_main,
                    mvno.price_after,
                    mvno.discount_period,
                    mvno.data_amount,
                    mvno.data_amount_value,
                    mvno.data_unit,
                    mvno.data_additional,
                    mvno.data_additional_value,
                    mvno.data_exhausted,
                    mvno.data_exhausted_value,
                    mvno.call_type,
                    mvno.call_amount,
                    mvno.sms_type,
                    mvno.sms_amount,
                    mvno.service_type,
                    mvno.promotions,
                    p.status as product_status
                FROM product_applications a
                INNER JOIN application_customers c ON a.id = c.application_id
                LEFT JOIN products p ON a.product_id = p.id
                LEFT JOIN product_mvno_details mvno ON p.id = mvno.product_id
                WHERE {$whereClause}
                ORDER BY a.created_at DESC
                LIMIT :limit OFFSET :offset
            ";
            
            $stmt = $pdo->prepare($selectSql);
            
            foreach ($params as $key => $value) {
                $stmt->bindValue($key, $value);
            }
            $stmt->bindValue(':limit', $perPage, PDO::PARAM_INT);
            $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
            
            if (!$stmt->execute()) {
                $errorInfo = $stmt->errorInfo();
                error_log("MVNO SELECT 荑쇰━ ?ㅽ뻾 ?ㅽ뙣: " . json_encode($errorInfo));
                error_log("SQL: " . $selectSql);
                error_log("WHERE ?? " . $whereClause);
                error_log("Params: " . json_encode($params));
                throw new PDOException("SELECT 荑쇰━ ?ㅽ뻾 ?ㅽ뙣: " . ($errorInfo[2] ?? 'Unknown error'));
            }
            
            $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (PDOException $e) {
            error_log("MVNO SELECT 荑쇰━ ?덉쇅: " . $e->getMessage());
            error_log("WHERE ?? " . $whereClause);
            error_log("Params: " . json_encode($params));
            $applications = [];
        }
        
        // ?붾쾭源? 荑쇰━ 寃곌낵 濡쒓퉭
        if (empty($applications) && $total > 0) {
            error_log("MVNO ?묒닔嫄?議고쉶 ?ㅻ쪟: 珥?" . $total . "嫄댁씤??寃곌낵媛 ?놁쓬. WHERE 議곌굔: " . $whereClause);
            error_log("?뚮씪誘명꽣: " . json_encode($params));
        }
        
        // ?먮ℓ???뺣낫??DB(users)?먯꽌 議고쉶/議곗씤?섎룄濡??뺣━ ?꾩슂 (DB-only)
        require_once __DIR__ . '/plan-data.php';
        foreach ($applications as &$app) {
            $sellerId = $app['seller_id'] ?? null;
            if ($sellerId) {
                $seller = getSellerById($sellerId);
                if ($seller) {
                    $app['seller_user_id'] = $seller['user_id'] ?? $sellerId;
                    $app['seller_name'] = $seller['name'] ?? ($seller['company_name'] ?? '?먮ℓ???뺣낫 ?놁쓬');
                    $app['seller_company_name'] = $seller['company_name'] ?? '';
                } else {
                    $app['seller_user_id'] = $sellerId;
                    $app['seller_name'] = '?먮ℓ???뺣낫 ?놁쓬';
                    $app['seller_company_name'] = '';
                }
            }
        }
        unset($app);
        
        // seller_search ?꾪꽣媛 ?덉쑝硫?PHP?먯꽌 ?꾪꽣留?        if (!empty($filters['seller_search'])) {
            $searchTerm = strtolower($filters['seller_search']);
            $applications = array_filter($applications, function($app) use ($searchTerm) {
                $sellerId = strtolower($app['seller_user_id'] ?? '');
                $sellerName = strtolower($app['seller_name'] ?? '');
                $companyName = strtolower($app['seller_company_name'] ?? '');
                return strpos($sellerId, $searchTerm) !== false || 
                       strpos($sellerName, $searchTerm) !== false || 
                       strpos($companyName, $searchTerm) !== false;
            });
            $applications = array_values($applications);
            // ?꾪꽣留???total ?ш퀎??            $total = count($applications);
            $totalPages = ceil($total / $perPage);
        }
        
        return [
            'applications' => $applications,
            'total' => $total,
            'totalPages' => $totalPages
        ];
    } catch (PDOException $e) {
        error_log("Error fetching admin MVNO applications: " . $e->getMessage());
        error_log("SQL Error Info: " . json_encode($e->errorInfo ?? []));
        error_log("WHERE Clause: " . ($whereClause ?? 'N/A'));
        error_log("Params: " . json_encode($params ?? []));
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
}

/**
 * 愿由ъ옄??- 紐⑤뱺 ?먮ℓ?먯쓽 ?듭떊?ы룿 ?묒닔嫄?議고쉶
 */
function getAllAdminMnoApplications($filters = [], $page = 1, $perPage = 20) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
    
    try {
        $whereConditions = ["a.product_type = 'mno'"];
        $params = [];
        
        if (!empty($filters['seller_id'])) {
            $whereConditions[] = 'a.seller_id = :seller_id';
            $params[':seller_id'] = $filters['seller_id'];
        }
        // ?곹깭 ?꾪꽣 (?먮ℓ???섏씠吏? ?숈씪?섍쾶)
        if (!empty($filters['status'])) {
            if ($filters['status'] === 'received') {
                // 'received' ?꾪꽣留???鍮?臾몄옄?? null, 'pending'???ы븿
                $whereConditions[] = "(a.application_status = :status OR a.application_status = '' OR a.application_status IS NULL OR LOWER(TRIM(a.application_status)) = 'pending')";
                $params[':status'] = 'received';
            } else {
                $whereConditions[] = 'a.application_status = :status';
                $params[':status'] = $filters['status'];
            }
        }
        if (!empty($filters['date_from'])) {
            $whereConditions[] = 'DATE(a.created_at) >= :date_from';
            $params[':date_from'] = $filters['date_from'];
        }
        if (!empty($filters['date_to'])) {
            $whereConditions[] = 'DATE(a.created_at) <= :date_to';
            $params[':date_to'] = $filters['date_to'];
        }
        // 怨좉컼?뺣낫 寃???꾪꽣
        if (!empty($filters['customer_search'])) {
            $whereConditions[] = '(c.name LIKE :customer_search OR c.phone LIKE :customer_search OR c.email LIKE :customer_search OR CAST(c.user_id AS CHAR) LIKE :customer_search)';
            $params[':customer_search'] = '%' . $filters['customer_search'] . '%';
        }
        
        // ?먮ℓ?먯젙蹂?寃???꾪꽣
        if (!empty($filters['seller_search'])) {
            $whereConditions[] = '(CAST(u.user_id AS CHAR) LIKE :seller_search OR u.name LIKE :seller_search OR u.company_name LIKE :seller_search)';
            $params[':seller_search'] = '%' . $filters['seller_search'] . '%';
        }
        
        // 二쇰Ц踰덊샇 寃??        if (!empty($filters['order_number'])) {
            $whereConditions[] = 'a.order_number LIKE :order_number';
            $params[':order_number'] = '%' . $filters['order_number'] . '%';
        }
        
        $whereClause = implode(' AND ', $whereConditions);
        
        $countStmt = $pdo->prepare("
            SELECT COUNT(*) as total
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            LEFT JOIN users u ON a.seller_id = u.user_id
            WHERE {$whereClause}
        ");
        $countStmt->execute($params);
        $total = $countStmt->fetch()['total'];
        $totalPages = ceil($total / $perPage);
        
        $offset = ($page - 1) * $perPage;
        $stmt = $pdo->prepare("
            SELECT 
                a.id as application_id,
                a.product_id,
                a.seller_id,
                a.order_number,
                a.application_status,
                a.created_at as order_date,
                a.updated_at,
                c.id as customer_id,
                c.user_id as customer_user_id,
                c.name as customer_name,
                c.phone as customer_phone,
                c.email as customer_email,
                c.address,
                c.address_detail,
                c.birth_date,
                c.gender,
                c.additional_info,
                mno.device_name,
                mno.device_model,
                mno.device_capacity,
                mno.device_colors,
                mno.delivery_method,
                mno.device_price,
                mno.contract_period,
                mno.contract_period_days,
                mno.discount_amount,
                mno.discount_type,
                mno.contract_type,
                mno.contract_provider,
                p.status as product_status,
                u.user_id as seller_user_id,
                u.name as seller_name,
                u.company_name as seller_company_name
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            LEFT JOIN products p ON a.product_id = p.id
            LEFT JOIN product_mno_details mno ON p.id = mno.product_id
            LEFT JOIN users u ON a.seller_id = u.user_id
            WHERE {$whereClause}
            ORDER BY a.created_at DESC
            LIMIT :limit OFFSET :offset
        ");
        
        foreach ($params as $key => $value) {
            $stmt->bindValue($key, $value);
        }
        $stmt->bindValue(':limit', $perPage, PDO::PARAM_INT);
        $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
        $stmt->execute();
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        return [
            'applications' => $applications,
            'total' => $total,
            'totalPages' => $totalPages
        ];
    } catch (PDOException $e) {
        error_log("Error fetching admin MNO applications: " . $e->getMessage());
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
}

/**
 * 愿由ъ옄??- 紐⑤뱺 ?먮ℓ?먯쓽 ?명꽣???묒닔嫄?議고쉶
 */
function getAllAdminInternetApplications($filters = [], $page = 1, $perPage = 20) {
    $pdo = getDBConnection();
    if (!$pdo) {
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
    
    try {
        $whereConditions = ["a.product_type = 'internet'"];
        $params = [];
        
        if (!empty($filters['seller_id'])) {
            $whereConditions[] = 'a.seller_id = :seller_id';
            $params[':seller_id'] = $filters['seller_id'];
        }
        // ?곹깭 ?꾪꽣 (?먮ℓ???섏씠吏? ?숈씪?섍쾶)
        if (!empty($filters['status'])) {
            if ($filters['status'] === 'received') {
                // 'received' ?꾪꽣留???鍮?臾몄옄?? null, 'pending'???ы븿
                $whereConditions[] = "(a.application_status = :status OR a.application_status = '' OR a.application_status IS NULL OR LOWER(TRIM(a.application_status)) = 'pending')";
                $params[':status'] = 'received';
            } else {
                $whereConditions[] = 'a.application_status = :status';
                $params[':status'] = $filters['status'];
            }
        }
        if (!empty($filters['date_from'])) {
            $whereConditions[] = 'DATE(a.created_at) >= :date_from';
            $params[':date_from'] = $filters['date_from'];
        }
        if (!empty($filters['date_to'])) {
            $whereConditions[] = 'DATE(a.created_at) <= :date_to';
            $params[':date_to'] = $filters['date_to'];
        }
        // 怨좉컼?뺣낫 寃???꾪꽣
        if (!empty($filters['customer_search'])) {
            $whereConditions[] = '(c.name LIKE :customer_search OR c.phone LIKE :customer_search OR c.email LIKE :customer_search OR CAST(c.user_id AS CHAR) LIKE :customer_search)';
            $params[':customer_search'] = '%' . $filters['customer_search'] . '%';
        }
        
        // ?먮ℓ?먯젙蹂?寃???꾪꽣
        if (!empty($filters['seller_search'])) {
            $whereConditions[] = '(CAST(u.user_id AS CHAR) LIKE :seller_search OR u.name LIKE :seller_search OR u.company_name LIKE :seller_search)';
            $params[':seller_search'] = '%' . $filters['seller_search'] . '%';
        }
        
        // 二쇰Ц踰덊샇 寃??        if (!empty($filters['order_number'])) {
            $whereConditions[] = 'a.order_number LIKE :order_number';
            $params[':order_number'] = '%' . $filters['order_number'] . '%';
        }
        
        $whereClause = implode(' AND ', $whereConditions);
        
        $countStmt = $pdo->prepare("
            SELECT COUNT(*) as total
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            LEFT JOIN products p ON a.product_id = p.id
            LEFT JOIN users u ON a.seller_id = u.user_id
            WHERE {$whereClause}
        ");
        $countStmt->execute($params);
        $total = $countStmt->fetch()['total'];
        $totalPages = ceil($total / $perPage);
        
        $offset = ($page - 1) * $perPage;
        $stmt = $pdo->prepare("
            SELECT 
                a.id as application_id,
                a.product_id,
                a.seller_id,
                a.order_number,
                a.application_status,
                a.created_at as order_date,
                a.updated_at,
                c.id as customer_id,
                c.user_id as customer_user_id,
                c.name as customer_name,
                c.phone as customer_phone,
                c.email as customer_email,
                c.address,
                c.address_detail,
                c.birth_date,
                c.gender,
                c.additional_info,
                internet.service_name,
                internet.service_type,
                internet.speed,
                internet.price,
                internet.contract_period,
                internet.contract_period_days,
                internet.installation_fee,
                internet.promotions,
                internet.existing_line,
                p.status as product_status,
                u.user_id as seller_user_id,
                u.name as seller_name,
                u.company_name as seller_company_name
            FROM product_applications a
            INNER JOIN application_customers c ON a.id = c.application_id
            LEFT JOIN products p ON a.product_id = p.id
            LEFT JOIN product_internet_details internet ON p.id = internet.product_id
            LEFT JOIN users u ON a.seller_id = u.user_id
            WHERE {$whereClause}
            ORDER BY a.created_at DESC
            LIMIT :limit OFFSET :offset
        ");
        
        foreach ($params as $key => $value) {
            $stmt->bindValue($key, $value);
        }
        $stmt->bindValue(':limit', $perPage, PDO::PARAM_INT);
        $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
        $stmt->execute();
        $applications = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        return [
            'applications' => $applications,
            'total' => $total,
            'totalPages' => $totalPages
        ];
    } catch (PDOException $e) {
        error_log("Error fetching admin Internet applications: " . $e->getMessage());
        return ['applications' => [], 'total' => 0, 'totalPages' => 0];
    }
}

